<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>QR Code • Listar Temas</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Ícones -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --bg:#f7f8fb;
      --card:#ffffff;
      --line:#e9edf3;
      --ink:#0f172a;
      --muted:#6b7280;
      --primary:#0b3b78;
      --accent:#2563eb;
      --radius:14px;
    }

    body{
      overflow: hidden;              /* <- remove a barra de rolagem externa */
      background:var(--bg);
      font-family:system-ui, Arial;
      padding:24px;
      color: var(--ink);
    }

    header.topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:var(--primary); color:#fff;
      display:flex; align-items:center; z-index:10;
      padding:0 24px;
      box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    header.topbar .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
    header.topbar h5{
      margin:0; font-weight:600;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:1.05rem;
    }
    header.topbar .right-actions{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
    }
    .btn-ghost{
      border-radius:999px;
      background: rgba(255,255,255,.15);
      box-shadow:none;
    }
    .btn-ghost:hover{ background: rgba(255,255,255,.22); }

    .wrap{
      width: min(1800px, calc(100vw - 32px));
      margin:96px auto 0;
      height: calc(100vh - 96px);    /* <- “encaixa” no resto da tela */
      display:flex;
      flex-direction: column;
    }
    @media (min-width: 1600px){
      .wrap{ width: min(2200px, calc(100vw - 48px)); }
    }

    /* card vira coluna e a tabela ganha o espaço */
    .panel-card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      border:1px solid var(--line);
      overflow: hidden;
      display:flex;
      flex-direction: column;
      flex: 1 1 auto;                /* <- ocupa tudo dentro do wrap */
    }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:var(--primary);
      font-weight:700;
      font-size:.85rem;
      white-space: nowrap;
    }

    .toolbar{
      padding:14px 14px 6px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
    }

    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }

    .field{ min-width: 220px; }

    /* Materialize input (compacto e alinhado) */
    .input-field{ margin:0; }
    .input-field input{
      height: 2.4rem !important;
    }
    .input-field label{
      transform: translateY(-6px) scale(.92);
      transform-origin: 0 0;
    }

    .btn-primary{
      border-radius:999px;
      background: linear-gradient(135deg, var(--accent), #1d4ed8);
      box-shadow:0 10px 22px rgba(37,99,235,.18);
      font-weight:800;
    }
    .btn-soft{
      border-radius:999px;
      background:#eef2ff;
      color:var(--primary);
      box-shadow:none;
      font-weight:800;
    }

    /* ===== TABLE ===== */
    /* tabela: só ela rola */
    .table-wrap{
      padding: 0 14px 14px;
      overflow: hidden;              /* <- sem scroll aqui */
      flex: 1 1 auto;
    }

    /* container de rolagem vertical + header fixo */
    .table-scroll{
      height: 100%;                  /* <- ocupa o resto do card */
      overflow-y: auto;              /* <- scroll único */
      overflow-x: hidden;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: #fff;
    }

    table.striped{
      width:100%;
      table-layout: fixed;
      margin:0;
    }

    table.striped>thead>tr>th{
      position: sticky;   /* fixa header */
      top: 0;
      z-index: 2;
      background: #f3f6fb;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:#0f172a;
      font-weight:900;
      font-size:.82rem;
      border-bottom: 1px solid var(--line);
    }

    table.striped>tbody>tr>td{
      vertical-align: top;
      font-size: .92rem;
      color:#111827;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
      border-bottom: 1px solid #f1f5f9;
    }

    /* hover suave na linha */
    table.striped>tbody>tr{
      transition: background .12s ease;
    }
    table.striped>tbody>tr:hover{
      background: #f6f8ff;
    }

    /* TEMA1 em destaque */
    td:nth-child(8){
      font-weight: 600;
      color:#0f172a;
    }

    /* ===== Larguras (SEM ID) =====
       1 codigo
       2 identred
       3 segmento
       4 curso
       5 serie
       6 caderno
       7 tipoprova
       8 tema1
       9 tema2
       10 tema3
       11 dt_registro
    */
    th:nth-child(1),  td:nth-child(1)  { width: 90px; }   /* CÓDIGO */
    th:nth-child(2),  td:nth-child(2)  { width: 110px; }  /* IDENTRED */
    th:nth-child(3),  td:nth-child(3)  { width: 110px; }  /* SEGMENTO */
    th:nth-child(4),  td:nth-child(4)  { width: 130px; }  /* CURSO */
    th:nth-child(5),  td:nth-child(5)  { width: 70px; }   /* SÉRIE */
    th:nth-child(6),  td:nth-child(6)  { width: 230px; }  /* CADERNO */
    th:nth-child(7),  td:nth-child(7)  { width: 110px; }  /* TIPOPROVA */
    th:nth-child(11), td:nth-child(11) { width: 170px; }  /* DT_REGISTRO */

    th:nth-child(8),  td:nth-child(8),
    th:nth-child(9),  td:nth-child(9),
    th:nth-child(10), td:nth-child(10){
      width: calc((100% - (90px + 110px + 110px + 130px + 70px + 230px + 110px + 170px)) / 3);
    }

    td:nth-child(1),
    td:nth-child(2),
    td:nth-child(3),
    td:nth-child(4),
    td:nth-child(5),
    td:nth-child(7),
    td:nth-child(11){
      white-space: nowrap;
    }

    .muted{ color: var(--muted); font-size:.92rem; }

    .footer{
      text-align:center;
      color:var(--muted);
      font-size:.9rem;
      padding:8px 0 18px;
    }

    /* mobile: deixa o body rolar normalmente (scroll único externo) */
    @media (max-width: 600px){
      body{ overflow:auto; }
      .wrap{
        height:auto;
        display:block;
      }
      .panel-card{ display:block; }
      .table-wrap{ overflow-x:auto; }
      .table-scroll{
        height:auto;
        max-height:none;
        overflow: visible;
        border: 0;
      }
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="brand">
      <img src="/optativos/logo-mini.png" alt="Logo" style="height:28px;">
      <h5>QR Code • Listar Temas</h5>
    </div>

    <div class="right-actions">
      <a class="btn btn-small btn-ghost white-text" href="./painel.html">
        <i class="material-icons left">grid_view</i>Painel
      </a>
      <a class="btn btn-small btn-ghost white-text" href="./temas_cadastro.html">
        <i class="material-icons left">add</i>Novo
      </a>
    </div>
  </header>

  <div class="wrap">

    <div class="panel-card">
      <!-- cabeçalho do card -->
      <div style="padding:14px 14px; display:flex; align-items:flex-start; gap:12px; justify-content:space-between; flex-wrap:wrap;">
        <div style="display:flex; gap:10px; align-items:flex-start;">
          <i class="material-icons" style="color:var(--primary); margin-top:2px;">view_list</i>
          <div>
            <div style="font-weight:900; color:#111827;">Registros cadastrados</div>
            <div class="muted">Listagem do mais recente para o mais antigo (dt_registro desc).</div>
          </div>
        </div>

        <div>
          <span class="pill" id="pillCount"><i class="material-icons" style="font-size:18px;">dns</i> 0 registro(s)</span>
        </div>
      </div>

      <!-- toolbar -->
      <div class="toolbar">
        <div class="filters">
          <div class="input-field field">
            <input id="q" type="text" placeholder="Buscar (tema, caderno, curso, etc)">
            <label for="q">Busca</label>
          </div>

          <div class="input-field field" style="min-width:140px;">
            <input id="codigo" type="text" placeholder="Ex: 123">
            <label for="codigo">Código</label>
          </div>

          <div class="input-field field" style="min-width:120px;">
            <input id="limit" type="number" min="1" max="2000" value="500">
            <label for="limit">Limite</label>
          </div>

          <button class="btn btn-primary" id="btnBuscar">
            <i class="material-icons left">search</i>Pesquisar
          </button>

          <button class="btn btn-soft" id="btnLimpar">
            <i class="material-icons left">refresh</i>Limpar
          </button>
        </div>

        <div class="muted" id="status">—</div>
      </div>

      <!-- tabela -->
      <div class="table-wrap">
        <div class="table-scroll">
          <table class="striped">
            <thead>
              <tr>
                <th>CÓDIGO</th>
                <th>IDENTRED</th>
                <th>SEGMENTO</th>
                <th>CURSO</th>
                <th>SÉRIE</th>
                <th>CADERNO</th>
                <th>TIPOPROVA</th>
                <th>TEMA1</th>
                <th>TEMA2</th>
                <th>TEMA3</th>
                <th>DT_REGISTRO</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="11" class="muted">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">QR Code • Redação • 3A Sistemas</div>
  </div>

  <script>
    const API_URL = 'https://apisec.secauxiliar.com.br/qrcode/redacao_temas_list.php';

    const el = (id) => document.getElementById(id);

    function esc(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function fmtDT(dt){
      if(!dt) return '';
      // aceita "YYYY-MM-DD HH:MM:SS" e mostra igual
      return String(dt).replace('T',' ').replace('.000','');
    }

    async function carregar(){
      const q = (el('q').value || '').trim();
      const codigo = (el('codigo').value || '').trim();
      const limit = Math.max(1, Math.min(2000, parseInt(el('limit').value || '500', 10)));

      el('status').textContent = 'Carregando...';

      const tbody = el('tbody');
      tbody.innerHTML = `<tr><td colspan="11" class="muted">Carregando...</td></tr>`;

      try{
        const url = new URL(API_URL);
        if(q) url.searchParams.set('q', q);
        if(codigo) url.searchParams.set('codigo', codigo);
        url.searchParams.set('limit', String(limit));

        const resp = await fetch(url.toString(), { cache:'no-store' });
        const j = await resp.json();

        if(!resp.ok || !j.ok) throw new Error(j.msg || 'Falha ao listar');

        const rows = j.rows || [];
        el('pillCount').innerHTML = `<i class="material-icons" style="font-size:18px;">dns</i> ${rows.length} registro(s)`;
        el('status').textContent = `OK • ${rows.length} registro(s) carregado(s).`;

        if(rows.length === 0){
          tbody.innerHTML = `<tr><td colspan="11" class="muted">Nenhum registro encontrado.</td></tr>`;
          return;
        }

        tbody.innerHTML = rows.map(r => `
          <tr>
            <td><strong>${esc(r.codigo)}</strong></td>
            <td>${esc(r.identred)}</td>
            <td>${esc(r.segmento)}</td>
            <td>${esc(r.curso)}</td>
            <td>${esc(r.serie)}</td>
            <td>${esc(r.caderno)}</td>
            <td>${esc(r.tipoprova)}</td>
            <td>${esc(r.tema1)}</td>
            <td>${esc(r.tema2)}</td>
            <td>${esc(r.tema3)}</td>
            <td>${esc(fmtDT(r.dt_registro))}</td>
          </tr>
        `).join('');

      }catch(e){
        el('status').textContent = 'Erro ao carregar.';
        tbody.innerHTML = `<tr><td colspan="11" class="muted">Erro: ${esc(e.message || String(e))}</td></tr>`;
      }
    }

    function limpar(){
      el('q').value = '';
      el('codigo').value = '';
      el('limit').value = '500';
      M.updateTextFields();
      carregar();
    }

    document.addEventListener('DOMContentLoaded', function(){
      // materialize labels ok
      M.updateTextFields();

      el('btnBuscar').addEventListener('click', carregar);
      el('btnLimpar').addEventListener('click', limpar);

      el('q').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); carregar(); } });
      el('codigo').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); carregar(); } });

      carregar();
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>