<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>QR Code • Listar Temas</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Ícones -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
:root {
  --bg:#f7f8fb;
  --card:#ffffff;
  --line:#e9edf3;
  --ink:#0f172a;
  --muted:#6b7280;
  --primary:#0b3b78;
  --accent:#2563eb;
  --radius:14px;
}

body{
  overflow: hidden;
  background:var(--bg);
  font-family:system-ui, Arial;
  padding:24px;
  color: var(--ink);
}

header.topbar{
  position:fixed; top:0; left:0; right:0; height:64px;
  background:var(--primary); color:#fff;
  display:flex; align-items:center; z-index:10;
  padding:0 24px;
  box-shadow:0 2px 10px rgba(16,24,40,.12);
}
header.topbar .brand{ display:flex; align-items:center; gap:12px; min-width:0; }
header.topbar h5{
  margin:0; font-weight:600;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  font-size:1.05rem;
}
header.topbar .right-actions{
  margin-left:auto;
  display:flex; align-items:center; gap:10px;
}
.btn-ghost{
  border-radius:999px;
  background: rgba(255,255,255,.15);
  box-shadow:none;
}
.btn-ghost:hover{ background: rgba(255,255,255,.22); }

.wrap{
  width: min(1800px, calc(100vw - 32px));
  margin:96px auto 0;
  height: calc(100vh - 96px);
  display:flex;
  flex-direction: column;
}
@media (min-width: 1600px){
  .wrap{ width: min(2200px, calc(100vw - 48px)); }
}

.panel-card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:0 10px 30px rgba(0,0,0,.06);
  border:1px solid var(--line);
  overflow: hidden;
  display:flex;
  flex-direction: column;
  flex: 1 1 auto;
}

.pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px;
  border-radius:999px;
  background:#eef2ff;
  color:var(--primary);
  font-weight:700;
  font-size:.85rem;
  white-space: nowrap;
}

.toolbar{
  padding:14px 14px 6px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:flex-end;
  justify-content:space-between;
}

.filters{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:flex-end;
}

.field{ min-width: 220px; }

.input-field{ margin:0; }
.input-field input{
  height: 2.4rem !important;
}

/* ✅ regra do topo (toolbar) SEM afetar o modal */
.wrap .toolbar .input-field label{
  transform: translateY(-6px) scale(.92);
  transform-origin: 0 0;
}

.btn-primary{
  border-radius:999px;
  background: linear-gradient(135deg, var(--accent), #1d4ed8);
  box-shadow:0 10px 22px rgba(37,99,235,.18);
  font-weight:800;
}
.btn-soft{
  border-radius:999px;
  background:#eef2ff;
  color:var(--primary);
  box-shadow:none;
  font-weight:800;
}

/* ===== TABLE ===== */
.table-wrap{
  padding: 0 14px 14px;
  overflow: hidden;
  flex: 1 1 auto;
}

.table-scroll{
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  border-radius: 12px;
  border: 1px solid var(--line);
  background: #fff;
}

table.striped{
  width:100%;
  table-layout: fixed;
  margin:0;
}

table.striped>thead>tr>th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: #f3f6fb;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  color:#0f172a;
  font-weight:900;
  font-size:.82rem;
  border-bottom: 1px solid var(--line);
}

table.striped>tbody>tr>td{
  vertical-align: top;
  font-size: .92rem;
  color:#111827;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  border-bottom: 1px solid #f1f5f9;
}

table.striped>tbody>tr{
  transition: background .12s ease;
}
table.striped>tbody>tr:hover{
  background: #f6f8ff;
}

td:nth-child(9){
  font-weight: 600;
  color:#0f172a;
}

th:nth-child(1),  td:nth-child(1)  { width: 64px; }
th:nth-child(2),  td:nth-child(2)  { width: 90px; }
th:nth-child(3),  td:nth-child(3)  { width: 110px; }
th:nth-child(4),  td:nth-child(4)  { width: 110px; }
th:nth-child(5),  td:nth-child(5)  { width: 130px; }
th:nth-child(6),  td:nth-child(6)  { width: 70px; }
th:nth-child(7),  td:nth-child(7)  { width: 230px; }
th:nth-child(8),  td:nth-child(8)  { width: 110px; }
th:nth-child(12), td:nth-child(12) { width: 170px; }

th:nth-child(9),  td:nth-child(9),
th:nth-child(10), td:nth-child(10),
th:nth-child(11), td:nth-child(11){
  width: calc((100% - (64px + 90px + 110px + 110px + 130px + 70px + 230px + 110px + 170px)) / 3);
}

td:nth-child(1),
td:nth-child(2),
td:nth-child(3),
td:nth-child(4),
td:nth-child(5),
td:nth-child(6),
td:nth-child(8),
td:nth-child(12){
  white-space: nowrap;
}

.btn-edit{
  border-radius: 10px;
  padding: 0 8px;
  height: 32px;
  line-height: 32px;
  box-shadow:none;
  background:#eef2ff;
  color: var(--primary);
}
.btn-edit:hover{
  background:#e0e7ff;
}
.btn-edit i{ font-size: 18px; line-height: 32px; }

.muted{ color: var(--muted); font-size:.92rem; }

.footer{
  text-align:center;
  color:var(--muted);
  font-size:.9rem;
  padding:8px 0 18px;
}

/* =========================================
   MODAL EDITAR
   ========================================= */

#modalEditar.modal{
  width: min(1100px, 92vw) !important;
  height: 88vh !important;
  max-height: 88vh !important;
  border-radius: 18px;
  overflow: hidden;
}

/* layout interno */
#modalEditar.modal .modal-content{
  padding: 16px 18px 0;
  height: calc(88vh - 68px); /* reserva footer */
  overflow: hidden;
}

/* header do modal */
#modalEditar .modal-head{
  position: sticky;
  top: 0;
  z-index: 3;
  background: #fff;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--line);
  margin-bottom: 12px;
}

#modalEditar .modal-title{
  display:flex;
  align-items:center;
  gap:10px;
  margin: 0;
  font-weight: 900;
  color: #0f172a;
}
#modalEditar .modal-title i{ color: var(--primary); }

#modalEditar .modal-sub{
  margin: 2px 0 0;
  color: var(--muted);
  font-size: .92rem;
}

/* área rolável do modal */
#modalEditar .modal-body{
  height: calc(88vh - 68px - 74px);
  overflow: auto;
  padding-right: 6px;
}

/* footer fixo */
#modalEditar.modal .modal-footer{
  height: 68px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  padding: 10px 16px;
  border-top: 1px solid var(--line);
  background: #fafbff;
}

#modalEditar .input-field{
  margin-top: 12px;
  margin-bottom: 10px;
}
#modalEditar .input-field > label{
  font-size: .82rem;
  color: var(--muted);
}

/* select do Materialize no modal */
#modalEditar .select-wrapper input.select-dropdown{
  height: 2.7rem;
  line-height: 2.7rem;
  margin: 0 0 6px;
}

/* inputs texto */
#modalEditar input[type="text"]{
  font-size: .95rem;
}

/* botão excluir */
#modalEditar .btn-danger{
  border-radius: 999px;
  background: #fee2e2;
  color: #991b1b;
  font-weight: 900;
  box-shadow: none;
}
#modalEditar .btn-danger:hover{ background:#fecaca; }

/* scrollbar (opcional) */
#modalEditar .modal-body::-webkit-scrollbar{ width: 10px; }
#modalEditar .modal-body::-webkit-scrollbar-thumb{
  background: #dbe4f3;
  border-radius: 999px;
  border: 2px solid #fff;
}
#modalEditar .modal-body::-webkit-scrollbar-thumb:hover{ background:#cbd7ee; }

@media (max-width: 700px){
  #modalEditar.modal{
    width: 96vw !important;
    height: 92vh !important;
    max-height: 92vh !important;
  }
  #modalEditar.modal .modal-content{
    height: calc(92vh - 68px);
  }
  #modalEditar .modal-body{
    height: calc(92vh - 68px - 74px);
  }
}

/* mobile geral */
@media (max-width: 600px){
  body{ overflow:auto; }
  .wrap{
    height:auto;
    display:block;
  }
  .panel-card{ display:block; }
  .table-wrap{ overflow-x:auto; }
  .table-scroll{
    height:auto;
    max-height:none;
    overflow: visible;
    border: 0;
  }
}
  </style>
</head>

<body>

  <header class="topbar">
    <div class="brand">
      <img src="/optativos/logo-mini.png" alt="Logo" style="height:28px;">
      <h5>QR Code • Listar Temas</h5>
    </div>

    <div class="right-actions">
      <a class="btn btn-small btn-ghost white-text" href="./painel.html">
        <i class="material-icons left">grid_view</i>Painel
      </a>
      <a class="btn btn-small btn-ghost white-text" href="./temas_cadastro.html">
        <i class="material-icons left">add</i>Novo
      </a>
    </div>
  </header>

  <div class="wrap">

    <div class="panel-card">
      <!-- cabeçalho do card -->
      <div style="padding:14px 14px; display:flex; align-items:flex-start; gap:12px; justify-content:space-between; flex-wrap:wrap;">
        <div style="display:flex; gap:10px; align-items:flex-start;">
          <i class="material-icons" style="color:var(--primary); margin-top:2px;">view_list</i>
          <div>
            <div style="font-weight:900; color:#111827;">Registros cadastrados</div>
            <div class="muted">Listagem do mais recente para o mais antigo (dt_registro desc).</div>
          </div>
        </div>

        <div>
          <span class="pill" id="pillCount"><i class="material-icons" style="font-size:18px;">dns</i> 0 registro(s)</span>
        </div>
      </div>

      <!-- toolbar -->
      <div class="toolbar">
        <div class="filters">
          <div class="input-field field">
            <input id="q" type="text" placeholder="Buscar (tema, caderno, curso, etc)">
            <label for="q">Busca</label>
          </div>

          <div class="input-field field" style="min-width:140px;">
            <input id="codigo" type="text" placeholder="Ex: 123">
            <label for="codigo">Código</label>
          </div>

          <div class="input-field field" style="min-width:120px;">
            <input id="limit" type="number" min="1" max="2000" value="500">
            <label for="limit">Limite</label>
          </div>

          <button class="btn btn-primary" id="btnBuscar">
            <i class="material-icons left">search</i>Pesquisar
          </button>

          <button class="btn btn-soft" id="btnLimpar">
            <i class="material-icons left">refresh</i>Limpar
          </button>
        </div>

        <div class="muted" id="status">—</div>
      </div>

      <!-- tabela -->
      <div class="table-wrap">
        <div class="table-scroll">
          <table class="striped">
            <thead>
              <tr>
                <th class="center">AÇÕES</th>
                <th>CÓDIGO</th>
                <th>IDENTRED</th>
                <th>SEGMENTO</th>
                <th>CURSO</th>
                <th>SÉRIE</th>
                <th>CADERNO</th>
                <th>TIPOPROVA</th>
                <th>TEMA1</th>
                <th>TEMA2</th>
                <th>TEMA3</th>
                <th>DT_REGISTRO</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="12" class="muted">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="footer">QR Code • Redação • 3A Sistemas</div>
  </div>

  <!-- ===== MODAL EDITAR ===== -->
  <div id="modalEditar" class="modal">
    <div class="modal-content">

      <div class="modal-head">
        <h6 class="modal-title">
          <i class="material-icons">edit</i>
          Editar Tema
        </h6>
        <div class="modal-sub">
          Código: <strong id="editCodigoLabel">—</strong>
        </div>
      </div>

      <input type="hidden" id="editCodigo" />

      <div class="modal-body">
        <div class="row" style="margin-bottom:0;">

          <div class="col s12 m6">
            <div class="input-field">
              <select id="editIdentred" required>
                <option value="" disabled>Selecione</option>
                <option value="SIMULADO">SIMULADO</option>
                <option value="FOLHETO">FOLHETO</option>
                <option value="CADERNO">CADERNO</option>
              </select>
              <label for="editIdentred">Identificação do Material</label>
            </div>
          </div>

          <div class="col s12 m6">
            <div class="input-field">
              <select id="editSegmento" required onchange="atualizarCamposSegmentoEdit()">
                <option value="" disabled>Selecione</option>
                <option value="CURSO">CURSO</option>
                <option value="COLÉGIO">COLÉGIO</option>
              </select>
              <label for="editSegmento">Segmento</label>
            </div>
          </div>

          <div class="col s12 m6">
            <div class="input-field">
              <select id="editCurso" disabled>
                <option value="" disabled>Selecione</option>
                <option value="EXTENSIVO">EXTENSIVO</option>
                <option value="TURMAS DE MAIO">TURMAS DE MAIO</option>
                <option value="SEMI DE AGOSTO">SEMI DE AGOSTO</option>
                <option value="INTENSIVO">INTENSIVO</option>
                <option value="REDAÇÃO">REDAÇÃO</option>
              </select>
              <label for="editCurso">Curso</label>
            </div>
          </div>

          <div class="col s12 m6">
            <div class="input-field">
              <select id="editSerie" disabled>
                <option value="" disabled>Selecione</option>
                <option value="1">1ª</option>
                <option value="2">2ª</option>
                <option value="3">3ª</option>
                <option value="4">4ª</option>
              </select>
              <label for="editSerie">Série</label>
            </div>
          </div>

          <div class="col s12 m6">
            <div class="input-field">
              <input id="editCaderno" type="text" required>
              <label for="editCaderno">Caderno/Folheto</label>
            </div>
          </div>

          <div class="col s12 m6">
            <div class="input-field">
              <select id="editTipoprova" required>
                <option value="" disabled>Selecione</option>
                <option value="FUVEST">FUVEST</option>
                <option value="ENEM">ENEM</option>
                <option value="PARÁFRASE">PARÁFRASE</option>
                <option value="UFPR">UFPR</option>
                <option value="UNIFESP">UNIFESP</option>
                <option value="UNESP">UNESP</option>
                <option value="UNICAMP">UNICAMP</option>
              </select>
              <label for="editTipoprova">Tipo de Prova</label>
            </div>
          </div>

          <div class="col s12">
            <div class="input-field">
              <input id="editTema1" type="text" required>
              <label for="editTema1">Tema 1</label>
            </div>
          </div>

          <div class="col s12">
            <div class="input-field">
              <input id="editTema2" type="text">
              <label for="editTema2">Tema 2</label>
            </div>
          </div>

          <div class="col s12">
            <div class="input-field">
              <input id="editTema3" type="text">
              <label for="editTema3">Tema 3</label>
            </div>
          </div>

        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-danger" id="btnExcluir">
        <i class="material-icons left">delete</i>Excluir
      </button>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <button class="btn btn-soft modal-close">
          <i class="material-icons left">close</i>Cancelar
        </button>
        <button class="btn btn-primary" id="btnSalvarEdicao">
          <i class="material-icons left">save</i>Salvar
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== ENDPOINTS =====
    const API_URL_LIST   = 'https://apisec.secauxiliar.com.br/qrcode/redacao_temas_list.php';
    const API_URL_GETONE = 'https://apisec.secauxiliar.com.br/qrcode/redacao_temas_get.php';
    const API_URL_UPDATE = 'https://apisec.secauxiliar.com.br/qrcode/redacao_temas_update.php';
    const API_URL_DELETE = 'https://apisec.secauxiliar.com.br/qrcode/redacao_temas_delete.php';

    // ✅ regra: só pode editar/excluir até 3 dias após DT_REGISTRO
    const EDIT_WINDOW_DAYS = 3;

    const el = (id) => document.getElementById(id);

    function esc(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function fmtDT(dt){
      if(!dt) return '';
      return String(dt).replace('T',' ').replace('.000','');
    }

    // ✅ parse robusto: "YYYY-MM-DD HH:MM:SS" / "YYYY-MM-DDTHH:MM:SS"
    function parseDTRegistro(dt){
      if(!dt) return null;
      const s = String(dt).trim().replace('T', ' ');
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:\s+(\d{2}):(\d{2})(?::(\d{2}))?)?/);
      if(!m) return null;
      const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
      const hh = Number(m[4] ?? 0), mm = Number(m[5] ?? 0), ss = Number(m[6] ?? 0);
      return new Date(y, mo, d, hh, mm, ss);
    }

    function isWithinEditWindow(dt){
      const d = parseDTRegistro(dt);
      if(!d) return false;
      const now = new Date();
      const diffMs = now.getTime() - d.getTime();
      const diffDays = diffMs / (1000 * 60 * 60 * 24);
      return diffDays <= EDIT_WINDOW_DAYS;
    }

    function reinitModalSelects(){
      const selects = document.querySelectorAll('#modalEditar select');
      selects.forEach(s=>{
        const inst = M.FormSelect.getInstance(s);
        if(inst) inst.destroy();
      });
      M.FormSelect.init(selects);
    }

    // ===== EDIT MODAL HELPERS =====
    function atualizarCamposSegmentoEdit(){
      const seg = el('editSegmento').value;
      const curso = el('editCurso');
      const serie = el('editSerie');

      if(seg === 'CURSO'){
        curso.disabled = false;
        serie.disabled = true;
        serie.value = '';
      } else if(seg === 'COLÉGIO'){
        serie.disabled = false;
        curso.disabled = true;
        curso.value = '';
      } else {
        curso.disabled = true;
        serie.disabled = true;
        curso.value = '';
        serie.value = '';
      }

      reinitModalSelects();
      M.updateTextFields();
    }

    function validarEdicao(){
      const obrig = ['editIdentred','editSegmento','editCaderno','editTipoprova','editTema1'];
      for(const id of obrig){
        const v = (el(id).value || '').trim();
        if(!v) return false;
      }
      const seg = el('editSegmento').value;
      if(seg === 'CURSO' && !el('editCurso').value) return false;
      if(seg === 'COLÉGIO' && !el('editSerie').value) return false;
      return true;
    }

    async function abrirEditar(codigo, dt_registro_from_row){
      try{
        // ✅ BLOQUEIO: só abre modal se dt_registro <= 3 dias
        if(!isWithinEditWindow(dt_registro_from_row)){
          Swal.fire({
            icon:'info',
            title:'Edição bloqueada',
            html:`Este registro só pode ser editado/excluído até <strong>${EDIT_WINDOW_DAYS} dias</strong> após o cadastro.<br><br>
                  <span class="muted">DT_REGISTRO: <strong>${esc(fmtDT(dt_registro_from_row))}</strong></span>`
          });
          return;
        }

        Swal.fire({
          title: 'Carregando...',
          text: 'Abrindo registro para edição',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
        });

        const url = new URL(API_URL_GETONE);
        url.searchParams.set('codigo', String(codigo));

        const resp = await fetch(url.toString(), {
          cache: 'no-store',
          credentials: 'include'
        });
        const j = await resp.json();
        if(!resp.ok || !j.ok) throw new Error(j.msg || 'Falha ao carregar registro');

        const r = j.row || {};

        // ✅ redundância de segurança
        const dtReg = r.dt_registro ?? dt_registro_from_row;
        if(!isWithinEditWindow(dtReg)){
          Swal.close();
          Swal.fire({
            icon:'info',
            title:'Edição bloqueada',
            html:`Este registro só pode ser editado/excluído até <strong>${EDIT_WINDOW_DAYS} dias</strong> após o cadastro.<br><br>
                  <span class="muted">DT_REGISTRO: <strong>${esc(fmtDT(dtReg))}</strong></span>`
          });
          return;
        }

        el('editCodigo').value = r.codigo ?? codigo;
        el('editCodigoLabel').textContent = r.codigo ?? codigo;

        el('editIdentred').value = r.identred ?? '';
        el('editSegmento').value = r.segmento ?? '';
        el('editCurso').value    = r.curso ?? '';
        el('editSerie').value    = (r.serie ?? '') === null ? '' : String(r.serie ?? '');
        el('editCaderno').value  = r.caderno ?? '';
        el('editTipoprova').value= r.tipoprova ?? '';
        el('editTema1').value    = r.tema1 ?? '';
        el('editTema2').value    = r.tema2 ?? '';
        el('editTema3').value    = r.tema3 ?? '';

        atualizarCamposSegmentoEdit();

        Swal.close();

        const modal = M.Modal.getInstance(el('modalEditar'));
        modal.open();

        setTimeout(()=>{
          reinitModalSelects();
          M.updateTextFields();
        }, 50);

      } catch(e){
        Swal.fire({ icon:'error', title:'Erro', text: e.message || String(e) });
      }
    }

    async function salvarEdicao(){
      if(!validarEdicao()){
        Swal.fire({ icon:'warning', title:'Atenção', text:'Preencha os campos obrigatórios do registro.' });
        return;
      }

      const payload = {
        codigo:   (el('editCodigo').value || '').trim(),
        identred: (el('editIdentred').value || '').trim(),
        segmento: (el('editSegmento').value || '').trim(),
        curso:    (el('editCurso').value || '').trim(),
        serie:    (el('editSerie').value || '').trim(),
        caderno:  (el('editCaderno').value || '').trim(),
        tipoprova:(el('editTipoprova').value || '').trim(),
        tema1:    (el('editTema1').value || '').trim(),
        tema2:    (el('editTema2').value || '').trim(),
        tema3:    (el('editTema3').value || '').trim()
      };

      if(payload.segmento === 'CURSO'){
        if(!payload.curso){
          Swal.fire({ icon:'warning', title:'Atenção', text:'Segmento CURSO exige o campo Curso.' });
          return;
        }
        payload.serie = '';
      } else if(payload.segmento === 'COLÉGIO'){
        if(!payload.serie){
          Swal.fire({ icon:'warning', title:'Atenção', text:'Segmento COLÉGIO exige o campo Série.' });
          return;
        }
        payload.curso = '';
      }

      try{
        Swal.fire({
          title:'Salvando...',
          allowOutsideClick:false,
          didOpen:()=>Swal.showLoading()
        });

        const resp = await fetch(API_URL_UPDATE, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const j = await resp.json();
        if(!resp.ok || !j.ok) throw new Error(j.msg || 'Falha ao salvar');

        Swal.close();
        M.Modal.getInstance(el('modalEditar')).close();

        Swal.fire({ icon:'success', title:'Salvo!', text:'Registro atualizado com sucesso.' });
        carregar();

      } catch(e){
        Swal.fire({ icon:'error', title:'Erro', text: e.message || String(e) });
      }
    }

    async function excluirRegistro(){
      const codigo = (el('editCodigo').value || '').trim();
      if(!codigo) return;

      const res = await Swal.fire({
        icon:'warning',
        title:'Excluir registro?',
        html:`Você está prestes a excluir o código <strong>${esc(codigo)}</strong>.<br><br>
              Essa ação não pode ser desfeita.`,
        showCancelButton:true,
        confirmButtonText:'Excluir',
        cancelButtonText:'Cancelar',
        confirmButtonColor:'#d33',
      });

      if(!res.isConfirmed) return;

      try{
        Swal.fire({
          title:'Excluindo...',
          allowOutsideClick:false,
          didOpen:()=>Swal.showLoading()
        });

        const resp = await fetch(API_URL_DELETE, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ codigo })
        });

        const j = await resp.json();
        if(!resp.ok || !j.ok) throw new Error(j.msg || 'Falha ao excluir');

        Swal.close();
        M.Modal.getInstance(el('modalEditar')).close();

        Swal.fire({ icon:'success', title:'Excluído!', text:`Código ${codigo} removido.` });
        carregar();

      } catch(e){
        Swal.fire({ icon:'error', title:'Erro', text: e.message || String(e) });
      }
    }

    // ===== LIST =====
    async function carregar(){
      const q = (el('q').value || '').trim();
      const codigo = (el('codigo').value || '').trim();
      const limit = Math.max(1, Math.min(2000, parseInt(el('limit').value || '500', 10)));

      el('status').textContent = 'Carregando...';

      const tbody = el('tbody');
      tbody.innerHTML = `<tr><td colspan="12" class="muted">Carregando...</td></tr>`;

      try{
        const url = new URL(API_URL_LIST);
        if(q) url.searchParams.set('q', q);
        if(codigo) url.searchParams.set('codigo', codigo);
        url.searchParams.set('limit', String(limit));

        const resp = await fetch(url.toString(), {
          cache: 'no-store',
          credentials: 'include'
        });
        const j = await resp.json();

        if(!resp.ok || !j.ok) throw new Error(j.msg || 'Falha ao listar');

        const rows = j.rows || [];
        el('pillCount').innerHTML = `<i class="material-icons" style="font-size:18px;">dns</i> ${rows.length} registro(s)`;
        el('status').textContent = `OK • ${rows.length} registro(s) carregado(s).`;

        if(rows.length === 0){
          tbody.innerHTML = `<tr><td colspan="12" class="muted">Nenhum registro encontrado.</td></tr>`;
          return;
        }

        tbody.innerHTML = rows.map(r => {
          const canEdit = isWithinEditWindow(r.dt_registro);
          const btn = canEdit
            ? `<a class="btn btn-edit btn-small js-edit" title="Editar"
                 data-codigo="${esc(r.codigo)}"
                 data-dt="${esc(r.dt_registro || '')}">
                 <i class="material-icons">edit</i>
               </a>`
            : `<span class="muted" title="Prazo expirado">—</span>`;

          return `
            <tr>
              <td class="center">${btn}</td>
              <td><strong>${esc(r.codigo)}</strong></td>
              <td>${esc(r.identred)}</td>
              <td>${esc(r.segmento)}</td>
              <td>${esc(r.curso)}</td>
              <td>${esc(r.serie)}</td>
              <td>${esc(r.caderno)}</td>
              <td>${esc(r.tipoprova)}</td>
              <td>${esc(r.tema1)}</td>
              <td>${esc(r.tema2)}</td>
              <td>${esc(r.tema3)}</td>
              <td>${esc(fmtDT(r.dt_registro))}</td>
            </tr>
          `;
        }).join('');

      }catch(e){
        el('status').textContent = 'Erro ao carregar.';
        tbody.innerHTML = `<tr><td colspan="12" class="muted">Erro: ${esc(e.message || String(e))}</td></tr>`;
      }
    }

    function limpar(){
      el('q').value = '';
      el('codigo').value = '';
      el('limit').value = '500';
      M.updateTextFields();
      carregar();
    }

    document.addEventListener('DOMContentLoaded', function(){
      M.Modal.init(document.querySelectorAll('.modal'), { dismissible: true });
      M.FormSelect.init(document.querySelectorAll('select'));
      M.updateTextFields();

      el('btnBuscar').addEventListener('click', carregar);
      el('btnLimpar').addEventListener('click', limpar);

      el('q').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); carregar(); } });
      el('codigo').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); carregar(); } });

      el('btnSalvarEdicao').addEventListener('click', salvarEdicao);
      el('btnExcluir').addEventListener('click', excluirRegistro);

      // ✅ clique do botão editar (sem onclick inline)
      el('tbody').addEventListener('click', (ev)=>{
        const a = ev.target.closest('.js-edit');
        if(!a) return;
        ev.preventDefault();
        const codigo = a.getAttribute('data-codigo');
        const dt = a.getAttribute('data-dt') || '';
        abrirEditar(codigo, dt);
      });

      carregar();
    });
  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>