<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento Seguro - Mercado Pago</title>
  <script src="https://unpkg.com/imask"></script>
  <style>
    .error-message { color: red; font-size: 0.8rem; display: none; margin-top: 5px; }
    .success-message { color: green; font-size: 0.9rem; margin-top: 5px; }
    input.error { border: 1px solid red; }
  </style>
</head>

<body style="display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-family:sans-serif;">

  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://www.mercadopago.com/v2/security.js" view="checkout"></script>

  <form id="form-checkout">
    <h2>Dados do Pagamento</h2>

    <div style="margin-bottom:10px;">
      <label for="cpf">CPF:</label><br>
      <input type="text" id="cpf" placeholder="000.000.000-00">
    </div>

    <div style="margin-bottom:10px;">
      <label for="titular">Titular do Cartão:</label><br>
      <input type="text" id="titular" placeholder="Nome impresso no cartão" style="text-transform:uppercase;">
    </div>

    <div style="margin-bottom:10px;">
      <label for="numero_cartao">Número do Cartão:</label><br>
      <input type="text" id="numero_cartao" placeholder="0000 0000 0000 0000">
    </div>

    <div style="margin-bottom:10px;">
      <label for="data_expiracao">Data de Expiração:</label><br>
      <input type="text" id="data_expiracao" placeholder="MM/AA">
    </div>

    <div style="margin-bottom:20px;">
      <label for="cvv">CVV:</label><br>
      <input type="text" id="cvv" placeholder="123" maxlength="4">
    </div>

    <div id="form-feedback" class="error-message"></div>

    <button type="submit" id="btn-submit">Assinar</button>
  </form>

  <script>
    /** CONFIG */
    const MP_PUBLIC_KEY = "APP_USR-b4a8f895-3bc8-47c9-8445-411a410f36c9"; // ok ficar no HTML (public key)
    const API_URL = "https://apisec.secauxiliar.com.br/digisign/mp_assinatura_criar.php";
    const LOGIN_URL = "/3asign/index.html";

    // 1) Inicializa o Mercado Pago
    const mp = new MercadoPago(MP_PUBLIC_KEY);

    // 2) Lê plano_id e return da URL
    const params = new URLSearchParams(location.search);
    const planoId = Number(params.get("plano_id") || 0);
    const returnUrl = params.get("return") || "/3asign/contratar.html";

    // Se chegou aqui sem plano_id, manda voltar
    if (!planoId) {
      alert("Plano inválido. Volte e selecione um plano.");
      window.location.href = "/3asign/contratar.html";
    }

    // 3) Máscaras (IMask)
    const cpfMask  = IMask(document.getElementById("cpf"), { mask: "000.000.000-00" });
    const cardMask = IMask(document.getElementById("numero_cartao"), { mask: "0000 0000 0000 0000" });
    const cvvMask  = IMask(document.getElementById("cvv"), { mask: "0000" });
    const dateMask = IMask(document.getElementById("data_expiracao"), {
      mask: "MM/YY",
      blocks: {
        MM: { mask: IMask.MaskedRange, from: 1, to: 12, maxLength: 2 },
        YY: { mask: IMask.MaskedRange, from: 0, to: 99, maxLength: 2 }
      }
    });

    document.getElementById("titular").addEventListener("input", function () {
      this.value = this.value.toUpperCase();
    });

    // helpers
    function setFeedback(msg, color) {
      const feedback = document.getElementById("form-feedback");
      feedback.innerText = msg;
      feedback.style.color = color || "red";
      feedback.style.display = "block";
    }

    function clearFeedback() {
      const feedback = document.getElementById("form-feedback");
      feedback.innerText = "";
      feedback.style.display = "none";
      feedback.className = "error-message";
      feedback.style.color = "red";
    }

    // 4) Submit
    const form = document.getElementById("form-checkout");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const btn = document.getElementById("btn-submit");
      clearFeedback();

      btn.disabled = true;
      btn.innerText = "Processando...";

      try {
        // A) Dados
        const numeroCartaoLimpo = cardMask.unmaskedValue;
        const cpfLimpo = cpfMask.unmaskedValue;
        const expiracao = dateMask.value.split("/");

        if (!numeroCartaoLimpo || numeroCartaoLimpo.length < 12) throw new Error("Número do cartão inválido");
        if (!cpfLimpo || cpfLimpo.length !== 11) throw new Error("CPF inválido");
        if (expiracao.length < 2) throw new Error("Data de expiração inválida");
        if (!cvvMask.unmaskedValue || cvvMask.unmaskedValue.length < 3) throw new Error("CVV inválido");
        if (!document.getElementById("titular").value.trim()) throw new Error("Informe o titular do cartão");

        // B) Tokeniza cartão (Mercado Pago)
        const tokenResponse = await mp.createCardToken({
          cardNumber: numeroCartaoLimpo,
          cardholderName: document.getElementById("titular").value.trim(),
          cardExpirationMonth: expiracao[0],
          cardExpirationYear: "20" + expiracao[1],
          securityCode: cvvMask.unmaskedValue,
          identification: { type: "CPF", number: cpfLimpo }
        });

        if (!tokenResponse || !tokenResponse.id) {
          throw new Error("Não foi possível gerar o token do cartão.");
        }

        // C) Pega token de sessão do seu sistema (zs_token)
        const zsToken = localStorage.getItem("zs_token") || "";
        if (!zsToken) {
          const ret = encodeURIComponent(location.pathname + location.search);
          window.location.href = `${LOGIN_URL}?return=${ret}`;
          return;
        }

        // D) Envia pro backend (somente dados seguros)
        const payload = {
          card_token: tokenResponse.id,
          device_id: window.MP_DEVICE_SESSION_ID || "",
          plano_id: planoId
        };

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + zsToken,
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });

        // tenta parsear JSON; se falhar, mostra texto cru
        let data = null;
        const text = await response.text();
        try { data = JSON.parse(text); } catch { data = { error: text }; }

        if (!response.ok) {
          throw new Error(data.error || data.message || "Erro ao processar pagamento no servidor.");
        }

        // E) Sucesso
        btn.innerText = "Sucesso!";
        setFeedback("Assinatura criada! Redirecionando...", "green");

        setTimeout(() => {
          window.location.href = returnUrl;
        }, 1200);

      } catch (error) {
        console.error(error);
        btn.disabled = false;
        btn.innerText = "Assinar";
        setFeedback(error.message || "Erro ao validar cartão. Verifique os dados.", "red");
      }
    });
  </script>
</body>
</html>
