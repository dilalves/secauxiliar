<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pagamento • 3aSign</title>

  <script src="https://unpkg.com/imask"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://www.mercadopago.com/v2/security.js" view="checkout"></script>

  <style>
    body{display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-family:sans-serif;}
    form{min-width:320px}
    .error-message{color:#b91c1c;font-size:.9rem;display:none;margin-top:8px;white-space:pre-wrap}
    .ok-message{color:#15803d;font-size:.9rem;display:none;margin-top:8px;white-space:pre-wrap}
    .row{margin-bottom:10px;}
    input{width:100%;padding:8px;box-sizing:border-box}
    button{padding:10px 12px;cursor:pointer}
  </style>
</head>
<body>

<form id="form-checkout" autocomplete="on">
  <h2>Dados do Pagamento</h2>

  <div class="row">
    <label for="cpf">CPF:</label><br/>
    <input type="text" id="cpf" placeholder="000.000.000-00" inputmode="numeric" required />
  </div>

  <div class="row">
    <label for="titular">Titular do Cartão:</label><br/>
    <input type="text" id="titular" placeholder="Nome impresso no cartão" style="text-transform: uppercase;" required />
  </div>

  <div class="row">
    <label for="numero_cartao">Número do Cartão:</label><br/>
    <input type="text" id="numero_cartao" placeholder="0000 0000 0000 0000" inputmode="numeric" required />
  </div>

  <div class="row">
    <label for="data_expiracao">Data de Expiração:</label><br/>
    <input type="text" id="data_expiracao" placeholder="MM/AA" inputmode="numeric" required />
  </div>

  <div class="row">
    <label for="cvv">CVV:</label><br/>
    <input type="text" id="cvv" placeholder="123" maxlength="4" inputmode="numeric" required />
  </div>

  <div id="err" class="error-message"></div>
  <div id="ok" class="ok-message"></div>

  <button type="submit" id="btn-submit">Assinar</button>
</form>

<script>
  // ========= CONFIG =========
  // IMPORTANTE: Public Key pode ficar no HTML sim (é pública).
  // Só NÃO pode expor o ACCESS TOKEN (segredo) - esse fica no backend.
  const MP_PUBLIC_KEY = "-b4a8f895-3bc8-47c9-8445-411a410f36c9"; // ex: APP_USR-...
  const API_URL = "https://apisec.secauxiliar.com.br/digisign/mp_assinatura_criar.php";
  const LOGIN_URL = "/3asign/index.html";

  const mp = new MercadoPago(MP_PUBLIC_KEY);

  // ========= helpers =========
  function qs(name){
    return new URLSearchParams(location.search).get(name) || "";
  }

  function showErr(msg){
    const el = document.getElementById("err");
    const ok = document.getElementById("ok");
    ok.style.display = "none";
    el.textContent = msg;
    el.style.display = "block";
  }

  function showOk(msg){
    const el = document.getElementById("ok");
    const err = document.getElementById("err");
    err.style.display = "none";
    el.textContent = msg;
    el.style.display = "block";
  }

  // ========= máscaras =========
  const cpfMask  = IMask(document.getElementById('cpf'), { mask: '000.000.000-00' });
  const cardMask = IMask(document.getElementById('numero_cartao'), { mask: '0000 0000 0000 0000' });
  const cvvMask  = IMask(document.getElementById('cvv'), { mask: '0000' });
  const dateMask = IMask(document.getElementById('data_expiracao'), {
    mask: 'MM/YY',
    blocks: {
      MM: { mask: IMask.MaskedRange, from: 1, to: 12, maxLength: 2 },
      YY: { mask: IMask.MaskedRange, from: 0, to: 99, maxLength: 2 }
    }
  });

  document.getElementById('titular').addEventListener('input', function(){
    this.value = this.value.toUpperCase();
  });

  // ========= plano/return =========
  const planoId = Number(qs("plano_id") || 0);
  const returnUrl = decodeURIComponent(qs("return") || "/3asign/contratar.html");

  // ========= auth =========
  function getToken(){
    return localStorage.getItem("zs_token") || "";
  }

  function ensureLogged(){
    const t = getToken();
    if (!t){
      const ret = encodeURIComponent(location.pathname + location.search);
      location.href = `${LOGIN_URL}?return=${ret}`;
      return false;
    }
    return true;
  }

  // ========= submit =========
  document.getElementById("form-checkout").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!ensureLogged()) return;
    if (!planoId){
      showErr("Plano inválido na URL. Abra por /contratar.html para vir com ?plano_id=...");
      return;
    }

    const btn = document.getElementById("btn-submit");
    btn.disabled = true;
    btn.textContent = "Processando...";
    showErr(""); document.getElementById("err").style.display = "none";

    try {
      const numeroCartaoLimpo = cardMask.unmaskedValue;
      const cpfLimpo = cpfMask.unmaskedValue;
      const exp = dateMask.value.split('/');

      if (exp.length < 2) throw new Error("Data de expiração inválida.");
      if (!numeroCartaoLimpo || numeroCartaoLimpo.length < 13) throw new Error("Número do cartão inválido.");
      if (!cpfLimpo || cpfLimpo.length !== 11) throw new Error("CPF inválido.");

      // Device Session (antifraude)
      const deviceId = window.MP_DEVICE_SESSION_ID || "";
      if (!deviceId){
        throw new Error("Falha ao obter Device ID do Mercado Pago (MP_DEVICE_SESSION_ID). Abra a página em uma aba normal (sem bloqueios) e tente novamente.");
      }

      // Tokeniza cartão no MP
      const tokenResponse = await mp.createCardToken({
        cardNumber: numeroCartaoLimpo,
        cardholderName: document.getElementById('titular').value,
        cardExpirationMonth: exp[0],
        cardExpirationYear: '20' + exp[1],
        securityCode: cvvMask.unmaskedValue,
        identification: { type: "CPF", number: cpfLimpo }
      });

      if (!tokenResponse || !tokenResponse.id){
        throw new Error("Não foi possível gerar o card_token no Mercado Pago.");
      }

      // Envia ao backend
      const payload = {
        plano_id: planoId,
        card_token: tokenResponse.id,
        device_id: deviceId
      };

      const resp = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "Authorization": "Bearer " + getToken()
        },
        body: JSON.stringify(payload)
      });

      const text = await resp.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      if (!resp.ok || !data.ok){
        // Mostra o erro real do backend/MP
        const msg =
          (data.error ? `Erro: ${data.error}\n` : "") +
          (data.detail ? `Detail: ${JSON.stringify(data.detail, null, 2)}` : (data.raw ? `Resposta: ${data.raw}` : ""));
        throw new Error(msg || "Erro ao processar pagamento no servidor.");
      }

      showOk("Assinatura criada com sucesso! Redirecionando...");
      setTimeout(() => location.href = returnUrl, 1200);

    } catch (err) {
      console.error(err);
      showErr(String(err.message || err));
      btn.disabled = false;
      btn.textContent = "Assinar";
    }
  });
</script>

</body>
</html>
