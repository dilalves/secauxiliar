<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pagamento • 3aSign</title>

  <script src="https://unpkg.com/imask"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <script src="https://www.mercadopago.com/v2/security.js" view="checkout"></script>

  <style>
    :root{
      --nav:#0b3b78;
      --bg:#0b3b78;
      --card:#ffffff;
      --muted:#6b7280;
      --line:#e5e7eb;
      --ok:#15803d;
      --warn:#b45309;
      --danger:#b91c1c;
      --focus:#93c5fd;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      color:#111827;
    }
    .wrap{width:100%; max-width:980px;}
    .top{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:16px;
      color:#fff;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:10px; align-items:center; font-weight:800;}
    .brand img{width:28px; height:28px; border-radius:8px;}
    .link{color:#dbeafe; text-decoration:none; font-weight:600;}
    .link:hover{opacity:.9; text-decoration:underline;}
    .panel{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.18);
      border-radius:16px;
      padding:18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 28px rgba(0,0,0,.12);
    }
    h1{margin:0 0 6px 0; font-size:22px;}
    p{margin:0; color:var(--muted);}

    .meta{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:800;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#f8fafc;
      color:#0f172a;
    }

    form{margin-top:14px;}
    .grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:12px 14px;
      margin-top:12px;
    }
    @media (max-width: 820px){
      .grid{grid-template-columns:1fr;}
    }

    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-size:13px; font-weight:800; color:#111827;}
    .hint{font-size:12px; color:var(--muted); margin-top:-2px;}

    input{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      font-size:14px;
      transition:border-color .15s, box-shadow .15s;
    }
    input:focus{
      border-color:var(--focus);
      box-shadow:0 0 0 4px rgba(147,197,253,.35);
    }
    input.error{
      border-color:#fecaca;
      box-shadow:0 0 0 4px rgba(254,202,202,.35);
    }

    .row-actions{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .btn{
      appearance:none;
      border:0;
      background:var(--nav);
      color:#fff;
      font-weight:900;
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      min-width:170px;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed;}
    .btn.secondary{
      background:transparent;
      border:1px solid rgba(255,255,255,.35);
      color:#fff;
      font-weight:800;
      min-width:auto;
    }

    .muted{color:var(--muted); font-size:13px;}

    .msg{
      margin-top:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      display:none;
      font-weight:700;
      font-size:13px;
    }
    .msg.show{display:block;}
    .msg.err{border-color:#fecaca; background:#fff1f2; color:var(--danger);}
    .msg.ok{border-color:#bbf7d0; background:#f0fdf4; color:var(--ok);}
    .msg.info{border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8;}

    .footer-note{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img src="icone.ico" alt="3aSign">
        <div>3aSign</div>
      </div>

      <div style="display:flex; gap:14px; align-items:center;">
        <a class="link" id="backLink" href="/3asign/contratar.html">← Voltar</a>
        <a class="link" id="loginLink" href="/3asign/index.html">Login</a>
      </div>
    </div>

    <div class="panel">
      <div class="card">
        <h1>Pagamento do plano</h1>
        <p>Informe os dados do cartão para concluir sua assinatura com segurança.</p>

        <div class="meta">
          <div class="badge" id="planoBadge">Plano: —</div>
          <div class="badge" id="ambBadge">Ambiente: Produção</div>
        </div>

        <div id="msg" class="msg"></div>

        <form id="form-checkout" autocomplete="on" novalidate>
          <div class="grid">
            <div class="field">
              <label for="cpf">CPF</label>
              <input type="text" id="cpf" placeholder="000.000.000-00" inputmode="numeric" autocomplete="cpf">
              <div class="hint">Digite o CPF do titular do cartão.</div>
            </div>

            <div class="field">
              <label for="titular">Titular do cartão</label>
              <input type="text" id="titular" placeholder="NOME IMPRESSO NO CARTÃO" style="text-transform:uppercase;" autocomplete="cc-name">
              <div class="hint">Exatamente como aparece no cartão.</div>
            </div>

            <div class="field">
              <label for="numero_cartao">Número do cartão</label>
              <input type="text" id="numero_cartao" placeholder="0000 0000 0000 0000" inputmode="numeric" autocomplete="cc-number">
            </div>

            <div class="field">
              <label for="data_expiracao">Validade</label>
              <input type="text" id="data_expiracao" placeholder="MM/AA" inputmode="numeric" autocomplete="cc-exp">
            </div>

            <div class="field">
              <label for="cvv">CVV</label>
              <input type="text" id="cvv" placeholder="123" maxlength="4" inputmode="numeric" autocomplete="cc-csc">
            </div>
          </div>

          <div class="row-actions">
            <div class="muted">
              Seus dados são tokenizados pelo Mercado Pago. O 3aSign não armazena número do cartão nem CVV.
            </div>
            <button type="submit" id="btn-submit" class="btn">Assinar</button>
          </div>

          <div class="footer-note">
            Ao assinar, você concorda com os termos e política de privacidade.
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    /** CONFIG */
    const MP_PUBLIC_KEY = "APP_USR-b4a8f895-3bc8-47c9-8445-411a410f36c9"; // public key
    const API_URL   = "https://apisec.secauxiliar.com.br/digisign/mp_assinatura_criar.php";
    const LOGIN_URL = "/3asign/index.html";
    const DEFAULT_RETURN = "/3asign/contratar.html";

    const mp = new MercadoPago(MP_PUBLIC_KEY);

    // Lê plano_id e return da URL
    const params = new URLSearchParams(location.search);
    const planoId = Number(params.get("plano_id") || 0);
    const returnUrl = params.get("return") || DEFAULT_RETURN;

    // links topo
    (function fixLinks(){
      const ret = encodeURIComponent(location.pathname + location.search);
      const login = document.getElementById("loginLink");
      if (login) login.href = `${LOGIN_URL}?return=${ret}`;

      const back = document.getElementById("backLink");
      if (back) back.href = returnUrl || DEFAULT_RETURN;

      const badge = document.getElementById("planoBadge");
      if (badge) badge.textContent = `Plano: #${planoId || "—"}`;
    })();

    // sem plano_id -> volta
    if (!planoId) {
      alert("Plano inválido. Volte e selecione um plano.");
      window.location.href = DEFAULT_RETURN;
    }

    // Máscaras
    const cpfMask  = IMask(document.getElementById("cpf"), { mask: "000.000.000-00" });
    const cardMask = IMask(document.getElementById("numero_cartao"), { mask: "0000 0000 0000 0000" });
    const cvvMask  = IMask(document.getElementById("cvv"), { mask: "0000" });
    const dateMask = IMask(document.getElementById("data_expiracao"), {
      mask: "MM/YY",
      blocks: {
        MM: { mask: IMask.MaskedRange, from: 1, to: 12, maxLength: 2 },
        YY: { mask: IMask.MaskedRange, from: 0, to: 99, maxLength: 2 }
      }
    });

    document.getElementById("titular").addEventListener("input", function () {
      this.value = this.value.toUpperCase();
    });

    function showMsg(text, type){
      const el = document.getElementById("msg");
      el.className = "msg show " + (type || "");
      el.textContent = text;
    }
    function clearMsg(){
      const el = document.getElementById("msg");
      el.className = "msg";
      el.textContent = "";
    }

    function markError(el, on){
      if (!el) return;
      if (on) el.classList.add("error");
      else el.classList.remove("error");
    }

    const form = document.getElementById("form-checkout");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const btn = document.getElementById("btn-submit");
      clearMsg();

      // limpa erros visuais
      ["cpf","titular","numero_cartao","data_expiracao","cvv"].forEach(id => markError(document.getElementById(id), false));

      btn.disabled = true;
      btn.textContent = "Processando...";

      try {
        // A) Validações
        const numeroCartaoLimpo = cardMask.unmaskedValue;
        const cpfLimpo = cpfMask.unmaskedValue;
        const expiracao = (dateMask.value || "").split("/");
        const titular = document.getElementById("titular").value.trim();
        const cvv = cvvMask.unmaskedValue;

        let hasErr = false;
        if (!numeroCartaoLimpo || numeroCartaoLimpo.length < 12) { markError(document.getElementById("numero_cartao"), true); hasErr = true; }
        if (!cpfLimpo || cpfLimpo.length !== 11) { markError(document.getElementById("cpf"), true); hasErr = true; }
        if (expiracao.length < 2 || !expiracao[0] || !expiracao[1]) { markError(document.getElementById("data_expiracao"), true); hasErr = true; }
        if (!cvv || cvv.length < 3) { markError(document.getElementById("cvv"), true); hasErr = true; }
        if (!titular) { markError(document.getElementById("titular"), true); hasErr = true; }

        if (hasErr) throw new Error("Confira os campos em destaque.");

        // B) Tokeniza cartão
        const tokenResponse = await mp.createCardToken({
          cardNumber: numeroCartaoLimpo,
          cardholderName: titular,
          cardExpirationMonth: expiracao[0],
          cardExpirationYear: "20" + expiracao[1],
          securityCode: cvv,
          identification: { type: "CPF", number: cpfLimpo }
        });

        if (!tokenResponse || !tokenResponse.id) {
          throw new Error("Não foi possível gerar o token do cartão.");
        }

        // C) Token do seu sistema
        const zsToken = localStorage.getItem("zs_token") || "";
        if (!zsToken) {
          const ret = encodeURIComponent(location.pathname + location.search);
          window.location.href = `${LOGIN_URL}?return=${ret}`;
          return;
        }

        // D) Envia pro backend
        const payload = {
          card_token: tokenResponse.id,
          device_id: window.MP_DEVICE_SESSION_ID || "",
          plano_id: planoId
        };

        showMsg("Criando assinatura...", "info");

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + zsToken,
            "Accept": "application/json"
          },
          body: JSON.stringify(payload)
        });

        const text = await response.text();
        let data = null;
        try { data = JSON.parse(text); } catch { data = { error: text }; }

        if (!response.ok) {
          throw new Error(data.error || data.message || "Erro ao processar pagamento no servidor.");
        }

        // E) Sucesso
        btn.textContent = "Sucesso!";
        showMsg("Assinatura criada! Redirecionando...", "ok");

        setTimeout(() => {
          window.location.href = returnUrl;
        }, 1200);

      } catch (err) {
        console.error(err);
        btn.disabled = false;
        btn.textContent = "Assinar";
        showMsg(err.message || "Erro ao validar cartão. Verifique os dados.", "err");
      }
    });
  </script>
</body>
</html>
