<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Login • 3aSign</title>
  <!-- Favicon -->
  <link rel="icon" href="icone.ico" type="image/x-icon">
  <link rel="shortcut icon" href="icone.ico" type="image/x-icon">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg:#0b3b78;         /* azul Objetivo */
      --card:#ffffff;
      --input-border:#cbd5e1;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      color:#0f172a;
    }
    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 16px 40px rgba(15,23,42,.4);
      padding:24px 28px;
      width:100%;
      max-width:380px;
    }
    h1{
      margin:0 0 4px;
      font-size:1.4rem;
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      margin-bottom:16px;
    }
    label{
      display:block;
      font-size:.8rem;
      margin:8px 0 4px;
      color:#0f172a;
    }
    input[type="email"],
    input[type="password"]{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--input-border);
      font-size:.9rem;
    }
    button{
      width:100%;
      margin-top:16px;
      padding:10px 12px;
      border-radius:999px;
      border:none;
      background:#0b3b78;
      color:#fff;
      font-weight:600;
      cursor:pointer;
      font-size:.95rem;
    }
    button:hover{
      filter:brightness(1.05);
    }
    .erro{
      background:#fee2e2;
      color:#b91c1c;
      border-radius:8px;
      padding:8px 10px;
      font-size:.8rem;
      margin-bottom:10px;
      display:none;
    }
    .brand{
      font-size:.8rem;
      color:#e5e7eb;
      text-align:center;
      margin-top:12px;
      position:fixed;
      bottom:8px;
      left:0;
      right:0;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>3aSign</h1>
    <div class="subtitle">Painel de assinaturas • 3A Sistemas </div>

    <div id="erro" class="erro"></div>

    <form id="formLogin">
      <label for="email">E-mail</label>
      <input type="email" id="email" name="email" required autofocus>

      <label for="senha">Senha</label>
      <input type="password" id="senha" name="senha" required>

      <button type="submit">Entrar</button>
    </form>
  </div>

  <div class="brand">
    3A Sistemas
  </div>

  <script>
  const API_BASE = 'https://apisec.secauxiliar.com.br/digisign';

  function getReturnUrl(){
    const u = new URL(location.href);
    let ret = u.searchParams.get('return');

    // default: admin
    if (!ret) ret = '/3asign/admin.html';

    // segurança simples: só permite voltar pra dentro do /3asign
    if (!ret.startsWith('/3asign/')) ret = '/3asign/admin.html';

    // evita loop: se ret for a própria página, manda pro admin
    const herePath = location.pathname; // ex: "/3asign/" ou "/3asign/index.html"
    if (ret === '/3asign/' || ret.endsWith('/index.html') || ret === herePath) {
      ret = '/3asign/admin.html';
    }

    return ret;
  }

  function goContratar(url) {
    window.location.replace(url || '/3asign/contratar.html');
  }

  function logoutLocal() {
    localStorage.removeItem('zs_token');
    localStorage.removeItem('zs_user');
  }

  const returnUrl = getReturnUrl();

  const form    = document.getElementById('formLogin');
  const divErro = document.getElementById('erro');

  function showError(msg) {
    divErro.textContent = msg || 'Falha no login.';
    divErro.style.display = 'block';
  }

  // ✅ Se já estiver “logado”, valida no backend antes de pular
  (async function autoCheck(){
    const tokenExistente = localStorage.getItem('zs_token');
    const userExistente  = localStorage.getItem('zs_user');
    if (!tokenExistente || !userExistente) return;

    try {
      // precisa existir no backend: /digisign/api/auth/me.php (com CORS)
      const r = await fetch(API_BASE + '/api/auth/me.php', {
        method: 'GET',
        headers: { Authorization: 'Bearer ' + tokenExistente }
      });
      const j = await r.json().catch(() => ({}));

      // ✅ 402 = logado, mas precisa pagar -> vai contratar (SEM deslogar)
      if (r.status === 402) {
        goContratar((j && (j.upgrade_url || j.redirect_to)) || '/3asign/contratar.html');
        return;
      }

      if (!r.ok) {
        logoutLocal();
        return;
      }


      // ✅ se token ok, checa trial_expired no payload
      const u = j.user || {};

      // ✅ Se precisa pagar (trial expirado OU sem assinatura), vai pra contratar
      if (u.needs_payment || u.trial_expired || (u.assinatura_ativa === false && u.trial_ok === false)) {
        goContratar('/3asign/contratar.html');
        return;
      }


      window.location.replace(returnUrl);


    } catch (e) {
      // se falhar rede/CORS, não trava: deixa o usuário logar novamente
      // logoutLocal();
    }
  })();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    divErro.style.display = 'none';
    divErro.textContent = '';

    const email = document.getElementById('email').value.trim();
    const senha = document.getElementById('senha').value;

    const fd = new FormData();
    fd.append('email', email);
    fd.append('senha', senha);

    try {
      const resp = await fetch(API_BASE + '/auth_login.php', { method: 'POST', body: fd });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok || !data.ok) {

        // ✅ Se backend mandou redirecionar (trial expirado / precisa pagar)
        if (data && (data.code === 'NEEDS_PAYMENT' || data.redirect_to || data.upgrade_url)) {
          goContratar(data.redirect_to || data.upgrade_url || '/3asign/contratar.html');
          return;
        }


        showError(data.message || data.error || 'Falha no login.');
        return;
      }


      localStorage.setItem('zs_token', data.token);
      localStorage.setItem('zs_user', JSON.stringify(data.user));

      // ✅ agora é por flag
      if (data.user && (data.user.needs_payment || data.user.trial_expired || (data.user.assinatura_ativa === false && data.user.trial_ok === false))) {
        goContratar('/3asign/contratar.html');
        return;
      }


      window.location.replace(returnUrl);


    } catch (err) {
      console.error(err);
      showError('Erro ao conectar com o servidor.');
    }
  });
</script>

</body>
</html>
