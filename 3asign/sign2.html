<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Assinar documento • 3aSign</title>
  <!-- Favicon -->
  <link rel="icon" href="icone.ico" type="image/x-icon">
  <link rel="shortcut icon" href="icone.ico" type="image/x-icon">

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #0b3b78;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f3f4f6 55%);
    }
    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }
    .card {
      width: 100%;
      max-width: 900px;
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.18);
      padding: 24px 24px 20px;
    }
    .top-logo {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .12em;
      text-transform: uppercase;
      text-align: center;
      margin-bottom: 10px;
    }
    .top-logo b {
      color: var(--primary);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
      text-align: center;
      color: var(--ink);
    }
    .sub {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 18px;
    }

    .section {
      border-top: 1px solid var(--line);
      padding-top: 14px;
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
    }
    .section h2 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--ink);
    }
    .fieldline {
      font-size: 13px;
      color: var(--muted);
      margin: 2px 0;
    }
    .fieldline span {
      color: var(--ink);
      font-weight: 500;
    }
    .docs-list {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      max-height: 180px;
      overflow: auto;
      background: #f9fafb;
    }
    .doc-item {
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 13px;
      color: var(--ink);
    }
    .doc-item:last-child {
      border-bottom: none;
    }

    /* área dos PDFs empilhados */
    #pdf-section {
      border-top: 1px solid var(--line);
      margin-top: 18px;
      padding-top: 14px;
    }
    #pdf-section h2 {
      margin: 0 0 4px;
      font-size: 14px;
      color: var(--ink);
    }
    #pdf-section p {
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--muted);
    }
    .pdf-card {
      margin-bottom: 24px;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
      box-shadow: 0 4px 20px rgba(15,23,42,0.25);
    }
    .pdf-frame {
      width: 100%;
      height: 900px;
      border: none;
      display: block;
    }

    .actions {
      margin-top: 18px;
      border-top: 1px solid var(--line);
      padding-top: 14px;
    }
    .checkline {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .checkline input[type="checkbox"] {
      margin-top: 2px;
    }
    .btn-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 9px 22px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary[disabled] {
      opacity: .65;
      cursor: default;
    }
    .msg {
      font-size: 13px;
    }
    .msg.error { color: var(--danger); }
    .msg.sucesso { color: var(--success); }
    .footer {
      text-align: center;
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
    }

    /* assinatura */
    #signature-wrapper {
      margin: 10px 0 14px;
      padding: 10px 12px;
      border-radius: 10px;
      background:#f9fafb;
      border:1px solid var(--line);
    }
    #signature-wrapper p {
      margin:0 0 6px;
      font-size:12px;
      color:var(--muted);
    }
    #sigCanvas {
      width:100%;
      max-width:400px;
      height:160px;
      background:#fff;
      border:1px dashed #9ca3af;
      border-radius:6px;
      cursor:crosshair;
      display:block;
    }
    #btn-limpar-assinatura {
      margin-top:6px;
      background:none;
      border:none;
      padding:0;
      font-size:12px;
      color:#2563eb;
      cursor:pointer;
    }
    #sig-status {
      margin-left:8px;
      font-size:12px;
      color:var(--success);
      display:none;
    }

    @media (max-width: 720px) {
      .card { padding: 18px 16px 18px; }
      .section {
        grid-template-columns: 1fr;
      }
      .pdf-frame {
        height: 600px;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top-logo">
      <b>3aSign</b> • 3A Sistemas
    </div>
    <h1 id="titulo-principal">Carregando...</h1>
    <div class="sub" id="subtitulo">
      Aguarde, estamos buscando os dados do documento.
    </div>

    <div id="conteudo" style="display:none;">
      <div class="section">
        <div>
          <h2>Dados da assinatura</h2>
          <div class="fieldline">Destinatário: <span id="dest-nome">–</span></div>
          <div class="fieldline">E-mail: <span id="dest-email">–</span></div>
          <div class="fieldline">Título do envelope: <span id="env-titulo">–</span></div>
          <div class="fieldline">Status atual: <span id="dest-status">–</span></div>
        </div>
        <div>
          <h2>Documento(s)</h2>
          <div class="docs-list" id="lista-docs">
            <!-- preenchido via JS -->
          </div>
        </div>
      </div>

      <!-- PDFs empilhados em tela grande -->
      <section id="pdf-section">
        <h2>Visualizar documento(s)</h2>
        <p>Os documentos anexados a este envelope são exibidos abaixo, na ordem enviada. Role até o final para ler tudo antes de assinar.</p>
        <div id="pdfContainer"></div>
      </section>

      <!-- área de assinatura -->
      <div class="actions" id="area-assinatura">
        <div class="checkline">
          <input type="checkbox" id="chk-concordo" />
          <label for="chk-concordo">
            Declaro que li o(s) documento(s) acima e concordo com os termos apresentados.
            <br>
            <small id="scroll-info" style="color:var(--muted);font-size:11px;">
              Role até o final dos documentos para habilitar esta opção.
            </small>
          </label>
        </div>

        <!-- quadro de assinatura: aparece só depois de marcar o checkbox -->
        <div id="signature-wrapper" style="display:none;">
          <p>Assine no quadro abaixo usando o mouse (computador) ou o dedo (celular).</p>
          <canvas id="sigCanvas" width="400" height="160"></canvas>
          <button type="button" id="btn-limpar-assinatura">Limpar assinatura</button>
          <span id="sig-status">Assinatura registrada ✔</span>
        </div>

        <!-- VERIFICAÇÃO DE IDENTIDADE (selfie / documento) -->
        <div id="verificacao-identidade"
             style="display:none; margin:12px 0 10px; padding:10px 12px; border-radius:10px;
                    border:1px solid var(--line); background:#f9fafb;">
          <h2 style="margin:0 0 4px; font-size:14px; color:var(--ink);">
            Verificação de identidade
          </h2>
          <p style="margin:0 0 10px; font-size:12px; color:var(--muted);">
            Para reforçar a identificação, este envelope solicita o envio de selfie e/ou foto de documento
            antes de concluir a assinatura.
          </p>

          <div id="bloco-selfie" style="margin-bottom:10px; display:none;">
            <strong style="font-size:13px;">Selfie do signatário</strong>
            <p style="margin:2px 0 6px; font-size:12px; color:var(--muted);">
              Tire uma foto do seu rosto em ambiente claro.
            </p>
            <input type="file" id="input-selfie" accept="image/*" capture="user">
            <button type="button"
                    id="btn-enviar-selfie"
                    class="btn-primary"
                    style="padding:6px 14px; font-size:12px; margin-top:4px;">
              Enviar selfie
            </button>
            <div id="status-selfie" class="msg" style="margin-top:4px;"></div>
          </div>

          <div id="bloco-doc" style="margin-bottom:0; display:none;">
            <strong style="font-size:13px;">Foto do documento</strong>
            <p style="margin:2px 0 6px; font-size:12px; color:var(--muted);">
              Fotografe a frente de um documento oficial (RG, CNH, RNE, etc.).
            </p>
            <input type="file" id="input-doc" accept="image/*" capture="environment">
            <button type="button"
                    id="btn-enviar-doc"
                    class="btn-primary"
                    style="padding:6px 14px; font-size:12px; margin-top:4px;">
              Enviar documento
            </button>
            <div id="status-doc" class="msg" style="margin-top:4px;"></div>
          </div>
        </div>


        <div class="btn-row">
          <button class="btn-primary" id="btn-assinar" disabled>Assinar documento</button>
          <div class="msg" id="mensagem"></div>
        </div>
      </div>

      <div class="actions" id="area-ja-assinado" style="display:none;">
        <div class="msg sucesso">
          Este documento já foi assinado. Obrigado!
        </div>
      </div>
    </div>

    <div class="footer">
      Sistema de assinaturas 3aSign • 3A Sistemas
    </div>
  </div>
</div>

<script>
(function() {
  const token = new URLSearchParams(window.location.search).get('token');
  const SIGNATURE_KEY = '3asign_signature'; // assinatura salva no dispositivo
  const API_BASE = 'https://apisec.secauxiliar.com.br/digisign';

  // flags de verificação
  let mustSelfie = false;
  let mustDoc = false;
  let hasSelfie = false;
  let hasDoc = false;

  const tituloPrincipal = document.getElementById('titulo-principal');
  const subtitulo = document.getElementById('subtitulo');
  const conteudo = document.getElementById('conteudo');
  const listaDocs = document.getElementById('lista-docs');
  const pdfContainer = document.getElementById('pdfContainer');

  const destNome = document.getElementById('dest-nome');
  const destEmail = document.getElementById('dest-email');
  const envTitulo = document.getElementById('env-titulo');
  const destStatus = document.getElementById('dest-status');

  const chkConcordo = document.getElementById('chk-concordo');
  const scrollInfo = document.getElementById('scroll-info');
  const btnAssinar = document.getElementById('btn-assinar');
  const msg = document.getElementById('mensagem');
  const areaAssinatura = document.getElementById('area-assinatura');
  const areaJaAssinado = document.getElementById('area-ja-assinado');
  const signatureWrapper = document.getElementById('signature-wrapper');
  const sigCanvas = document.getElementById('sigCanvas');
  const sigStatus = document.getElementById('sig-status');
  const btnLimparAss = document.getElementById('btn-limpar-assinatura');

  const cardVerificacao = document.getElementById('verificacao-identidade');
  const blocoSelfie = document.getElementById('bloco-selfie');
  const blocoDoc = document.getElementById('bloco-doc');
  const inputSelfie = document.getElementById('input-selfie');
  const inputDoc = document.getElementById('input-doc');
  const btnEnviarSelfie = document.getElementById('btn-enviar-selfie');
  const btnEnviarDoc = document.getElementById('btn-enviar-doc');
  const statusSelfie = document.getElementById('status-selfie');
  const statusDoc = document.getElementById('status-doc');

  // ---- assinatura (canvas) ----
  let sigCtx = null;
  let desenhando = false;
  let assinaturaDataUrl = null;
  let leituraLiberada = false;

  function limparAssinatura() {
    if (!sigCanvas || !sigCtx) return;
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    assinaturaDataUrl = null;
    sigStatus.style.display = 'none';
    atualizarEstadoBotao();
    try {
      localStorage.removeItem(SIGNATURE_KEY);
    } catch (err) {
      console.warn('Não foi possível remover assinatura salva:', err);
    }
  }

  function setMensagem(texto, tipo) {
    msg.textContent = texto || '';
    msg.className = 'msg' + (tipo ? ' ' + tipo : '');
  }

  function statusLabel(code) {
    switch (code) {
      case 'pending': return 'Pendente';
      case 'sent':    return 'Enviado';
      case 'signed':  return 'Assinado';
      case 'canceled':return 'Cancelado';
      default:        return code || '—';
    }
  }

  function atualizarEstadoBotao() {
      // requisitos  de identidade
      const okSelfie = !mustSelfie || hasSelfie;
      const okDoc    = !mustDoc || hasDoc;

      const pode = chkConcordo.checked &&
                  leituraLiberada &&
                  !!assinaturaDataUrl &&
                  okSelfie &&
                  okDoc;

      btnAssinar.disabled = !pode;
    }                             

  // inicializa o canvas
  function initSignaturePad() {
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');
    sigCtx.strokeStyle = '#000';
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = 'round';
    sigCtx.lineJoin = 'round';

    // tenta carregar assinatura salva anteriormente
    try {
      const savedSig = localStorage.getItem(SIGNATURE_KEY);
      if (savedSig) {
        const img = new Image();
        img.onload = () => {
          sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
          sigCtx.drawImage(img, 0, 0, sigCanvas.width, sigCanvas.height);
          assinaturaDataUrl = savedSig;
          sigStatus.style.display = 'inline';
          atualizarEstadoBotao();
        };
        img.src = savedSig;
      }
    } catch (err) {
      console.warn('Não foi possível ler assinatura salva:', err);
    }

    const getPos = (e) => {
      const rect = sigCanvas.getBoundingClientRect();
      if (e.touches && e.touches.length) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    };

    const startDraw = (e) => {
      e.preventDefault();
      desenhando = true;
      const p = getPos(e);
      sigCtx.beginPath();
      sigCtx.moveTo(p.x, p.y);
    };

    const moveDraw = (e) => {
      if (!desenhando) return;
      e.preventDefault();
      const p = getPos(e);
      sigCtx.lineTo(p.x, p.y);
      sigCtx.stroke();
    };

    const endDraw = (e) => {
      if (!desenhando) return;
      e.preventDefault();
      desenhando = false;

      assinaturaDataUrl = sigCanvas.toDataURL('image/png');
      sigStatus.style.display = 'inline';

      // salva assinatura no dispositivo
      try {
        localStorage.setItem(SIGNATURE_KEY, assinaturaDataUrl);
      } catch (err) {
        console.warn('Não foi possível salvar assinatura localmente:', err);
      }

      atualizarEstadoBotao();
    };

    sigCanvas.addEventListener('mousedown', startDraw);
    sigCanvas.addEventListener('mousemove', moveDraw);
    sigCanvas.addEventListener('mouseup', endDraw);
    sigCanvas.addEventListener('mouseleave', endDraw);

    sigCanvas.addEventListener('touchstart', startDraw, { passive:false });
    sigCanvas.addEventListener('touchmove', moveDraw, { passive:false });
        sigCanvas.addEventListener('touchend', endDraw, { passive:false });

    // ❗ não vamos limpar se já carregamos uma assinatura salva
    try {
      const savedSig = localStorage.getItem(SIGNATURE_KEY);
      if (!savedSig) {
        limparAssinatura();
      }
      // se tiver savedSig, o onload da imagem já vai chamar atualizarEstadoBotao()
    } catch (err) {
      console.warn('Não foi possível ler assinatura salva:', err);
      limparAssinatura();
    }
}


  if (btnLimparAss) {
    btnLimparAss.addEventListener('click', (e) => {
      e.preventDefault();
      limparAssinatura();
    });
  }

  // libera o checkbox quando o usuário chegar ao final da página
  function verificarScrollLeitura() {
    if (leituraLiberada) return;
    const scrolled = window.innerHeight + window.scrollY;
    const docHeight = document.documentElement.scrollHeight - 40;
    if (scrolled >= docHeight) {
      leituraLiberada = true;
      chkConcordo.disabled = false;
      atualizarEstadoBotao();
      if (scrollInfo) {
        scrollInfo.textContent = 'Você já rolou todos os documentos. Agora marque a opção acima para habilitar a assinatura.';
      }
    }
  }

    function configurarVerificacao() {
    if (!cardVerificacao) return;

    if (mustSelfie || mustDoc) {
      cardVerificacao.style.display = 'block';
    } else {
      cardVerificacao.style.display = 'none';
      return;
    }

    // selfie
    if (mustSelfie) {
      blocoSelfie.style.display = 'block';
      if (hasSelfie) {
        statusSelfie.textContent = 'Selfie já enviada.';
        statusSelfie.className = 'msg sucesso';
      } else {
        statusSelfie.textContent = 'Nenhuma selfie enviada ainda.';
        statusSelfie.className = 'msg error';
      }
    } else {
      blocoSelfie.style.display = 'none';
    }

    // documento
    if (mustDoc) {
      blocoDoc.style.display = 'block';
      if (hasDoc) {
        statusDoc.textContent = 'Documento já enviado.';
        statusDoc.className = 'msg sucesso';
      } else {
        statusDoc.textContent = 'Nenhuma foto de documento enviada ainda.';
        statusDoc.className = 'msg error';
      }
    } else {
      blocoDoc.style.display = 'none';
    }

    atualizarEstadoBotao();
  }

  // --- upload da selfie ---
  if (btnEnviarSelfie) {
    btnEnviarSelfie.addEventListener('click', async () => {
      if (!inputSelfie.files || inputSelfie.files.length === 0) {
        alert('Escolha ou tire uma foto para enviar.');
        return;
      }

      const fd = new FormData();
      fd.append('token', token);
      fd.append('arquivo', inputSelfie.files[0]);

      statusSelfie.textContent = 'Enviando selfie...';
      statusSelfie.className = 'msg';

      try {
        const resp = await fetch(API_BASE + '/sign_upload_selfie.php', {
          method: 'POST',
          body: fd
        });
        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          statusSelfie.textContent = data.error || 'Erro ao enviar selfie.';
          statusSelfie.className = 'msg error';
          return;
        }

        hasSelfie = true;
        statusSelfie.textContent = 'Selfie enviada com sucesso.';
        statusSelfie.className = 'msg sucesso';
        atualizarEstadoBotao();

      } catch (e) {
        console.error(e);
        statusSelfie.textContent = 'Falha na comunicação ao enviar selfie.';
        statusSelfie.className = 'msg error';
      }
    });
  }

  // --- upload do documento ---
  if (btnEnviarDoc) {
    btnEnviarDoc.addEventListener('click', async () => {
      if (!inputDoc.files || inputDoc.files.length === 0) {
        alert('Escolha ou tire a foto do documento para enviar.');
        return;
      }

      const fd = new FormData();
      fd.append('token', token);
      fd.append('arquivo', inputDoc.files[0]);

      statusDoc.textContent = 'Enviando documento...';
      statusDoc.className = 'msg';

      try {
        const resp = await fetch(API_BASE + '/sign_upload_doc.php', {
          method: 'POST',
          body: fd
        });
        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          statusDoc.textContent = data.error || 'Erro ao enviar documento.';
          statusDoc.className = 'msg error';
          return;
        }

        hasDoc = true;
        statusDoc.textContent = 'Documento enviado com sucesso.';
        statusDoc.className = 'msg sucesso';
        atualizarEstadoBotao();

      } catch (e) {
        console.error(e);
        statusDoc.textContent = 'Falha na comunicação ao enviar documento.';
        statusDoc.className = 'msg error';
      }
    });
  }




  if (!token) {
    tituloPrincipal.textContent = 'Link inválido';
    subtitulo.textContent = 'O link de assinatura informado é inválido.';
    return;
  }

  // marcar checkbox: mostra/esconde quadro de assinatura 
  chkConcordo.addEventListener('change', () => {
    if (chkConcordo.checked) {
      signatureWrapper.style.display = 'block';
    } else {
      signatureWrapper.style.display = 'none';
      limparAssinatura();
    }
    setMensagem('', '');
    // ✅ reavalia o botão sempre que marcar/desmarcar
    atualizarEstadoBotao();
  });


  // carregar info do token
  fetch('https://apisec.secauxiliar.com.br/digisign/sign_info.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) {
      tituloPrincipal.textContent = 'Não foi possível carregar o documento';
      subtitulo.textContent = data.error || 'Verifique com o remetente se o link ainda é válido.';
      return;
    }

    conteudo.style.display = 'block';
    tituloPrincipal.textContent = 'Assinatura de documento';
    subtitulo.textContent = 'Confira os dados abaixo antes de confirmar a assinatura.';

    const d = data.destinatario;
    const e = data.envelope;

    destNome.textContent = d.nome;
    destEmail.textContent = d.email;
    envTitulo.textContent = e.titulo;
    destStatus.textContent = statusLabel(d.status);
     // flags de verificação (vêm do sign_info.php)
    mustSelfie = !!e.require_selfie;
    mustDoc    = !!e.require_doc_photo;
    hasSelfie  = !!d.selfie_uploaded;
    hasDoc     = !!d.doc_uploaded;

    configurarVerificacao();

    const arquivos = data.arquivos || [];

    // lista simples com os nomes
    if (arquivos.length) {
      listaDocs.innerHTML = '';
      arquivos.forEach((arq, idx) => {
        const div = document.createElement('div');
        div.className = 'doc-item';
        div.textContent = (idx + 1) + '. ' + arq.nome;
        listaDocs.appendChild(div);
      });
    } else {
      listaDocs.innerHTML = '<div style="font-size:13px;color:#6b7280;">Nenhum arquivo encontrado.</div>';
    }

    // monta os PDFs empilhados
    if (arquivos.length) {
      pdfContainer.innerHTML = '';
      arquivos.forEach((arq) => {
        const card = document.createElement('div');
        card.className = 'pdf-card';
        const src = arq.url + '#toolbar=0&view=FitH';
        card.innerHTML = '<iframe class="pdf-frame" src="' + src + '" title="Documento PDF"></iframe>';
        pdfContainer.appendChild(card);
      });
    } else {
      pdfContainer.innerHTML = '<p style="font-size:13px;color:#6b7280;">Nenhum PDF disponível para visualização.</p>';
    }

    // se já assinado, não mostra área de assinatura
    if (d.status === 'signed') {
      areaAssinatura.style.display = 'none';
      areaJaAssinado.style.display = 'block';
    } else {
      chkConcordo.disabled = true;
      leituraLiberada = false;
      window.addEventListener('scroll', verificarScrollLeitura);
      initSignaturePad();
      atualizarEstadoBotao();
    }
  })
  .catch(err => {
    console.error(err);
    tituloPrincipal.textContent = 'Erro ao carregar dados';
    subtitulo.textContent = 'Tente novamente em alguns instantes.';
  });

    // clicar em "Assinar documento"
  btnAssinar.addEventListener('click', () => {
    if (btnAssinar.disabled) return;

    if (!chkConcordo.checked) {
      setMensagem('Você precisa declarar que leu e concorda com o(s) documento(s).', 'error');
      return;
    }
    if (!assinaturaDataUrl) {
      setMensagem('Por favor, faça sua assinatura no quadro antes de confirmar.', 'error');
      return;
    }
    if (mustSelfie && !hasSelfie) {
      setMensagem('Envio de selfie é obrigatório para concluir a assinatura.', 'error');
      return;
    }
    if (mustDoc && !hasDoc) {
      setMensagem('Envio da foto do documento é obrigatório para concluir a assinatura.', 'error');
      return;
    }

    setMensagem('Registrando sua assinatura...', '');
    btnAssinar.disabled = true;

    fetch('https://apisec.secauxiliar.com.br/digisign/sign_confirm.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        token: token,
        signature: assinaturaDataUrl   // imagem da assinatura (PNG base64)
      })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        setMensagem(data.error || 'Não foi possível registrar a assinatura.', 'error');
        btnAssinar.disabled = false;
        return;
      }
      setMensagem('Documento assinado com sucesso. Obrigado!', 'sucesso');
      areaAssinatura.style.display = 'none';
      areaJaAssinado.style.display = 'block';
      destStatus.textContent = statusLabel('signed');
    })
    .catch(err => {
      console.error(err);
      setMensagem('Erro ao registrar assinatura. Tente novamente.', 'error');
      btnAssinar.disabled = false;
    });
  }); 
})();

</script>
</body>
</html>
