<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel • 3aSign</title>
  <!-- Favicon -->
  <link rel="icon" href="icone.ico" type="image/x-icon">
  <link rel="shortcut icon" href="icone.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root{
      --bg:#f3f4f6;
      --nav:#0b3b78;
      --nav-light:#1d4ed8;
      --card:#ffffff;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg);
      color:#0f172a;
    }
    .topbar{
      height:56px;
      background:var(--nav);
      color:#e5e7eb;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      box-shadow:0 2px 8px rgba(15,23,42,.45);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      letter-spacing:.02em;
    }
    .brand .logo-dot{
      width:26px;
      height:26px;
      border-radius:50%;
      background:#facc15;
      box-shadow:0 0 0 3px rgba(250,204,21,.4);
    }
    .brand span.sub{
      display:block;
      font-size:.7rem;
      opacity:.8;
    }
    .top-nav{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:.9rem;
    }
    .top-nav a{
      color:#e5e7eb;
      text-decoration:none;
      padding:6px 10px;
      border-radius:999px;
    }
    .top-nav a:hover{
      background:rgba(15,23,42,.35);
    }
    .top-user{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.8rem;
    }
    .chip-role{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(209,213,219,.7);
      font-size:.7rem;
    }
    .top-user button{
      background:transparent;
      border:1px solid rgba(248,250,252,.3);
      border-radius:999px;
      padding:4px 8px;
      color:#fee2e2;
      cursor:pointer;
      font-size:.75rem;
    }
    .top-user button:hover{
      background:rgba(248,250,252,.12);
    }
    main{
      max-width:1120px;
      margin:16px auto;
      padding:0 12px 24px;
    }
    .section-title{
      margin-top:8px;
      font-size:.95rem;
      color:var(--muted);
    }
    .cards{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
      margin-top:12px;
    }
    .card{
      background:var(--card);
      border-radius:12px;
      padding:14px 16px;
      box-shadow:0 1px 4px rgba(15,23,42,.1);
    }
    .card h2{
      margin:0 0 6px;
      font-size:1rem;
    }
    .card p{
      margin:0;
      font-size:.85rem;
      color:var(--muted);
    }
    .btn{
      display:inline-block;
      margin-top:10px;
      padding:8px 12px;
      border-radius:999px;
      border:none;
      background:var(--nav-light);
      color:#fff;
      font-size:.85rem;
      text-decoration:none;
      cursor:pointer;
    }
    .btn:hover{
      filter:brightness(1.05);
    }
    @media (max-width:600px){
      .top-nav{display:none;}
    }
  </style>
</head>
<body>
<header class="topbar">
  <div class="brand">
    <div class="logo-dot"></div>
    <div>
      3aSign
      <span class="sub">Painel de Assinaturas</span>
    </div>
  </div>

  <nav class="top-nav">
    <a href="admin.html">Início</a>
    <a href="envelope_novo.html">Novo Envelope</a>
    <a href="envelopes_lista.html">Meus Envelopes</a>
    <a href="relatorios.html">Relatórios</a>
    <a href="config.html">Configurações</a>
  </nav>

  <div class="top-user">
    <span id="userNome">Usuário</span>
    <span id="userRole" class="chip-role">role</span>
    <button id="btnSair">Sair</button>
  </div>
</header>

<main>
  <h1 id="tituloBemVindo">Bem-vindo!</h1>
  <div class="section-title">Escolha uma das opções abaixo para começar.</div>

  <div class="cards">
    <div class="card">
      <h2>Novo Envelope</h2>
      <p>Gerar um novo contrato para assinatura (anexar PDF ou usar um modelo pronto).</p>
      <a class="btn" href="envelope_novo.html">Criar envelope</a>
    </div>

    <div class="card">
      <h2>Meus Envelopes</h2>
      <p>Visualizar todos os envelopes criados por você, status de assinatura e downloads.</p>
      <a class="btn" href="envelopes_lista.html">Ver envelopes</a>
    </div>

    <div class="card">
      <h2>Relatórios</h2>
      <p>Resumo de contratos enviados, concluídos e pendentes por período.</p>
      <a class="btn" href="relatorios.html">Relatórios</a>
    </div>
  </div>
</main>

<script>
  const API_BASE = 'https://apisec.secauxiliar.com.br/digisign';

  function getToken() {
    return localStorage.getItem('zs_token');
  }

  function getUser() {
    const raw = localStorage.getItem('zs_user');
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function logoutToIndex() {
    localStorage.removeItem('zs_token');
    localStorage.removeItem('zs_user');
    window.location.href = 'index.html';
  }

  function ensureAuth() {
    const token = getToken();
    const user = getUser();
    if (!token || !user) {
      window.location.href = 'index.html';
      return null;
    }
    return { token, user };
  }

  async function fetchJson(url, opt = {}) {
    const r = await fetch(url, opt);
    const j = await r.json().catch(() => ({}));

    if (!r.ok) {
      // Trial expirado -> redireciona para contratação
      if (j && j.error === 'trial_expired') {
        const go = j.upgrade_url || 'contratar.html';
        alert('Seu período de teste terminou. Vamos para a contratação.');
        window.location.href = go;
        return null;
      }

      // Token inválido/expirado -> volta pro login
      if (r.status === 401) {
        logoutToIndex();
        return null;
      }

      throw new Error(j.message || j.error || 'Erro na API');
    }

    return j;
  }

  (async function init(){
    const auth = ensureAuth();
    if (!auth) return;

    const { token, user } = auth;

    // Preenche header (rápido) com dados do localStorage
    document.getElementById('userNome').textContent = user.nome;
    document.getElementById('userRole').textContent = user.role || 'usuário';
    document.getElementById('tituloBemVindo').textContent = 'Bem-vindo, ' + user.nome + '!';

    document.getElementById('btnSair').addEventListener('click', logoutToIndex);

    // ✅ Agora valida token no backend (e já barra TRIAL EXPIRADO)
    // Importante: esse endpoint precisa existir:
    //   https://apisec.secauxiliar.com.br/digisign/api/auth/me.php
    // Ele deve usar require_auth() por dentro.
    const me = await fetchJson(API_BASE + '/api/auth/me.php', {
      headers: { Authorization: 'Bearer ' + token }
    });

    if (!me) return; // já redirecionou (trial expirado ou logout)

    // Se o backend devolver user atualizado, atualiza o localStorage e o header
    const u = me.user || user;
    localStorage.setItem('zs_user', JSON.stringify(u));

    document.getElementById('userNome').textContent = u.nome;
    document.getElementById('userRole').textContent = u.role || 'usuário';
    document.getElementById('tituloBemVindo').textContent = 'Bem-vindo, ' + u.nome + '!';
  })();
</script>
</body>
</html>

