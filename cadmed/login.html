<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login • Agenda de Médicos</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root { --brand:#0b3b78; }
    body{ background:#f6f8fb; min-height:100vh; display:flex; align-items:center; }
    .card{ border-radius:14px }
    .brand{ color:var(--brand) }
    .btn-brand{ background:var(--brand) }
    .loader{ display:none; }
    .show{ display:inline-block !important; }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col s12 m6 l4 offset-m3 offset-l4">
        <div class="card z-depth-2">
          <div class="card-content">
            <span class="card-title brand">Agenda de Médicos</span>
            <p class="grey-text text-darken-1" style="margin-bottom:18px">Entre para cadastrar e consultar.</p>

            <div id="err" class="card-panel red lighten-4 red-text" style="display:none;border-radius:10px"></div>

            <form id="frmLogin" autocomplete="off">
              <div class="input-field">
                <input id="user" name="user" type="text" required />
                <label for="user">Usuário</label>
              </div>
              <div class="input-field">
                <input id="pass" name="pass" type="password" required />
                <label for="pass">Senha</label>
              </div>

              <button id="btnLogin" class="btn btn-brand waves-effect waves-light" style="width:100%">
                <span>Entrar</span>
                <span id="spin" class="loader preloader-wrapper small active" style="vertical-align:middle;margin-left:8px">
                  <div class="spinner-layer spinner-blue-only">
                    <div class="circle-clipper left"><div class="circle"></div></div>
                    <div class="gap-patch"><div class="circle"></div></div>
                    <div class="circle-clipper right"><div class="circle"></div></div>
                  </div>
                </span>
              </button>

              <div class="right-align" style="margin-top:10px">
                <a href="#" class="grey-text" onclick="M.toast({html:'Fale com o administrador.'})">Esqueci a senha</a>
              </div>
            </form>
          </div>
          <div class="card-action right-align">
            <small class="grey-text text-darken-1">© 3A Sistemas</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    (function(){
      const form   = document.getElementById('frmLogin');
      const errBox = document.getElementById('err');
      const btn    = document.getElementById('btnLogin');
      const spin   = document.getElementById('spin');

      const API_LOGIN = '/auth_login.php'; // ajuste o caminho se o backend estiver em outro domínio

      function setLoading(on){
        if(on){
          btn.setAttribute('disabled','disabled');
          spin.classList.add('show');
        }else{
          btn.removeAttribute('disabled');
          spin.classList.remove('show');
        }
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        errBox.style.display = 'none';
        setLoading(true);

        const payload = {
          user: document.getElementById('user').value.trim(),
          pass: document.getElementById('pass').value
        };

        try{
          const res = await fetch(API_LOGIN, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            // se o backend estiver em outro domínio e usar cookie de sessão:
            credentials: 'include',
            body: JSON.stringify(payload)
          });

          if(!res.ok){
            throw new Error('Falha na autenticação.');
          }

          const data = await res.json();

          if (data.ok){
            // Se o backend devolver redirect, usamos. Caso contrário, default: dashboard.php
            window.location.href = data.redirect || 'dashboard.php';
            return;
          }

          // erro amigável
          errBox.textContent = data.error || 'Usuário ou senha inválidos.';
          errBox.style.display = 'block';

        }catch(err){
          errBox.textContent = err.message || 'Não foi possível entrar agora.';
          errBox.style.display = 'block';
        }finally{
          setLoading(false);
        }
      });
    })();
  </script>
</body>
</html>
