<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CadMed • Início</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
  :root{ --brand:#0b3b78; }
  body{ background:#f6f8fb }
  .brand{ color:var(--brand) }
  .btn-brand{ background:var(--brand) }
  .fab{ position:fixed; right:24px; bottom:24px }
  .modal{ max-height: 92vh }
  .truncate { max-width: 280px; display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* --- alinhamento da tabela --- */
  table.striped td, table.striped th { vertical-align: middle; }
  th.actions-col, td.actions-col { width:110px; text-align:center; }
  td.actions-col a { margin: 0 6px; }
  td.actions-col i.material-icons { font-size: 20px; line-height: 20px; vertical-align: middle; }
</style>
</head>
<body>

  <nav class="white z-depth-0">
    <div class="nav-wrapper container">
      <a class="brand-logo brand" href="#!" style="font-size:1.4rem">CadMed</a>
      <ul class="right">
        <li><a id="who" class="grey-text text-darken-1" href="#!">Carregando...</a></li>
        <li><a id="btnLogout" class="grey-text text-darken-2" href="#!" title="Sair"><i class="material-icons">exit_to_app</i></a></li>
      </ul>
    </div>
  </nav>

  <main class="container" style="margin-top:22px">
    <!-- Filtros -->
    <div class="card z-depth-1">
      <div class="card-content">
        <span class="card-title">Pesquisar</span>
        <div class="row" id="filtros">
          <div class="input-field col s12 m3">
            <input id="f_nome" type="text" placeholder="Ex.: Ana">
            <label for="f_nome" class="active">Nome</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="f_crm" type="text" placeholder="CRM / Conselho / Nº">
            <label for="f_crm" class="active">CRM / Conselho</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="f_esp" type="text" placeholder="Ex.: Pediatria">
            <label for="f_esp" class="active">Especialidade</label>
          </div>
          <div class="input-field col s12 m3">
            <input id="f_inst" type="text" placeholder="Ex.: Santa Casa">
            <label for="f_inst" class="active">Instituição</label>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div class="card z-depth-1">
      <div class="card-content">
        <span class="card-title">Médicos</span>
        <div class="responsive-table">
          <table class="striped" id="tbl">
            <thead>
              <tr>
                <th>Nome</th>
                <th>Telefone</th>
                <th>E-mail</th>
                <th>Especialidade</th>
                <th class="center-align" style="width:110px">Ações</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- FAB adicionar (CADASTRAR) -->
  <div class="fixed-action-btn fab">
    <a class="btn-floating btn-large btn-brand modal-trigger" href="#mdlNovo" title="Novo médico">
      <i class="large material-icons">add</i>
    </a>
  </div>

  <!-- Modal CADASTRO -->
  <div id="mdlNovo" class="modal">
    <div class="modal-content">
      <h5 class="brand">Novo Médico</h5>
      <div class="row">
        <div class="input-field col s12 m6"><input id="nome" type="text" required><label for="nome">Nome*</label></div>
        <div class="input-field col s12 m6"><input id="especialidade" type="text"><label for="especialidade">Especialidade</label></div>
        <div class="input-field col s12 m3"><input id="conselho" type="text" placeholder="CRM / etc"><label for="conselho">Conselho</label></div>
        <div class="input-field col s12 m3"><input id="numero" type="text"><label for="numero">Número</label></div>
        <div class="input-field col s12 m3"><input id="telefone" type="text"><label for="telefone">Telefone</label></div>
        <div class="input-field col s12 m3"><input id="celular" type="text"><label for="celular">Celular</label></div>
        <div class="input-field col s12 m6"><input id="email" type="email"><label for="email">E-mail</label></div>
        <div class="input-field col s12 m6"><input id="hospital" type="text"><label for="hospital">Hospital</label></div>
        <div class="input-field col s12 m6"><input id="instituicao" type="text"><label for="instituicao">Instituição</label></div>
        <div class="input-field col s12 m6"><input id="cargo" type="text"><label for="cargo">Cargo</label></div>
        <div class="input-field col s12 m6"><input id="convenio" type="text"><label for="convenio">Convênio</label></div>
        <div class="input-field col s12 m6"><input id="data" type="date"><label for="data" class="active">Data</label></div>
        <div class="input-field col s12"><textarea id="obs" class="materialize-textarea" rows="3"></textarea><label for="obs">Observações</label></div>
      </div>
      <div id="err" class="card-panel red lighten-4 red-text" style="display:none;border-radius:10px"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Cancelar</a>
      <button id="btnSalvar" class="btn btn-brand">Salvar</button>
    </div>
  </div>

  <!-- Modal EDIÇÃO (ALTERAR) -->
  <div id="mdlEdit" class="modal">
    <div class="modal-content">
      <h5 class="brand">Editar Médico</h5>
      <input type="hidden" id="edit_id">
      <div class="row">
        <div class="input-field col s12 m6"><input id="edit_nome" type="text" required><label for="edit_nome">Nome*</label></div>
        <div class="input-field col s12 m6"><input id="edit_especialidade" type="text"><label for="edit_especialidade">Especialidade</label></div>
        <div class="input-field col s12 m3"><input id="edit_conselho" type="text" placeholder="CRM / etc"><label for="edit_conselho">Conselho</label></div>
        <div class="input-field col s12 m3"><input id="edit_numero" type="text"><label for="edit_numero">Número</label></div>
        <div class="input-field col s12 m3"><input id="edit_telefone" type="text"><label for="edit_telefone">Telefone</label></div>
        <div class="input-field col s12 m3"><input id="edit_celular" type="text"><label for="edit_celular">Celular</label></div>
        <div class="input-field col s12 m6"><input id="edit_email" type="email"><label for="edit_email">E-mail</label></div>
        <div class="input-field col s12 m6"><input id="edit_hospital" type="text"><label for="edit_hospital">Hospital</label></div>
        <div class="input-field col s12 m6"><input id="edit_instituicao" type="text"><label for="edit_instituicao">Instituição</label></div>
        <div class="input-field col s12 m6"><input id="edit_cargo" type="text"><label for="edit_cargo">Cargo</label></div>
        <div class="input-field col s12 m6"><input id="edit_convenio" type="text"><label for="edit_convenio">Convênio</label></div>
        <div class="input-field col s12 m6"><input id="edit_data" type="date"><label for="edit_data" class="active">Data</label></div>
        <div class="input-field col s12"><textarea id="edit_obs" class="materialize-textarea" rows="3"></textarea><label for="edit_obs">Observações</label></div>
      </div>
      <div id="edit_err" class="card-panel red lighten-4 red-text" style="display:none;border-radius:10px"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Cancelar</a>
      <button id="btnAtualizar" class="btn btn-brand">Salvar alterações</button>
    </div>
  </div>

  <!-- Modal CONFIRMAR EXCLUSÃO -->
  <div id="mdlDel" class="modal">
    <div class="modal-content">
      <h5 class="brand">Confirmar exclusão</h5>
      <p>Você tem certeza que deseja excluir o médico <b id="del_nome"></b>?</p>
      <input type="hidden" id="del_id">
      <div id="del_err" class="card-panel red lighten-4 red-text" style="display:none;border-radius:10px"></div>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Cancelar</a>
      <button id="btnExcluir" class="btn red">Excluir</button>
    </div>
  </div>

  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
  (function(){
    const EL = {
      who:  document.getElementById('who'),
      tbody:document.getElementById('tbody'),
      err:  document.getElementById('err'),
      btnSalvar: document.getElementById('btnSalvar'),
      btnLogout: document.getElementById('btnLogout'),
      // edição
      edit_err: document.getElementById('edit_err'),
      btnAtualizar: document.getElementById('btnAtualizar'),
      // exclusão
      del_err: document.getElementById('del_err'),
      btnExcluir: document.getElementById('btnExcluir'),
    };

    document.addEventListener('DOMContentLoaded', function(){
      M.Modal.init(document.querySelectorAll('.modal'));
      loadWho();
      loadTable();

      EL.btnSalvar.addEventListener('click', salvarMedico);
      EL.btnAtualizar.addEventListener('click', atualizarMedico);
      EL.btnExcluir.addEventListener('click', excluirMedico);
      EL.btnLogout.addEventListener('click', logout);

      // filtros: aplica ao digitar (debounce leve)
      ['f_nome','f_crm','f_esp','f_inst'].forEach(id=>{
        const i=document.getElementById(id);
        let t=null;
        i.addEventListener('input', ()=>{
          clearTimeout(t);
          t=setTimeout(loadTable, 300);
        });
      });
    });

    const API = {
      who:   'https://apisec.secauxiliar.com.br/cadmed/whoami.php',
      list:  'https://apisec.secauxiliar.com.br/cadmed/medicos_list.php',
      save:  'https://apisec.secauxiliar.com.br/cadmed/medicos_save.php',
      get:   'https://apisec.secauxiliar.com.br/cadmed/medicos_get.php',
      upd:   'https://apisec.secauxiliar.com.br/cadmed/medicos_update.php',
      del:   'https://apisec.secauxiliar.com.br/cadmed/medicos_delete.php',
      logout:'https://apisec.secauxiliar.com.br/cadmed/auth_logout.php'
    };

    function setErr(el,msg){
      if(!msg){ el.style.display='none'; return; }
      el.textContent = msg; el.style.display='block';
    }

    async function loadWho(){
      try{
        const r = await fetch(API.who, {credentials:'include'});
        const j = await r.json();
        if(j.ok) EL.who.textContent = 'Olá, ' + j.user.nome;
        else     EL.who.textContent = 'Não autenticado';
      }catch{ EL.who.textContent = 'Erro ao carregar'; }
    }

    function filtrosQuery(){
      const q = new URLSearchParams();
      const nome = v('#f_nome');
      const crm  = v('#f_crm');
      const esp  = v('#f_esp');
      const inst = v('#f_inst');
      if(nome) q.set('nome', nome);
      if(crm)  q.set('crm', crm);
      if(esp)  q.set('especialidade', esp);
      if(inst) q.set('instituicao', inst);
      return q.toString();
    }

    async function loadTable(){
      const qs = filtrosQuery();
      EL.tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
      try{
        const r = await fetch(API.list + (qs? ('?'+qs):''), {credentials:'include'});
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'Falha ao listar.');
        EL.tbody.innerHTML = (j.rows||[]).map(row=>`
        <tr data-id="${row.id||''}">
          <td><a href="#!" class="lnk-view">${escapeHtml(row.nome||'')}</a></td>
          <td class="truncate" title="${escapeHtml(row.telefone||'')}">${escapeHtml(row.telefone||'')}</td>
          <td class="truncate" title="${escapeHtml(row.email||'')}">${escapeHtml(row.email||'')}</td>
          <td class="truncate" title="${escapeHtml(row.especialidade||'')}">${escapeHtml(row.especialidade||'')}</td>
          <td class="actions-col">
            <a class="tooltipped btn-flat lnk-edit" data-tooltip="Editar" aria-label="Editar">
              <i class="material-icons">edit</i>
            </a>
            <a class="tooltipped btn-flat lnk-del" data-tooltip="Excluir" aria-label="Excluir">
              <i class="material-icons red-text">delete</i>
            </a>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="5">Sem registros.</td></tr>';

        // tooltips e binds
        const elems = document.querySelectorAll('.tooltipped'); M.Tooltip.init(elems);

        // ver/editar/excluir
        EL.tbody.querySelectorAll('.lnk-view').forEach(a=>{
          a.addEventListener('click', (ev)=>{
            ev.preventDefault();
            const id = a.closest('tr')?.dataset?.id;
            if(id) abrirEdicao(id, /*somentePreencher*/ false, /*editar*/ false, /*visualizar*/ true);
          });
        });
        EL.tbody.querySelectorAll('.lnk-edit').forEach(a=>{
          a.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            const id = a.closest('tr')?.dataset?.id;
            if(id) abrirEdicao(id, false, true, false);
          });
        });
        EL.tbody.querySelectorAll('.lnk-del').forEach(a=>{
          a.addEventListener('click', (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            const id = a.closest('tr')?.dataset?.id;
            if(id) abrirExclusao(id);
          });
        });
      }catch(e){
        console.error(e);
        EL.tbody.innerHTML = '<tr><td colspan="5">Erro ao carregar.</td></tr>';
      }
    }

    // ---------- CADASTRAR ----------
    async function salvarMedico(){
      setErr(EL.err,'');
      const payload = coleta('#mdlNovo');
      if(!payload.nome){ setErr(EL.err,'Informe o nome.'); return; }

      try{
        const r = await fetch(API.save, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error||'Falha ao salvar');
        M.toast({html:'Médico cadastrado!'});
        M.Modal.getInstance(document.getElementById('mdlNovo'))?.close();
        limpar('#mdlNovo'); loadTable();
      }catch(e){
        console.error(e);
        setErr(EL.err, e.message||'Erro ao salvar.');
      }
    }

    // ---------- EDITAR / VISUALIZAR ----------
    async function abrirEdicao(id, somentePreencher=false, editar=false, visualizar=false){
      setErr(EL.edit_err,'');
      try{
        const r = await fetch(API.get+'?id='+encodeURIComponent(id), {credentials:'include'});
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error||'Falha ao carregar dados.');
        preencher('#mdlEdit', j.row);
        document.getElementById('edit_id').value = j.row.id;

        // alterna modo somente leitura
        alternaReadonly('#mdlEdit', visualizar);

        const m = M.Modal.getInstance(document.getElementById('mdlEdit'));
        m?.open();
      }catch(e){
        console.error(e);
        setErr(EL.edit_err, e.message||'Erro ao carregar.');
      }
    }

    async function atualizarMedico(){
      setErr(EL.edit_err,'');
      const id = document.getElementById('edit_id').value;
      if(!id) return;

      const payload = coleta('#mdlEdit');
      payload.id = +id;

      if(!payload.nome){ setErr(EL.edit_err,'Informe o nome.'); return; }

      try{
        const r = await fetch(API.upd, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify(payload)
        });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error||'Falha ao atualizar');
        M.toast({html:'Alterações salvas!'});
        M.Modal.getInstance(document.getElementById('mdlEdit'))?.close();
        loadTable();
      }catch(e){
        console.error(e);
        setErr(EL.edit_err, e.message||'Erro ao atualizar.');
      }
    }

    // ---------- EXCLUIR ----------
    async function abrirExclusao(id){
      setErr(EL.del_err,'');
      try{
        const r = await fetch(API.get+'?id='+encodeURIComponent(id), {credentials:'include'});
        const j = await r.json();
        if(!j.ok) throw new Error(j.error||'Falha ao carregar.');
        document.getElementById('del_id').value = j.row.id;
        document.getElementById('del_nome').textContent = j.row.nome || '';
        M.Modal.getInstance(document.getElementById('mdlDel'))?.open();
      }catch(e){
        setErr(EL.del_err, e.message||'Erro ao carregar.');
      }
    }

    async function excluirMedico(){
      setErr(EL.del_err,'');
      const id = document.getElementById('del_id').value;
      if(!id) return;
      try{
        const r = await fetch(API.del, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          credentials:'include',
          body: JSON.stringify({ id: +id })
        });
        const j = await r.json();
        if(!r.ok || !j.ok) throw new Error(j.error||'Falha ao excluir');
        M.toast({html:'Excluído com sucesso!'});
        M.Modal.getInstance(document.getElementById('mdlDel'))?.close();
        loadTable();
      }catch(e){
        console.error(e);
        setErr(EL.del_err, e.message||'Erro ao excluir.');
      }
    }

    // ---------- Helpers ----------
    async function logout(){
      try{ await fetch(API.logout, {method:'POST', credentials:'include'}); }catch(e){}
      location.href = '/cadmed/login';
    }

    function coleta(ctx){
      const $ = (sel)=>document.querySelector(ctx+' '+sel);
      return {
        nome: v(ctx+' #nome, '+ctx+' #edit_nome'),
        especialidade: v(ctx+' #especialidade, '+ctx+' #edit_especialidade'),
        conselho: v(ctx+' #conselho, '+ctx+' #edit_conselho'),
        numero: v(ctx+' #numero, '+ctx+' #edit_numero'),
        telefone: v(ctx+' #telefone, '+ctx+' #edit_telefone'),
        celular: v(ctx+' #celular, '+ctx+' #edit_celular'),
        email: v(ctx+' #email, '+ctx+' #edit_email'),
        hospital: v(ctx+' #hospital, '+ctx+' #edit_hospital'),
        instituicao: v(ctx+' #instituicao, '+ctx+' #edit_instituicao'),
        cargo: v(ctx+' #cargo, '+ctx+' #edit_cargo'),
        convenio: v(ctx+' #convenio, '+ctx+' #edit_convenio'),
        data: v(ctx+' #data, '+ctx+' #edit_data'),
        obs: v(ctx+' #obs, '+ctx+' #edit_obs')
      };
    }

    function preencher(ctx, row){
      const map = {
        '#edit_nome':'nome', '#edit_especialidade':'especialidade', '#edit_conselho':'conselho', '#edit_numero':'numero',
        '#edit_telefone':'telefone', '#edit_celular':'celular', '#edit_email':'email', '#edit_hospital':'hospital',
        '#edit_instituicao':'instituicao', '#edit_cargo':'cargo', '#edit_convenio':'convenio', '#edit_data':'data', '#edit_obs':'obs'
      };
      for(const sel in map){
        const el = document.querySelector(sel);
        if(!el) continue;
        el.value = row[map[sel]] ?? '';
      }
      M.updateTextFields();
    }

    function alternaReadonly(ctx, on){
      document.querySelectorAll(ctx+' input,'+ctx+' textarea').forEach(el=>{
        el.readOnly = !!on;
      });
      document.getElementById('btnAtualizar').style.display = on ? 'none' : 'inline-block';
    }

    function limpar(ctx){
      document.querySelectorAll(ctx+' input,'+ctx+' textarea').forEach(i=>i.value='');
      M.updateTextFields();
    }

    function v(sel){ const el=document.querySelector(sel); return el?el.value.trim():''; }
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  })();
  </script>
</body>
</html>
