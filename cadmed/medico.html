<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CadMed • Médico</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Opcional: evitar indexação por buscadores -->
  <meta name="robots" content="noindex, nofollow">

  <style>
    :root{ --brand:#0b3b78 }
    body{ background:#f6f8fb }
    .brand{ color:var(--brand) }
    .btn-brand{ background:var(--brand) }
    .card{ border-radius:14px }
    .chip.k{ background:#e3f2fd }
    .topbar{ padding:12px 0 }
    .field-row { display:flex; gap:8px; align-items:flex-start; margin:6px 0 }
    .field-row i { font-size:18px; line-height:22px; color:#607d8b }
    .field-row span { line-height:22px }
    .footer-actions{ display:flex; gap:8px; flex-wrap:wrap }
    .small-note{ font-size:.9rem; color:#78909c }
  </style>
</head>
<body>
  <nav class="white z-depth-0 topbar">
    <div class="nav-wrapper container">
      <a class="brand-logo brand" href="/cadmed/" style="font-size:1.2rem">
        <i class="material-icons left" style="font-size:22px;margin-right:6px">local_hospital</i>CadMed
      </a>
    </div>
  </nav>

  <main class="container" style="margin-top:18px">
    <div id="box" class="card z-depth-2" style="display:none;">
      <div class="card-content">
        <span id="titulo" class="card-title"></span>
        <p id="crm" class="grey-text text-darken-1"></p>
        <div class="divider" style="margin:10px 0 16px"></div>

        <div id="fields">
          <!-- preenchido via JS -->
        </div>
      </div>
      <div class="card-action footer-actions">
        <a id="btnWhats" class="btn btn-brand"><i class="material-icons left">chat</i>WhatsApp</a>
        <a id="btnEmail" class="btn"><i class="material-icons left">email</i>E-mail</a>
        <a id="btnVcf" class="btn"><i class="material-icons left">contact_mail</i>vCard</a>
        <a id="btnPrint" class="btn-flat"><i class="material-icons left">print</i>Imprimir</a>
      </div>
    </div>

    <div id="msg" class="card-panel yellow lighten-4 grey-text text-darken-2" style="display:none;border-radius:12px"></div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  
  <script>
(async function(){
  const EL = {
    box: document.getElementById('box'),
    msg: document.getElementById('msg'),
    titulo: document.getElementById('titulo'),
    crm: document.getElementById('crm'),
    fields: document.getElementById('fields'),
    btnWhats: document.getElementById('btnWhats'),
    btnEmail: document.getElementById('btnEmail'),
    btnVcf: document.getElementById('btnVcf'),
    btnPrint: document.getElementById('btnPrint'),
  };

  // === usa token público ?share=... ===
  const share = (new URLSearchParams(location.search)).get('share');
  if(!share){ return showMsg('Link inválido ou expirado.'); }

  const API_PUBLIC = `https://apisec.secauxiliar.com.br/cadmed/medicos_public.php?share=${encodeURIComponent(share)}`;

  try{
    const r = await fetch(API_PUBLIC, { credentials: 'omit', cache: 'no-store' });
    const j = await r.json();
    if(!j.ok || !j.row) throw new Error(j.error || 'Falha ao carregar');

    const row = j.row;

    // Título e CRM abaixo
    EL.titulo.innerHTML = `${escapeHtml(row.nome||'')}
      ${row.especialidade ? `<span class="chip k">${escapeHtml(row.especialidade)}</span>` : ''}`;
    const crmTxt = [row.conselho, row.numero].filter(Boolean).join(' ').trim();
    EL.crm.textContent = crmTxt ? ` ${crmTxt}` : '';

    // Campos na ordem pedida (sem "Cargo")
    EL.fields.innerHTML = '';
    const items = [
      ['phone',  'Telefone',     row.telefone],
      ['smartphone','Celular',   row.celular],
      ['email',  'E-mail',       row.email],
      ['local_hospital','Hospital',     row.hospital],
      ['school', 'Instituição',  row.instituicao],
      ['badge',  'Convênio',     row.convenio],
      ['event',  'Data',         row.data],
      ['notes',  'Observações',  row.obs]
    ];
    items.forEach(([icon,label,value])=>{
      if(!value) return;
      const div = document.createElement('div');
      div.className = 'field-row';
      div.innerHTML = `<i class="material-icons">${icon}</i><span><b>${label}:</b> ${escapeHtml(value)}</span>`;
      EL.fields.appendChild(div);
    });

    // Ações
    const link = location.href.split('#')[0]; // mantém ?share= no link
    const texto = buildTexto(row, link);

    EL.btnWhats.onclick = ()=> window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank');
    EL.btnEmail.onclick = ()=>{
      const assunto = `Contato – ${row.nome||''}${row.especialidade ? ` (${row.especialidade})` : ''}`;
      location.href = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(texto)}`;
    };
    EL.btnVcf.onclick = ()=> downloadVcf(row);
    EL.btnPrint.onclick = ()=> window.print();

    EL.box.style.display = 'block';
    EL.msg.style.display = 'none';

  }catch(e){
    console.error(e);
    showMsg('Não foi possível carregar as informações deste médico.');
  }

  // Utils
  function showMsg(text){ EL.msg.textContent = text; EL.msg.style.display = 'block'; }
  function escapeHtml(s){
    return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  }
  function buildTexto(row, link){
    return [
      `Médico(a): ${row.nome||''}`,
      row.especialidade ? `Especialidade: ${row.especialidade}` : '',
      [row.conselho,row.numero].some(Boolean) ? `Conselho: ${(row.conselho||'')+' '+(row.numero||'')}`.trim() : '',
      row.telefone ? `Telefone: ${row.telefone}` : '',
      row.celular ? `Celular: ${row.celular}` : '',
      row.email ? `E-mail: ${row.email}` : '',
      row.hospital ? `Hospital: ${row.hospital}` : '',
      row.instituicao ? `Instituição: ${row.instituicao}` : '',
      row.convenio ? `Convênio: ${row.convenio}` : '',
      row.data ? `Data: ${row.data}` : '',
      row.obs ? `Observações: ${row.obs}` : '',
      '', `Saiba mais: ${link}`
    ].filter(Boolean).join('\n');
  }
  function downloadVcf(row){
    const nome =(row.nome||'').replace(/\n/g,' ').trim();
    const tel  =(row.celular||row.telefone||'').replace(/\s+/g,'').trim();
    const email=(row.email||'').trim();
    const titulo=(row.especialidade||'').trim();
    const nota = `Conselho: ${(row.conselho||'')+' '+(row.numero||'')}`.trim();
    const vcf = [
      'BEGIN:VCARD','VERSION:3.0',
      `N:${nome};;;;`,`FN:${nome}`,
      'ORG:CadMed',`TITLE:${titulo}`,
      tel?`TEL;TYPE=CELL:${tel}`:'',
      email?`EMAIL;TYPE=INTERNET:${email}`:'',
      `NOTE:${nota}`,'END:VCARD'
    ].filter(Boolean).join('\n');
    const blob=new Blob([vcf],{type:'text/vcard'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=`${(row.nome||'contato').replace(/\s+/g,'_')}.vcf`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
})();
</script>

</body>
</html>
