<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CadMed • Médico</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root{ --brand:#0b3b78 }
    body{ background:#f6f8fb }
    .brand{ color:var(--brand) }
    .card{ border-radius:14px }

    .k{ background:#e3f2fd; color:#0b3b78; border-radius:999px; padding:.18rem .6rem; font-size:.8rem }
    .field-row{ display:flex; gap:10px; align-items:flex-start; padding:.35rem 0 }
    .field-row i{ font-size:18px; width:22px; text-align:center; color:#546e7a; margin-top:2px }
    .actions{ display:flex; flex-wrap:wrap; gap:10px; padding:12px 16px; border-top:1px solid #eee; background:#fafafa; border-radius:0 0 14px 14px }
    .btn-small { text-transform:none }
    .skeleton{ background:linear-gradient(90deg,#eee,#f6f6f6,#eee); height:14px; border-radius:8px; }
  </style>
</head>
<body>
  <nav class="white z-depth-0">
    <div class="nav-wrapper container">
      <a class="brand-logo brand" href="#!" style="font-size:1.2rem">CadMed • Perfil Público</a>
    </div>
  </nav>

  <main class="container" style="margin-top:28px">
    <div id="box" class="card">
      <div class="card-content">
        <span class="card-title">Carregando...</span>
        <div class="skeleton" style="width:60%;margin:10px 0"></div>
        <div class="skeleton" style="width:40%;margin:10px 0"></div>
        <div class="skeleton" style="width:75%;margin:10px 0"></div>
      </div>
    </div>
    <p class="grey-text" style="margin:10px 4px">Este link é somente leitura e pode expirar.</p>
  </main>

  <script>
  (async function(){
    const qs = new URLSearchParams(location.search);
    const share = qs.get('share') || '';

    const BOX = document.getElementById('box');
    const API_PUBLIC = 'https://apisec.secauxiliar.com.br/cadmed/medicos_public.php?share=' + encodeURIComponent(share);

    if(!share){
      BOX.innerHTML = cardMsg('Link inválido.');
      return;
    }

    try{
      const r = await fetch(API_PUBLIC, { credentials:'omit' });
      const j = await r.json();
      if(!j.ok || !j.row) throw new Error(j.error||'Falha');

      render(j.row);
    }catch(e){
      console.warn(e);
      BOX.innerHTML = cardMsg('Não foi possível carregar as informações deste médico.');
    }

    function render(m){
      const nome  = esc(m.nome||'Médico');
      const esp   = esc(m.especialidade||'');
      const crm   = [m.conselho, m.numero].filter(Boolean).join(' ');
      const link  = location.href.split('#')[0];
      const texto = buildTexto(m, link);

      BOX.innerHTML = `
        <div class="card-content">
          <span class="card-title" id="titulo">${nome} ${esp?`<span class="k">${esp}</span>`:''}</span>
          ${crm ? `<p class="grey-text text-darken-1" id="crm">${esc(crm)}</p>` : ''}
          <div class="divider" style="margin:10px 0 16px"></div>

          <div id="fields">
            ${field('phone', 'Telefone', m.telefone)}
            ${field('phone', 'Celular', m.celular)}
            ${field('email', 'E-mail', m.email)}
            ${field('local_hospital', 'Hospital', m.hospital)}
            ${field('school', 'Instituição', m.instituicao)}
            ${field('work', 'Cargo', m.cargo)}
            ${field('assignment_ind', 'Convênio', m.convenio)}
            ${field('event', 'Data', m.data)}
            ${field('notes', 'Observações', m.obs)}
          </div>
        </div>

        <div class="actions">
          <a class="btn btn-small" id="btnWhats"><i class="material-icons left">chat</i>WhatsApp</a>
          <a class="btn btn-small green" id="btnEmail"><i class="material-icons left">email</i>E-mail</a>
          <a class="btn btn-small amber darken-2" id="btnVcf"><i class="material-icons left">contact_mail</i>vCard</a>
          <a class="btn btn-small grey darken-1" id="btnPrint"><i class="material-icons left">print</i>Imprimir</a>
        </div>
      `;

      // ações
      document.getElementById('btnWhats').onclick = ()=> {
        window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`,'_blank');
      };
      document.getElementById('btnEmail').onclick = ()=> {
        const assunto = `Contato – ${m.nome||''} (${m.especialidade||''})`;
        location.href = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(texto)}`;
      };
      document.getElementById('btnVcf').onclick = ()=> downloadVcf(m);
      document.getElementById('btnPrint').onclick = ()=> window.print();
    }

    // helpers de UI
    function field(icon, label, val){
      if(!val) return '';
      return `<div class="field-row"><i class="material-icons">${icon}</i><span><b>${esc(label)}:</b> ${esc(val)}</span></div>`;
    }
    function cardMsg(msg){
      return `
        <div class="card-content">
          <div class="card-panel yellow lighten-4">${esc(msg)}</div>
        </div>`;
    }
    function esc(s){
      return String(s||'')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // ===== Texto e vCard =====
    function buildTexto(row, link){
      return [
        `Médico(a): ${row.nome||''}`,
        `Especialidade: ${row.especialidade||''}`,
        `Conselho: ${(row.conselho||'')+' '+(row.numero||'')}`.trim(),
        `Telefone: ${row.telefone||''}`,
        `Celular: ${row.celular||''}`,
        `E-mail: ${row.email||''}`,
        `Hospital: ${row.hospital||''}`,
        `Instituição: ${row.instituicao||''}`,
        `Cargo: ${row.cargo||''}`,
        `Convênio: ${row.convenio||''}`,
        row.data ? `Data: ${row.data}` : '',
        row.obs ? `Obs.: ${row.obs}` : '',
        '',
        `Saiba mais: ${link}`
      ].filter(Boolean).join('\n');
    }

    function downloadVcf(row){
      const nome = (row.nome||'').replace(/\n/g,' ').trim();
      const tel  = (row.celular||row.telefone||'').replace(/\s+/g,'').trim();
      const email= (row.email||'').trim();
      const titulo = (row.especialidade||'').trim();
      const nota = `Conselho: ${row.conselho||''} ${row.numero||''} | Hospital: ${row.hospital||''} | Inst.: ${row.instituicao||''} | Cargo: ${row.cargo||''} | Convênio: ${row.convenio||''}`.trim();

      const vcf = [
        'BEGIN:VCARD','VERSION:3.0',
        `N:${nome};;;;`,`FN:${nome}`,
        'ORG:CadMed',`TITLE:${titulo}`,
        tel   ? `TEL;TYPE=CELL:${tel}` : '',
        email ? `EMAIL;TYPE=INTERNET:${email}` : '',
        `NOTE:${nota}`,
        'END:VCARD'
      ].filter(Boolean).join('\n');

      const blob = new Blob([vcf], {type:'text/vcard'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(row.nome||'contato').replace(/\s+/g,'_')}.vcf`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
  })();
  </script>
</body>
</html>
