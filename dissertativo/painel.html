<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Dissertativo • Lançamento de Notas</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Ícones -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --bg:#f7f8fb;
      --card:#ffffff;
      --line:#e9edf3;
      --ink:#0f172a;
      --muted:#6b7280;
      --primary:#0b3b78;
      --accent:#2563eb;
      --radius:14px;
      --ok:#0f766e;
      --bad:#b91c1c;
    }

    body{
      background:var(--bg);
      font-family:system-ui, Arial;
      padding:24px;
    }

    /* ===== Topbar ===== */
    header.topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:var(--primary); color:#fff;
      display:flex; align-items:center; z-index:10;
      padding:0 24px;
      box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    header.topbar .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 0;
    }
    header.topbar h5{
      margin:0; font-weight:700;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:1.05rem;
    }
    header.topbar .right-actions{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
    }
    .chip-user{
      background: rgba(255,255,255,.14);
      color:#fff;
      border: 1px solid rgba(255,255,255,.18);
      height: 32px;
      display:flex;
      align-items:center;
      border-radius: 999px;
      padding: 0 12px;
      gap: 8px;
      font-weight: 600;
      max-width: 52vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .btn-logout{
      border-radius:999px;
      background: rgba(255,255,255,.15);
      box-shadow:none;
    }
    .btn-logout:hover{ background: rgba(255,255,255,.22); }

    .wrap{
      max-width:1100px;
      margin:96px auto 0;
    }

    .panel-card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      border:1px solid var(--line);
    }

    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:#eef2ff;
      color:var(--primary);
      font-weight:700;
      font-size:.85rem;
    }

    .msgline{
      margin-top:8px;
      font-weight:700;
      font-size:.95rem;
    }
    .msg-ok{ color: var(--ok); }
    .msg-bad{ color: var(--bad); }

    /* bloco fixo */
    .sticky{
      position: sticky;
      top: 76px; /* abaixo da topbar fixa */
      z-index: 5;
    }

    .subtle{
      color: var(--muted);
      font-size: .9rem;
    }

    .row.tight { margin-bottom: 0; }
    .row.tight .col { margin-bottom: 0; }

    .card-soft{
      background:#fff;
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,.05);
    }

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: .85rem;
      font-weight: 700;
      color: #0f172a;
    }

    /* lista de sugestões (busca por nome) */
    .suggest{
      position: relative;
    }
    .suggest-list{
      position:absolute;
      top: 100%;
      left:0; right:0;
      background:#fff;
      border:1px solid var(--line);
      border-radius: 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,.14);
      overflow:hidden;
      max-height: 320px;
      overflow-y: auto;
      display:none;
      z-index: 20;
    }
    .suggest-item{
      padding: 10px 12px;
      cursor:pointer;
      border-bottom:1px solid #f1f5f9;
    }
    .suggest-item:hover{
      background:#f8fafc;
    }
    .suggest-item b{ display:block; color:#111827; }
    .suggest-item small{ color: var(--muted); }

    @media (max-width: 600px){
      body{ padding:16px; }
      header.topbar{ padding:0 14px; }
      .wrap{ margin-top:86px; }
      .sticky{ top: 70px; }
    }
  </style>
</head>

<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <img src="/optativos/logo-mini.png" alt="Logo" style="height:28px;">
      <h5>Dissertativo • Lançamento de Notas</h5>
    </div>

    <div class="right-actions">
      <div class="chip-user" id="chipUser" title="Usuário">
        <i class="material-icons" style="font-size:18px;">person</i>
        <span id="userName">Carregando...</span>
      </div>
      <a class="btn btn-small btn-logout white-text" href="https://apisec.secauxiliar.com.br/dissertativo/logout.php">
        <i class="material-icons left">logout</i>Sair
      </a>
    </div>
  </header>

  <div class="wrap">

    <!-- Status -->
    <div class="panel-card" style="padding:16px; margin-bottom:14px;">
      <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
        <div style="display:flex; gap:10px; align-items:flex-start; flex:1 1 auto;">
          <i class="material-icons" style="color:var(--primary); margin-top:2px;">fact_check</i>
          <div>
            <div style="font-weight:900; color:#111827;">Lançamento rápido</div>
            <div class="subtle">
              Preencha o cabeçalho (<b>Simulado / Data / Disciplina</b>) e lance as notas por matrícula.
              Dica: após salvar, use <span class="kbd">Enter</span> para ir pro próximo.
            </div>
          </div>
        </div>
        <div style="flex:0 0 auto;">
          <span class="pill"><i class="material-icons" style="font-size:18px;">shield</i>Área restrita</span>
        </div>
      </div>
      <div id="msgTop" class="msgline"></div>
    </div>

    <!-- Cabeçalho FIXO (simulado/data/disciplina) -->
    <div class="panel-card sticky" style="padding:14px 14px 6px; margin-bottom:14px;">
      <div class="row tight" style="margin-bottom:8px;">
        <div class="col s12 m4">
          <label style="font-weight:800; color:#111827;">Simulado</label>
          <select id="simulado" class="browser-default">
            <option value="" selected>Selecione...</option>
            <option value="MEDICINA">MEDICINA</option>
            <option value="BIOLOGICAS">BIOLOGICAS</option>
            <option value="EXATAS">EXATAS</option>
            <option value="HUMANAS">HUMANAS</option>
            <option value="FUVEST">FUVEST</option>
            <option value="UNICAMP">UNICAMP</option>
            <option value="UNESP">UNESP</option>
            <option value="UNIFESP">UNIFESP</option>
          </select>
        </div>

        <div class="col s12 m4">
          <label style="font-weight:800; color:#111827;">Data da prova</label>
          <input id="data_prova" type="date" style="margin-top:6px;">
        </div>

        <div class="col s12 m4">
          <label style="font-weight:800; color:#111827;">Disciplina</label>
          <select id="disciplina" class="browser-default">
            <option value="" selected>Selecione...</option>
            <option value="PORTUGUES">PORTUGUES</option>
            <option value="MATEMATICA">MATEMATICA</option>
            <option value="HISTORIA">HISTORIA</option>
            <option value="GEOGRAFIA">GEOGRAFIA</option>
            <option value="FISICA">FISICA</option>
            <option value="QUIMICA">QUIMICA</option>
            <option value="BIOLOGIA">BIOLOGIA</option>
            <option value="INGLES">INGLES</option>
            <option value="FILOSOFIA">FILOSOFIA</option>
            <option value="SOCIOLOGIA">SOCIOLOGIA</option>
            <option value="LINGUAGEM">LINGUAGEM</option>
            <option value="HUMANAS">HUMANAS</option>
            <option value="NATUREZA">NATUREZA</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding-bottom:10px;">
        <a class="btn-small waves-effect" id="btnTravar" style="border-radius:999px;">
          <i class="material-icons left">lock</i>Travar cabeçalho
        </a>

        <a class="btn-small waves-effect grey lighten-1" id="btnDestravar" style="border-radius:999px; display:none;">
          <i class="material-icons left">lock_open</i>Descongelar
        </a>

        <span class="subtle" id="headerHint">
          Preencha o cabeçalho e clique em <b>Travar</b>.
        </span>

        <span class="subtle" style="margin-left:auto;">
          Status: <b id="headerStatus">Aguardando</b>
        </span>
      </div>
    </div>

    <!-- Lançamento -->
    <div class="row">
      <div class="col s12 l7">
        <div class="card-soft" style="padding:14px;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
            <div>
              <div style="font-weight:900; color:#111827; font-size:1.05rem;">Cadastrar nota</div>
              <div class="subtle">Escolha a forma: matrícula (rápido) ou busca por nome.</div>
            </div>
            <span class="pill"><i class="material-icons" style="font-size:18px;">edit</i>NOTAS_DISSERTATIVAS</span>
          </div>

          <div style="margin-top:10px;">
            <ul class="tabs" id="tabs">
              <li class="tab col s6"><a class="active" href="#tabMat">Por matrícula</a></li>
              <li class="tab col s6"><a href="#tabNome">Por nome</a></li>
            </ul>
          </div>

          <!-- TAB MATRÍCULA -->
          <div id="tabMat" style="padding-top:12px;">
            <div class="row">
              <div class="col s12 m6">
                <label style="font-weight:800; color:#111827;">Matrícula</label>
                <input id="matricula" inputmode="numeric" placeholder="Ex.: 123456" autocomplete="off">
              </div>
              <div class="col s12 m6">
                <label style="font-weight:800; color:#111827;">Nota</label>
                <input id="nota" inputmode="decimal" placeholder="Ex.: 7,50" autocomplete="off">
              </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <a class="btn waves-effect" id="btnSalvarMat" style="border-radius:12px;">
                <i class="material-icons left">save</i>Salvar
              </a>
              <span class="subtle">Atalho: <span class="kbd">Enter</span> no campo Nota</span>
            </div>

            <div id="msgMat" class="msgline"></div>
          </div>

          <!-- TAB NOME -->
          <div id="tabNome" style="padding-top:12px;">
            <div class="row">
              <div class="col s12">
                <label style="font-weight:800; color:#111827;">Pesquisar aluno</label>
                <div class="suggest">
                  <input id="nomeBusca" placeholder="Digite parte do nome..." autocomplete="off">
                  <div id="listSug" class="suggest-list"></div>
                </div>
                <div class="subtle" style="margin-top:6px;">
                  Digite 3+ letras para aparecer a lista. Clique no aluno para selecionar.
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col s12 m6">
                <label style="font-weight:800; color:#111827;">Matrícula selecionada</label>
                <input id="matSel" disabled placeholder="—">
              </div>
              <div class="col s12 m6">
                <label style="font-weight:800; color:#111827;">Nota</label>
                <input id="notaNome" inputmode="decimal" placeholder="Ex.: 8,00" autocomplete="off">
              </div>
            </div>

            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <a class="btn waves-effect" id="btnSalvarNome" style="border-radius:12px;">
                <i class="material-icons left">save</i>Salvar
              </a>
            </div>

            <div id="msgNome" class="msgline"></div>
          </div>

        </div>
      </div>

      <!-- Painel do aluno -->
      <div class="col s12 l5">
        <div class="card-soft" style="padding:14px; min-height: 210px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <i class="material-icons" style="color:var(--primary);">account_circle</i>
            <div>
              <div style="font-weight:900; color:#111827;">Aluno</div>
              <div class="subtle">Dados buscados em <b>alunos_curso</b>.</div>
            </div>
          </div>

          <div style="margin-top:12px;">
            <div class="subtle">Nome</div>
            <div id="al_nome" style="font-weight:900; font-size:1.06rem; color:#111827;">—</div>

            <div style="display:flex; gap:14px; flex-wrap:wrap; margin-top:10px;">
              <div style="flex:1 1 45%;">
                <div class="subtle">Unidade</div>
                <div id="al_unidade" style="font-weight:800;">—</div>
              </div>
              <div style="flex:1 1 45%;">
                <div class="subtle">Turma</div>
                <div id="al_turma" style="font-weight:800;">—</div>
              </div>
              <div style="flex:1 1 45%; margin-top:8px;">
                <div class="subtle">Matrícula</div>
                <div id="al_mat" style="font-weight:900;">—</div>
              </div>
            </div>
          </div>

          <div style="margin-top:12px; border-top:1px solid var(--line); padding-top:10px;">
            <div class="subtle">Último lançamento</div>
            <div id="lastSave" style="font-weight:900; color:#111827;">—</div>
          </div>
        </div>

        <div style="text-align:center; color:var(--muted); font-size:.9rem; padding:10px 0 18px;">
          Dissertativo • 3A Sistemas
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    // =========================
    // CONFIG
    // =========================
    const API = 'https://apisec.secauxiliar.com.br/dissertativo/';

    // Endpoints esperados (ajuste se seus nomes forem outros)
    const EP_ME        = API + 'auth_me.php';                 // GET -> {ok:true, user:{nome, nivel}}
    const EP_ALUNO_GET = API + 'aluno_get.php';               // GET ?matricula= -> {ok:true, aluno:{matricula,nome,nome_unidade,turma}}
    const EP_ALUNO_Q   = API + 'aluno_search.php';            // GET ?q=joao -> {ok:true, itens:[{matricula,nome,nome_unidade,turma}]}
    const EP_UPSERT    = API + 'notas_dissertativas_upsert.php'; // POST JSON

    // =========================
    // HELPERS
    // =========================
    const $ = (id)=>document.getElementById(id);

    function setTopMsg(text, ok=true){
      const el = $('msgTop');
      el.textContent = text || '';
      el.className = 'msgline ' + (ok ? 'msg-ok' : 'msg-bad');
    }

    function setMsg(elId, text, ok=true){
      const el = $(elId);
      el.textContent = text || '';
      el.className = 'msgline ' + (ok ? 'msg-ok' : 'msg-bad');
    }

    function toDecimal(val){
      // aceita 7,5 ou 7.5
      const v = String(val||'').trim().replace(',', '.');
      if(!v) return NaN;
      const n = Number(v);
      return Number.isFinite(n) ? n : NaN;
    }

    function lockHeader(isLocked){
      const sim = $('simulado');
      const dt  = $('data_prova');
      const dis = $('disciplina');

      sim.disabled = isLocked;
      dt.disabled  = isLocked;
      dis.disabled = isLocked;

      $('btnTravar').style.display = isLocked ? 'none' : '';
      $('btnDestravar').style.display = isLocked ? '' : 'none';

      $('headerStatus').textContent = isLocked ? 'Travado' : 'Aguardando';
      $('headerHint').innerHTML = isLocked
        ? 'Cabeçalho travado. Se precisar trocar, clique em <b>Descongelar</b>.'
        : 'Preencha o cabeçalho e clique em <b>Travar</b>.';

      // Materialize tabs reflow não precisa
    }

    function headerValid(){
      const sim = $('simulado').value.trim();
      const dt  = $('data_prova').value.trim();
      const dis = $('disciplina').value.trim();
      return (sim && dt && dis);
    }

    function clearAlunoCard(){
      $('al_nome').textContent = '—';
      $('al_unidade').textContent = '—';
      $('al_turma').textContent = '—';
      $('al_mat').textContent = '—';
    }

    function fillAlunoCard(a){
      $('al_nome').textContent   = a?.nome || '—';
      $('al_unidade').textContent= a?.nome_unidade || '—';
      $('al_turma').textContent  = a?.turma || '—';
      $('al_mat').textContent    = a?.matricula || '—';
    }

    async function apiGet(url){
      const r = await fetch(url, { credentials:'include' });
      const data = await r.json();
      if(!r.ok || !data.ok) throw new Error(data.msg || data.error || 'Falha na requisição');
      return data;
    }

    async function apiPost(url, body){
      const r = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        credentials:'include',
        body: JSON.stringify(body)
      });
      const data = await r.json();
      if(!r.ok || !data.ok) throw new Error(data.msg || data.error || 'Falha ao salvar');
      return data;
    }

    // =========================
    // BOOT
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
      M.Tabs.init(document.querySelectorAll('.tabs'));
      lockHeader(false);
      bootMe();
      wireUI();
    });

    async function bootMe(){
      try{
        const me = await apiGet(EP_ME);

        const nome = me?.user?.nome || me?.user?.name || 'Plantonista';
        const nivel = String(me?.user?.nivel || me?.user?.role || me?.user?.tipo || '').toLowerCase();

        $('userName').textContent = nome;

        // segurança extra no front: se não for plantonista, bloqueia
        if(nivel !== 'plantonista'){
          setTopMsg('Você não tem acesso a este sistema. (Apenas PLANTONISTA)', false);
          document.querySelector('.wrap').style.opacity = .35;
          document.querySelectorAll('input,select,button,a.btn').forEach(el=>{
            if(el.id !== 'chipUser') el.setAttribute('disabled','disabled');
          });
          return;
        }

        setTopMsg('Acesso liberado. Cabeçalho aguardando preenchimento.', true);

      }catch(err){
        console.error(err);
        setTopMsg('Sessão inválida ou expirada. Faça login novamente.', false);
      }
    }

    function wireUI(){
      $('btnTravar').addEventListener('click', () => {
        if(!headerValid()){
          setTopMsg('Preencha SIMULADO, DATA e DISCIPLINA antes de travar.', false);
          return;
        }
        lockHeader(true);
        setTopMsg('Cabeçalho travado. Pode lançar as notas.', true);
        $('matricula').focus();
      });

      $('btnDestravar').addEventListener('click', () => {
        lockHeader(false);
        setTopMsg('Cabeçalho descongelado. Ajuste e trave novamente.', true);
      });

      // fluxo matrícula
      $('matricula').addEventListener('keydown', async (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          await loadAlunoByMat();
          $('nota').focus();
        }
      });

      $('nota').addEventListener('keydown', async (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          await salvarPorMatricula();
        }
      });

      $('btnSalvarMat').addEventListener('click', salvarPorMatricula);

      // fluxo nome
      $('nomeBusca').addEventListener('input', debounce(onNomeInput, 220));
      document.addEventListener('click', (e)=>{
        if(!e.target.closest('.suggest')) hideSug();
      });

      $('btnSalvarNome').addEventListener('click', salvarPorNome);

      $('notaNome').addEventListener('keydown', async (e)=>{
        if(e.key === 'Enter'){
          e.preventDefault();
          await salvarPorNome();
        }
      });
    }

    // =========================
    // ALUNO GET
    // =========================
    async function loadAlunoByMat(){
      setMsg('msgMat','');
      clearAlunoCard();

      const mat = $('matricula').value.trim();
      if(!mat){
        setMsg('msgMat','Informe a matrícula.', false);
        return;
      }

      try{
        const data = await apiGet(EP_ALUNO_GET + '?matricula=' + encodeURIComponent(mat));
        fillAlunoCard(data.aluno);
        setMsg('msgMat','Aluno carregado.', true);
      }catch(err){
        console.error(err);
        setMsg('msgMat', err.message || 'Aluno não encontrado.', false);
      }
    }

    // =========================
    // SALVAR
    // =========================
    async function salvarPorMatricula(){
      setMsg('msgMat','');

      if(!$('data_prova').disabled){
        setMsg('msgMat','Trave o cabeçalho antes de lançar.', false);
        return;
      }

      const mat = $('matricula').value.trim();
      const nota = toDecimal($('nota').value);
      if(!mat){
        setMsg('msgMat','Informe a matrícula.', false);
        $('matricula').focus();
        return;
      }
      if(!Number.isFinite(nota)){
        setMsg('msgMat','Informe uma nota válida. Ex.: 7,50', false);
        $('nota').focus();
        return;
      }

      // garante que o card do aluno esteja preenchido (se não, busca)
      if($('al_mat').textContent === '—' || $('al_mat').textContent !== mat){
        await loadAlunoByMat();
        if($('al_mat').textContent === '—'){
          return; // erro já foi mostrado
        }
      }

      const payload = {
        matricula: Number(mat),
        simulado: $('simulado').value.trim(),
        data_prova: $('data_prova').value.trim(),
        disciplina: $('disciplina').value.trim(),
        nota: nota
      };

      try{
          const resp = await apiPost(EP_UPSERT, payload);

          if (resp.action === 'already') {
            const extra = (resp.nota_atual != null) ? ` (Nota atual: ${Number(resp.nota_atual).toFixed(2)})` : '';
            setMsg('msgMat', (resp.msg || 'Nota já lançada.') + extra, false);
            return; // não limpa campos, pra evitar perder a referência
          }

          setMsg('msgMat', resp.msg || 'Nota cadastrada com sucesso.', true);

        $('lastSave').textContent = `${payload.matricula} • ${payload.disciplina} • ${payload.nota.toFixed(2)} • ${payload.data_prova}`;

        // prepara próximo
        $('matricula').value = '';
        $('nota').value = '';
        clearAlunoCard();
        $('matricula').focus();

      }catch(err){
        console.error(err);
        setMsg('msgMat', err.message || 'Falha ao salvar.', false);
      }
    }

    async function salvarPorNome(){
      setMsg('msgNome','');

      if(!$('data_prova').disabled){
        setMsg('msgNome','Trave o cabeçalho antes de lançar.', false);
        return;
      }

      const mat = $('matSel').value.trim();
      const nota = toDecimal($('notaNome').value);

      if(!mat){
        setMsg('msgNome','Selecione um aluno na lista.', false);
        $('nomeBusca').focus();
        return;
      }
      if(!Number.isFinite(nota)){
        setMsg('msgNome','Informe uma nota válida. Ex.: 8,00', false);
        $('notaNome').focus();
        return;
      }

      const payload = {
        matricula: Number(mat),
        simulado: $('simulado').value.trim(),
        data_prova: $('data_prova').value.trim(),
        disciplina: $('disciplina').value.trim(),
        nota: nota
      };


          try{
          const resp = await apiPost(EP_UPSERT, payload);

          if (resp.action === 'already') {
            const extra = (resp.nota_atual != null) ? ` (Nota atual: ${Number(resp.nota_atual).toFixed(2)})` : '';
            setMsg('msgNome', (resp.msg || 'Nota já lançada.') + extra, false);
            return; // não limpa campos, pra evitar perder a referência
          }

          setMsg('msgNome', resp.msg || 'Nota cadastrada com sucesso.', true);



        $('lastSave').textContent = `${payload.matricula} • ${payload.disciplina} • ${payload.nota.toFixed(2)} • ${payload.data_prova}`;

        // limpa para próximo
        $('nomeBusca').value = '';
        $('matSel').value = '';
        $('notaNome').value = '';
        clearAlunoCard();
        hideSug();
        $('nomeBusca').focus();

      }catch(err){
        console.error(err);
        setMsg('msgNome', err.message || 'Falha ao salvar.', false);
      }
    }

    // =========================
    // BUSCA POR NOME (suggest)
    // =========================
    let lastQ = '';
    async function onNomeInput(){
      setMsg('msgNome','');
      const q = $('nomeBusca').value.trim();
      if(q.length < 3){
        hideSug();
        return;
      }
      if(q === lastQ) return;
      lastQ = q;

      try{
        const data = await apiGet(EP_ALUNO_Q + '?q=' + encodeURIComponent(q));
        renderSug(data.itens || []);
      }catch(err){
        console.error(err);
        hideSug();
      }
    }

    function renderSug(items){
      const box = $('listSug');
      box.innerHTML = '';
      if(!items.length){
        hideSug();
        return;
      }

      items.slice(0, 25).forEach(a=>{
        const div = document.createElement('div');
        div.className = 'suggest-item';
        div.innerHTML = `
          <b>${escapeHtml(a.nome || '')}</b>
          <small>${escapeHtml(String(a.matricula||''))} • ${escapeHtml(a.nome_unidade||'')} • ${escapeHtml(a.turma||'')}</small>
        `;
        div.addEventListener('click', ()=>{
          $('nomeBusca').value = a.nome || '';
          $('matSel').value = a.matricula || '';
          fillAlunoCard(a);
          hideSug();
          $('notaNome').focus();
        });
        box.appendChild(div);
      });

      box.style.display = 'block';
    }

    function hideSug(){
      $('listSug').style.display = 'none';
    }

    function debounce(fn, ms){
      let t;
      return (...args)=>{
        clearTimeout(t);
        t = setTimeout(()=>fn.apply(null,args), ms);
      };
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>