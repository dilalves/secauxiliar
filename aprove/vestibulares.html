<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Vestibulares ‚Ä¢ Aprove ‚Äî Confer√™ncia de Aprovados</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root {
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3;
      --ink:#0f172a; --muted:#6b7280;
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w:260px; --topbar-h:64px;
    }
    html, body {height:100%; margin:0; font-family:'Roboto', sans-serif; background:var(--bg);}
    body {color:var(--ink);}
    .app {display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}
    header.topbar { position:fixed; top:0; left:0; right:0; height:var(--topbar-h);
      z-index:20; background:var(--primary); color:#fff;
      display:flex; align-items:center; padding:0 24px;
      box-shadow:0 2px 10px rgba(16,24,40,.12);}
    aside { background:#fff; border-right:1px solid var(--line);
      position:sticky; top:var(--topbar-h); height:calc(100vh - var(--topbar-h));
      overflow:auto; z-index:6; padding-bottom:20px;}
    .menu {list-style:none; margin:0; padding:0 0 12px;}
    .menu a {display:block; padding:10px 22px; color:#111827;
      text-decoration:none; font-size:15px; transition:0.25s;}
    .menu a:hover {background:#f4f6fb; color:var(--primary);}
    .menu .active > a {background:#eef3ff; font-weight:600; color:var(--primary);}
    .menu-group {margin-bottom:12px;}
    .group-title {font-weight:700; color:#0b3b78; text-transform:uppercase;
      font-size:13px; letter-spacing:0.5px; padding:10px 20px 6px;
      border-top:1px solid #eef2f8;}
    main {display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page {padding:24px;}
    footer {text-align:center; font-size:13px; color:var(--muted); padding:16px 0 10px;}
    table.striped th {background:#f2f5ff; color:#0b3b78; font-weight:600;}
    .search-box {display:flex; align-items:center; gap:8px; margin-bottom:16px;}
    .search-box input {flex:1;}
    #modal-editar.modal, #modal-novo.modal { width:80% !important; max-height:90vh !important; overflow:hidden !important; }
    #modal-editar .modal-content, #modal-novo .modal-content { padding:24px 36px; height:calc(90vh - 70px); overflow-y:auto; }
    #modal-novo .modal-content { display: flex; flex-direction: column; height: 90vh; padding: 0; }
    #modal-novo h5 { padding: 24px 36px 12px; margin: 0; color: #0b3b78; font-weight: 600;
      background: #fff; position: sticky; top: 0; z-index: 20; border-bottom: 1px solid #e5e7eb; }
    #modal-novo .scroll-area { flex: 1; overflow-y: auto; padding: 16px 36px; }
    #modal-novo table thead { position: sticky; top: 0; background: #f2f5ff; z-index: 10;
      box-shadow: 0 2px 3px rgba(0,0,0,0.05);}
    #modal-novo table td { padding-top: 4px !important; padding-bottom: 4px !important; }
    #modal-novo .modal-footer { background: #fff; border-top: 1px solid #e5e7eb;
      position: sticky; bottom: 0; padding: 10px 24px; z-index: 20; }
    
    /* === MODAL DE CURSOS (APERFEI√áOADO) === */
    #modal-cursos.modal {
      width: 95% !important;          /* ocupa quase toda a tela */
      max-height: 95vh !important;    /* quase toda a altura vis√≠vel */
    }

    #modal-cursos .modal-content {
      padding: 20px 40px 100px;       /* espa√ßo para o rodap√© fixo */
      overflow-y: auto;
    }

    #modal-cursos h5 {
      margin-bottom: 20px;
      color: #0b3b78;
      font-weight: 600;
    }

    /* Cabe√ßalho fixo da tabela */
    #modal-cursos table thead {
      position: sticky;
      top: 0;
      background: #f2f5ff;
      z-index: 10;
      box-shadow: 0 2px 3px rgba(0,0,0,0.05);
    }

    /* Linhas compactas */
    #modal-cursos table td, 
    #modal-cursos table th {
      padding-top: 6px !important;
      padding-bottom: 6px !important;
      font-size: 14px;
    }

    /* Linha de inclus√£o mais leve */
    #modal-cursos .adicionar-curso {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 12px;
    }

    /* Mant√©m os campos e bot√£o na mesma linha */
    #modal-cursos .adicionar-curso .input-field {
      margin: 0;
    }
    #modal-cursos .adicionar-curso .col {
      padding-left: 6px;
      padding-right: 6px;
    }
    #modal-cursos .adicionar-curso button {
      margin-top: 12px;
    }


    /* Corrige encavalamento da label 'Sigla da Institui√ß√£o' */
    #modal-cursos #curso_siglainst_novo {
      color: #0b3b78;
      background: #f9fafb;
    }

    #modal-cursos label[for="curso_siglainst_novo"] {
      margin-top: -6px;
    }

    #modal-cursos .col.s3 input#curso_siglainst_novo {
      min-width: 180px;
    }

    /* Rodap√© fixo */
    #modal-cursos .modal-footer {
      background: #fff;
      border-top: 1px solid #e5e7eb;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px 30px;
      display: flex;
      justify-content: flex-end;
      z-index: 15;
    }

    #modal-cursos input:disabled {
      color: #555 !important;
      background-color: #f2f4f7 !important;
      border-bottom: 1px dashed #ccc !important;
    }

    /* Corrige posi√ß√£o e apar√™ncia de labels em campos somente leitura */
    .input-field input[readonly],
    .input-field input[disabled] {
      background-color: transparent;
      border-bottom: 1px solid #ccc;
      box-shadow: none;
      color: #0b3b78;
    }

    .input-field input[readonly]:focus {
      border-bottom: 1px solid #ccc;
      box-shadow: none;
    }

    .input-field input[readonly] + label,
    .input-field input[disabled] + label {
      top: -8px !important;       /* üîß ajustado de -18px para -8px */
      transform: scale(0.9);
      transform-origin: 0 0;
      color: #0b3b78;
      font-weight: 500;
      pointer-events: none;
    }
    
    @media (max-width:992px){.app{grid-template-columns:1fr;} aside{display:none;}}
  </style>
</head>

<body>
<div class="app">
  <aside>
    <div class="center" style="padding:18px 0 8px;">
      <span class="title" style="font-weight:700; color:#0b3b78">Aprove</span>
    </div>
    <ul class="menu">
      <li><a href="/aprove/painel.html">In√≠cio</a></li>
      <li class="menu-group">
        <div class="group-title">Atualiza√ß√µes</div>
        <ul>
          <li><a href="/aprove/aprovacoes.html">Aprova√ß√µes</a></li>
          <li><a href="/aprove/alunos.html">Alunos</a></li>
          <li><a href="/aprove/instituicoes.html">Institui√ß√µes</a></li>
          <li><a href="/aprove/cursos.html">Cursos</a></li>
          <li class="active"><a href="/aprove/vestibulares.html">Vestibulares</a></li>
          <li><a href="/aprove/unidades.html">Unidades</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" style="height:28px;">
          <h5 style="margin:0; font-weight:600;">Aprove ‚Äî Confer√™ncia de Aprovados</h5>
        </div>
        <a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">Sair</a>
      </div>
    </header>

    <section class="page">
      <h4 style="color:#0b3b78; font-weight:600;">Cadastro de Vestibulares</h4>
      <p class="grey-text text-darken-1">Pesquise vestibulares ou visualize todos.</p>

      <div class="card z-depth-0" style="padding:20px; margin-top:20px;">
        <div class="search-box">
          <input id="search" type="text" placeholder="Buscar por nome, institui√ß√£o ou ano..." oninput="buscarVestibulares()">
          <button class="btn blue darken-2" onclick="buscarVestibulares()">Buscar</button>
          <div class="right-align">
            <button class="btn green darken-1" onclick="abrirNovo()">+ Novo Vestibular</button>
          </div>
        </div>

        <table class="striped highlight responsive-table" id="tabela-lista">
          <thead>
            <tr>
              <th>ID</th>
              <th>Sigla</th>
              <th>Institui√ß√£o</th>
              <th>Ano</th>
              <th>Exclusivo</th>
              <th>Semestre</th>
              <th>Ativo</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="center grey-text" id="msg-status">Digite para buscar vestibulares.</p>
      </div>
    </section>

    <footer>Desenvolvido por 3A Sistemas ‚Äî Adilson Alves ¬© 2025</footer>
  </main>
</div>

<!-- MODAL EDITAR -->
<div id="modal-editar" class="modal">
  <div class="modal-content">
    <h5 style="color:#0b3b78;">Editar Vestibular</h5>
    <form id="form-editar">
      <div class="row">
        <!-- C√≥digo -->
        <div class="input-field col s2">
          <input id="id" name="id" type="text" readonly>
          <label class="active" for="id">C√≥digo</label>
        </div>

        <!-- Sigla -->
        <div class="input-field col s2">
          <input id="sigla" name="sigla" type="text" readonly>
          <label class="active" for="sigla">Sigla</label>
        </div>

        <!-- Institui√ß√£o -->
        <div class="input-field col s4">
          <select id="instituicao_id" name="instituicao_id"></select>
          <label>Institui√ß√£o</label>
        </div>

        <!-- Ano -->
        <div class="input-field col s2">
          <input id="listagem" name="listagem" type="number" min="2000" max="2100">
          <label for="listagem">Ano</label>
        </div>

        <!-- Semestre -->
        <div class="input-field col s2">
          <select id="semestre" name="semestre">
            <option value="1">1¬∫ Semestre</option>
            <option value="2">2¬∫ Semestre</option>
          </select>
          <label for="semestre">Semestre</label>
        </div>

        <!-- Exclusivo -->
        <div class="col s1 center-align" style="margin-top:25px;">
          <label>
            <input type="checkbox" id="somente_exclusivos" name="somente_exclusivos">
            <span>Exclusivo</span>
          </label>
        </div>

        <!-- Ativo -->
        <div class="col s1 center-align" style="margin-top:25px;">
          <label>
            <input type="checkbox" id="ativo" name="ativo">
            <span>Ativo</span>
          </label>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button class="btn blue" onclick="salvarEdicao()">Salvar</button>
    <a href="#!" class="modal-close btn-flat">Cancelar</a>
  </div>
</div>



<!-- MODAL NOVO VESTIBULAR -->
<div id="modal-novo" class="modal">
  <div class="modal-content">
    <h5 style="color:#0b3b78; font-weight:600;">Novo Vestibular</h5>

    <form id="form-novo" style="margin-top:16px;">
      <div class="row">
        <!-- C√≥digo da Institui√ß√£o -->
        <div class="input-field col s2">
          <input id="instituicao_id_novo" name="instituicao_id" type="number" min="1" required onblur="buscarInstituicaoNome()">
          <label for="instituicao_id_novo">C√≥d. Institui√ß√£o</label>
        </div>

        <!-- Sigla da Institui√ß√£o (auto) -->
        <div class="input-field col s6">
          <input id="nome_instituicao_novo" type="text" readonly style="font-weight:600; color:#0b3b78;">
          <label class="active" for="nome_instituicao_novo">Sigla</label>
        </div>

        <!-- Semestre -->
        <div class="input-field col s1">
          <select id="epoca_novo" name="semestre">
            <option value="1">1¬∫ Semestre</option>
            <option value="2">2¬∫ Semestre</option>
          </select>
          <label>Semestre</label>
        </div>

        <!-- Ano -->
        <div class="input-field col s1">
          <input id="listagem_novo" name="listagem" type="number" value="2026" readonly>
          <label class="active" for="listagem_novo">Ano</label>
        </div>

        <!-- Exclusivo -->
        <div class="col s1 center-align" style="margin-top:25px;">
          <label>
            <input type="checkbox" id="exclusivo_novo" name="somente_exclusivos">
            <span>Exclusivo</span>
          </label>
        </div>
      </div>
    </form>
  </div>

  <div class="modal-footer">
    <button class="btn green" onclick="salvarNovo()">Salvar</button>
    <a href="#!" class="modal-close btn-flat">Cancelar</a>
  </div>
</div>

 <!-- MODAL CURSOS DO VESTIBULAR -->
<div id="modal-cursos" class="modal modal-fixed-footer">
  <div class="modal-content">
    <h5>Cursos do Vestibular</h5>

    <!-- Cabe√ßalho -->
    <div class="row" style="margin-bottom:8px;">
      <div class="input-field col s1">
        <input id="vestibular_id_curso" type="text" readonly>
        <label class="active" for="vestibular_id_curso">C√≥d. Vestibular</label>
      </div>
      <div class="input-field col s5">
        <input id="vestibular_instituicao_curso" type="text" readonly style="font-weight:600; color:#0b3b78;">
        <label class="active" for="vestibular_instituicao_curso">Institui√ß√£o</label>
      </div>
      <div class="input-field col s2">
        <input id="sigla_instituicao_novo" type="text" readonly style="font-weight:600; color:#0b3b78;">
        <label class="active" for="sigla_instituicao_novo">Sigla</label>
      </div>
      <div class="input-field col s1">
        <input id="vestibular_ano_curso" type="text" readonly>
        <label class="active" for="vestibular_ano_curso">Ano</label>
      </div>
      <div class="input-field col s1">
        <input id="vestibular_semestre_curso" type="text" readonly>
        <label class="active" for="vestibular_semestre_curso">Semestre</label>
      </div>
    </div>

    <!-- Tabela -->
    <table class="striped highlight responsive-table" id="tabela-cursos">
      <thead>
        <tr>
          <th>C√≥d. Curso</th>
          <th>Curso</th>
          <th>C√≥d. Inst</th>
          <th>Sigla</th>
          <th>Per√≠odo</th>
          <th>Vagas</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p class="center grey-text" id="msg-cursos">Nenhum curso cadastrado.</p>

    <!-- Adicionar novo curso -->
    <div class="row adicionar-curso">
      <div class="input-field col s2">
        <input id="curso_id_novo" type="number" min="1" onblur="buscarNomeCurso()">
        <label for="curso_id_novo">C√≥d. Curso</label>
      </div>

      <div class="input-field col s3">
        <input id="curso_nome_novo" type="text" readonly tabindex="-1" style="color:#0b3b78; pointer-events:none;">
        <label class="active" for="curso_nome_novo">Nome do Curso</label>
      </div>

      <div class="input-field col s2">
        <input id="curso_codinst_novo" type="number" min="1" onblur="buscarInstituicaoPorCodigo()">
        <label for="curso_codinst_novo">C√≥d. Institui√ß√£o</label>
      </div>

      <div class="input-field col s3">
        <input id="curso_siglainst_novo" type="text" readonly tabindex="-1" style="color:#0b3b78; pointer-events:none;">
        <label class="active" for="curso_siglainst_novo" style="top:-18px;">Sigla da Institui√ß√£o</label>
      </div>

      <div class="input-field col s1">
        <input id="periodo_novo" type="text" placeholder="M / T / V / N">
        <label for="periodo_novo">Per√≠odo</label>
      </div>

      <div class="input-field col s1">
        <input id="vagas_novo" type="number" min="0" value="0">
        <label for="vagas_novo">Vagas</label>
      </div>

      <div class="col s1 center-align">
        <button class="btn green" onclick="salvarCurso()">+</button>
      </div>
    </div>
  </div>

  <!-- Rodap√© fixo -->
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Fechar</a>
  </div>
</div>

<script>
const API = 'https://apisec.secauxiliar.com.br/aprove/';
let VEST_ATUAL = { id: null, instituicao_id: null, sigla: '' };



// === NOVO VESTIBULAR (SIMPLIFICADO) ===

async function abrirNovo(){
  const modal = M.Modal.getInstance(document.getElementById('modal-novo'));
  await carregarSelectInstituicoes('instituicao_id_novo');
  M.FormSelect.init(document.querySelectorAll('select'));
  document.getElementById('exclusivo_novo').checked = false;
  modal.open();
}

async function carregarSelectInstituicoes(selectId){
  const res = await fetch(API + 'instituicoes_list.php', { credentials: 'include' });
  const data = await res.json();
  const select = document.getElementById(selectId);
  select.innerHTML = '<option value="">Selecione...</option>';
  if (data.ok && data.rows?.length) {
    data.rows.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.id;
      opt.textContent = r.instituicao;
      select.appendChild(opt);
    });
  }
}

async function salvarNovo(){
  const fd = new FormData(document.getElementById('form-novo'));
  fd.set('somente_exclusivos', document.getElementById('exclusivo_novo').checked ? 1 : 0);
  fd.set('ativo', 1);

  try {
    const res = await fetch(API + 'vestibulares_insert.php', {
      method: 'POST',
      body: fd,
      credentials: 'include'
    });
    const data = await res.json();
    if (data.ok) {
      M.toast({ html: 'Vestibular cadastrado com sucesso!' });
      M.Modal.getInstance(document.getElementById('modal-novo')).close();
      buscarVestibulares();
    } else {
      M.toast({ html: data.erro || 'Erro ao salvar vestibular' });
    }
  } catch (err) {
    console.error(err);
    M.toast({ html: 'Falha na comunica√ß√£o com o servidor.' });
  }
}

// === Logout ===
async function logout(){
  await fetch(API+'auth_login_out.php',{credentials:'include'});
  location.href='/aprove/index.html';
}

// === Inicializa√ß√£o ===
document.addEventListener('DOMContentLoaded',()=>{
  M.Modal.init(document.querySelectorAll('.modal'));
  carregarInstituicoes();
  buscarVestibulares();
});

// === Carrega op√ß√µes de institui√ß√£o ===
async function carregarInstituicoes(){
  const res = await fetch(API+'instituicoes_list.php',{credentials:'include'});
  const data = await res.json();
  if(data.ok && data.rows.length){
    const select = document.getElementById('instituicao_id');
    select.innerHTML = '<option value="">Selecione...</option>';
    data.rows.forEach(r=>{
      const opt=document.createElement('option');
      opt.value=r.id;
      opt.textContent=r.instituicao;
      select.appendChild(opt);
    });
    M.FormSelect.init(select);
  }
}

// === BUSCAR ===
async function buscarVestibulares(){
  const termo = document.getElementById('search').value.trim();
  const tbody = document.querySelector('#tabela-lista tbody');
  tbody.innerHTML = '';
  document.getElementById('msg-status').textContent = 'Buscando...';

  const res = await fetch(API + 'vestibulares_list.php?busca=' + encodeURIComponent(termo), { credentials: 'include' });
  const data = await res.json();

  if (data.ok && data.rows.length) {
    document.getElementById('msg-status').textContent = '';
    data.rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id}</td>
        <td>${r.sigla || ''}</td>
        <td>${r.instituicao || ''}</td>
        <td>${r.listagem || ''}</td>
        <td>${r.somente_exclusivos == 1 ? 'Sim' : 'N√£o'}</td>
        <td>${r.semestre || ''}</td>
        <td>${r.ativo == 1 ? 'Sim' : 'N√£o'}</td>
        <td>
          <button class="btn-small blue" onclick="abrirCursos(${r.id}, '${(r.instituicao || '').replace(/'/g, "\\'")}')">Cursos</button>
          <button class="btn-small orange" onclick="abrirEdicao(${r.id})">Editar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } else {
    document.getElementById('msg-status').textContent = 'Nenhum vestibular encontrado.';
  }
}


// === EDITAR ===
async function abrirEdicao(id){
  const modal=M.Modal.getInstance(document.querySelector('#modal-editar'));
  const res=await fetch(API+'vestibulares_get.php?id='+id,{credentials:'include'});
  const data=await res.json();
  if(data.ok && data.row){
    const r=data.row;
    document.getElementById('id').value=r.id;
    document.getElementById('sigla').value=r.sigla;
    document.getElementById('listagem').value=r.listagem;
    document.getElementById('instituicao_id').value=r.instituicao_id;
    document.getElementById('somente_exclusivos').checked=(r.somente_exclusivos==1);
    document.getElementById('semestre').value = r.semestre;
    document.getElementById('ativo').checked=(r.ativo==1);
    M.updateTextFields();
    M.FormSelect.init(document.querySelectorAll('select'));
    modal.open();
  }else{
    M.toast({html:'Vestibular n√£o encontrado'});
  }
}

// === SALVAR EDI√á√ÉO ===
async function salvarEdicao(){
  const fd=new FormData(document.getElementById('form-editar'));
  fd.set('ativo', ativo.checked ? 1:0);
  fd.set('somente_exclusivos', somente_exclusivos.checked ? 1:0);
  const res=await fetch(API+'vestibulares_update.php',{method:'POST',body:fd,credentials:'include'});
  const data=await res.json();
  if(data.ok){
    M.toast({html:'Vestibular atualizado!'});
    buscarVestibulares();
    M.Modal.getInstance(document.querySelector('#modal-editar')).close();
  }else{
    M.toast({html:data.error||'Erro ao salvar'});
  }
}

async function buscarInstituicaoNome() {
  const cod = document.getElementById('instituicao_id_novo').value.trim();
  const nomeInput = document.getElementById('nome_instituicao_novo');
  nomeInput.value = '';

  if (!cod) return;

  try {
    const res = await fetch(API + 'instituicoes_get.php?id=' + encodeURIComponent(cod), { credentials: 'include' });
    const data = await res.json();

    if (data.ok && data.row) {
      document.getElementById('sigla_instituicao_novo').value = data.row.sigla || '';
      document.getElementById('sigla_instituicao_novo').style.color = '#0b3b78';
    } else {
      document.getElementById('sigla_instituicao_novo').value = 'Sigla n√£o encontrada';
      document.getElementById('sigla_instituicao_novo').style.color = '#c62828';
    }
    M.updateTextFields();
  } catch (err) {
    console.error(err);
    nomeInput.value = 'Erro ao buscar institui√ß√£o';
    nomeInput.style.color = '#c62828';
  }
}


let vestibularSomenteExclusivo = 0;

// === ABRIR MODAL DE CURSOS ===
async function abrirCursos(vestibularId, instituicaoNome){
  // Elemento do modal
  let modalEl = document.getElementById('modal-cursos');

  // Inicializa o modal se ainda n√£o existir
  if (!M.Modal.getInstance(modalEl)) {
    M.Modal.init(modalEl, {
      dismissible: false,         // ‚ùå Desativa ESC e clique fora
      preventScrolling: false,    // ‚úÖ Permite rolar o fundo, se necess√°rio
      inDuration: 200,
      outDuration: 200
    });
  }

  const modal = M.Modal.getInstance(modalEl);

  // Busca dados do vestibular
  const res = await fetch(API + 'vestibulares_get.php?id=' + vestibularId, {credentials:'include'});
  const data = await res.json();

  if (data.ok && data.row) {
    const v = data.row;
    vestibularSomenteExclusivo = parseInt(v.somente_exclusivos || 0);

    // Preenche campos do cabe√ßalho do modal
    document.getElementById('vestibular_id_curso').value = v.id;
    document.getElementById('vestibular_instituicao_curso').value = instituicaoNome || v.instituicao || '(sem nome)';
    document.getElementById('sigla_instituicao_novo').value = v.sigla || '(sem sigla)';
    document.getElementById('vestibular_ano_curso').value = v.listagem;
    document.getElementById('vestibular_semestre_curso').value = v.semestre;

    // guarda para reutilizar ap√≥s cada inclus√£o
    VEST_ATUAL = {
      id: v.id,
      instituicao_id: v.instituicao_id || '',
      sigla: v.sigla || ''
    };
    
    // preenche os campos padr√£o de institui√ß√£o para o novo curso
    document.getElementById('curso_codinst_novo').value  = VEST_ATUAL.instituicao_id;
    document.getElementById('curso_siglainst_novo').value = VEST_ATUAL.sigla;
    
    M.updateTextFields();

    // Carrega cursos associados
    await carregarCursosVestibular(v.id);
    modal.open();
  } else {
    M.toast({ html: 'Vestibular n√£o encontrado' });
  }
}



// === BUSCAR NOME DO CURSO ===
async function buscarNomeCurso(){
  const id = document.getElementById('curso_id_novo').value.trim();
  const nomeInput = document.getElementById('curso_nome_novo');
  nomeInput.value = '';
  if(!id) return;

  try {
    const res = await fetch(API+'cursos_get.php?id='+id, {credentials:'include'});
    const data = await res.json();
    if(data.ok && data.row){
      // Se vestibular √© exclusivo, o curso deve ser exclusivo
      if(vestibularSomenteExclusivo && data.row.curso_exc != 1){
        nomeInput.value = 'Curso N√ÉO √© exclusivo';
        nomeInput.style.color = '#c62828';
      }else{
        nomeInput.value = data.row.nome || '';
        nomeInput.style.color = '#0b3b78';
      }
    } else {
      nomeInput.value = 'Curso n√£o encontrado';
      nomeInput.style.color = '#c62828';
    }
    M.updateTextFields();
  } catch(err){
    console.error(err);
    nomeInput.value = 'Erro ao buscar curso';
    nomeInput.style.color = '#c62828';
  }
}

// === SALVAR NOVO CURSO ===
async function salvarCurso(){
  const vId      = document.getElementById('vestibular_id_curso').value;
  const cursoId  = document.getElementById('curso_id_novo').value.trim();
  const codinst  = document.getElementById('curso_codinst_novo').value.trim();
  const periodo  = document.getElementById('periodo_novo').value.trim();
  const vagas    = document.getElementById('vagas_novo').value.trim();

  if (!cursoId || !codinst){
    M.toast({ html:'Informe o curso e a institui√ß√£o.' });
    return;
  }

  const fd = new FormData();
  fd.set('vestibular_id', vId);
  fd.set('curso_id', cursoId);
  fd.set('codinst', codinst);
  fd.set('periodo', periodo);
  fd.set('vagas', vagas);

  try{
    const res  = await fetch(API+'vestibular_cursos_insert.php', { method:'POST', body:fd, credentials:'include' });
    const data = await res.json();

    if (data.ok){
      M.toast({ html:'Curso adicionado com sucesso!' });

      // limpa campos
      document.getElementById('curso_id_novo').value = '';
      document.getElementById('curso_nome_novo').value = '';
      document.getElementById('periodo_novo').value = '';
      document.getElementById('vagas_novo').value = '0';

      // ‚úÖ restaura o padr√£o da institui√ß√£o do vestibular atual
      document.getElementById('curso_codinst_novo').value  = VEST_ATUAL.instituicao_id || '';
      document.getElementById('curso_siglainst_novo').value = VEST_ATUAL.sigla || '';

      M.updateTextFields();

      // ‚ö° Recarrega tabela e devolve foco ao campo "C√≥d. Curso"
      setTimeout(async () => {
        await carregarCursosVestibular(vId);
        const campoCurso = document.getElementById('curso_id_novo');
        if (campoCurso) campoCurso.focus();
      }, 200);

    } else {
      M.toast({ html: (data.error || 'Erro ao salvar curso') });
    }

  }catch(err){
    console.error(err);
    M.toast({ html:'Falha na comunica√ß√£o com o servidor.' });
  }
}

// === ENTER SALVA CURSO (somente quando estiver no campo "Vagas") ===
document.getElementById('vagas_novo').addEventListener('keydown', function(e){
  if (e.key === 'Enter') {
    e.preventDefault(); // evita enviar formul√°rio ou recarregar
    salvarCurso();
  }
});





async function carregarCursosVestibular(vestibularId){
  const tbody = document.querySelector('#tabela-cursos tbody');
  tbody.innerHTML = '';
  document.getElementById('msg-cursos').textContent = 'Carregando...';

  const res = await fetch(API + 'vestibular_cursos_list.php?vestibular_id=' + vestibularId, {credentials:'include'});
  const data = await res.json();

  if(data.ok && data.rows.length){
    document.getElementById('msg-cursos').textContent = '';
    data.rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.curso_id}</td>
        <td>${r.curso || '(sem nome)'}</td>
        <td>${r.codinst}</td>
        <td>${r.sigla_inst || ''}</td>
        <td>${r.periodo || ''}</td>
        <td>${r.vagas || 0}</td>
        <td><button class="btn-small red" onclick="removerCurso(${r.id})">Excluir</button></td>
      `;
      tbody.appendChild(tr);
    });
  }else{
    document.getElementById('msg-cursos').textContent='Nenhum curso cadastrado.';
  }
}

async function buscarInstituicaoPorCodigo() {
  const codInput = document.getElementById('curso_codinst_novo');
  const siglaInput = document.getElementById('curso_siglainst_novo');
  const codigo = codInput.value.trim();

  if (!codigo) {
    siglaInput.value = '';
    return;
  }

  try {
    const res = await fetch(API + 'instituicoes_get.php?id=' + codigo, { credentials: 'include' });
    const data = await res.json();

    if (data.ok && data.row) {
      siglaInput.value = data.row.sigla || '(sem sigla)';
      siglaInput.style.color = '#0b3b78';
    } else {
      siglaInput.value = 'Institui√ß√£o n√£o encontrada';
      siglaInput.style.color = '#c62828';
    }
  } catch (err) {
    siglaInput.value = 'Erro ao buscar';
    siglaInput.style.color = '#c62828';
  }
}

async function removerCurso(id) {
  if (!confirm('Deseja realmente excluir este curso?')) return;

  try {
    const res = await fetch(API + 'vestibular_cursos_delete.php?id=' + id, { credentials: 'include' });
    const data = await res.json();

    if (data.ok) {
      M.toast({ html: 'Curso removido com sucesso' });
      await carregarCursosVestibular(document.getElementById('vestibular_id_curso').value);
    } else {
      M.toast({ html: 'Erro: ' + (data.error || 'Falha ao excluir') });
    }
  } catch (err) {
    M.toast({ html: 'Erro na exclus√£o: ' + err.message });
  }
}


</script>
</body>
</html>
