<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Aprove • Aprovações das Unidades</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root{
      --primary:#0b3b78;
      --bg:#f7f8fb;
      --line:#e5e7eb;
    }
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
    }
    header.topbar{
      position:fixed;
      top:0; left:0; right:0;
      height:64px;
      background:var(--primary);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 24px;
      box-shadow:0 2px 8px rgba(15,23,42,.35);
      z-index:10;
    }
    header.topbar h5{
      margin:0;
      font-size:18px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    main{
      max-width:1180px;
      margin:88px auto 40px;
      padding:0 16px;
    }
    .page-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:8px;
    }
    .page-title h4{
      margin:0;
      font-size:24px;
      font-weight:700;
      color:#111827;
    }
    .subtitle{
      margin:0 0 16px;
      color:#6b7280;
      font-size:14px;
    }
    .pill-year{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#e0edff;
      color:#1d4ed8;
      font-size:13px;
      font-weight:500;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
      margin-bottom:12px;
    }
    .filters-row .input-field{
      margin-top:0;
    }
    .msg{
      font-size:13px;
      color:#6b7280;
      margin-top:4px;
    }
    table.striped > tbody > tr:nth-child(odd){
      background:#f9fafb;
    }
    table th{
      font-size:12px;
      color:#6b7280;
      white-space:nowrap;
    }
    table td{
      font-size:13px;
      padding:6px 10px;
      border-bottom:1px solid #eef2f7;
    }
    .chip-status{
      border-radius:999px;
      padding:2px 10px;
      font-size:11px;
      font-weight:500;
      display:inline-block;
    }
    .st-pendente{
      background:#fef3c7;
      color:#92400e;
    }
    .st-conferido{
      background:#dcfce7;
      color:#166534;
    }
    .st-recusado{
      background:#fee2e2;
      color:#991b1b;
    }
    @media (max-width:768px){
      .page-title{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>

<header class="topbar">
  <h5>
    <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px">
    Aprove — Aprovações enviadas pelas unidades
  </h5>
  <button class="btn-flat waves-effect white-text" onclick="logout()">Sair</button>
</header>

<main>
  <div class="page-title">
    <div>
      <h4>Aprovações das unidades</h4>
      <p class="subtitle">
        Visualize as aprovações cadastradas pelas unidades na tabela de estágio
        (<code>aprovacoes_unidade</code>).
      </p>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
      <span class="pill-year">
        Cadastro <span id="anoSpan">2025</span>
      </span>
    </div>
  </div>

  <div class="card">
    <div class="card-content">
      <div class="filters-row">
        <div class="input-field">
          <input id="filtroAno" type="number" value="2025" min="2000" max="2100">
          <label class="active" for="filtroAno">Cadastro</label>
        </div>

        <div class="input-field">
          <select id="filtroStatus">
            <option value="P" selected>Pendentes</option>
            <option value="A">Conferidas</option>
            <option value="R">Recusadas</option>
            <option value="ALL">Todas</option>
          </select>
          <label>Status</label>
        </div>

        <div class="input-field">
          <input id="filtroUnidade" type="number" min="0">
          <label for="filtroUnidade">Código da unidade (opcional)</label>
        </div>

        <button class="btn waves-effect blue darken-2" onclick="carregarAprovacoesUnidade()">
          Atualizar
        </button>
      </div>

      <div id="infoResumo" class="msg">Carregando...</div>

      <div class="responsive-table" style="margin-top:8px;">
        <table class="striped highlight">
          <thead>
            <tr>
              <th>Unidade</th>
              <th>Aluno</th>
              <th>Série</th>
              <th>VEST</th>
              <th>Cód. curso</th>
              <th>Curso (texto)</th>
              <th>Instituição (texto)</th>
              <th>Cls</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody-aprov"></tbody>
        </table>
      </div>

      <!-- NOVO: painel com cursos do vestibular digitado -->
      <div id="painelCursos" class="card-panel" style="margin-top:16px; display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-weight:600;">
            Cursos do vestibular <span id="vestAtualSpan"></span>
          </span>
          <span class="msg">
            Clique em um curso para preencher o código na linha focada.
          </span>
        </div>
        <div class="responsive-table" style="max-height:260px;overflow:auto;">
          <table class="striped">
            <thead>
              <tr>
                <th>Cód. curso</th>
                <th>Curso</th>
                <th>Instituição</th>
                <th>Período</th>
              </tr>
            </thead>
            <tbody id="tbody-cursos-vest"></tbody>
          </table>
        </div>
      </div>


    </div>
  </div>
</main>

<script>
const API       = 'https://apisec.secauxiliar.com.br/aprove/';
const LOGIN_URL = '/aprovados/index.html';

let linhaFocadaId = null;           // id da linha que estou editando (aprovações_unidade.id)
const vestCursosCache = {};         // cache dos cursos por VEST

function logout(){
  fetch(API + 'auth_logout.php', { credentials:'include' })
    .finally(() => location.replace(LOGIN_URL));
}

// converte 'P', 'A', 'R' em texto + classe para o chip
function renderStatusChip(st){
  if (!st) return '';
  let txt = '';
  let cls = '';
  switch (st) {
    case 'P':
      txt = 'Pendente';
      cls = 'chip-status st-pendente';
      break;
    case 'A':
      txt = 'Conferido';
      cls = 'chip-status st-conferido';
      break;
    case 'R':
      txt = 'Recusado';
      cls = 'chip-status st-recusado';
      break;
    default:
      txt = st;
      cls = 'chip-status';
  }
  return `<span class="${cls}">${txt}</span>`;
}

function formatarData(dt){
  if (!dt) return '';
  return dt.replace('T', ' ');
}

/* ========= Cursos do vestibular (usa vestibular_cursos_list.php) ========= */

async function getCursosVest(vest) {
  vest = String(vest).trim();
  if (!vest) throw new Error('VEST não informado.');

  if (vestCursosCache[vest]) return vestCursosCache[vest];

  const res  = await fetch(
    API + 'vestibular_cursos_list.php?vestibular_id=' + encodeURIComponent(vest),
    { credentials:'include' }
  );
  const data = await res.json();

  if (!data.ok) {
    throw new Error(data.error || 'Erro ao buscar cursos do vestibular.');
  }

  vestCursosCache[vest] = data.rows || [];
  return vestCursosCache[vest];
}

async function mostrarCursosVest(vest) {
  const painel   = document.getElementById('painelCursos');
  const tbody    = document.getElementById('tbody-cursos-vest');
  const spanVest = document.getElementById('vestAtualSpan');

  tbody.innerHTML = '';
  spanVest.textContent = vest;

  try {
    const cursos = await getCursosVest(vest);

    if (!cursos.length) {
      tbody.innerHTML = '<tr><td colspan="4">Nenhum curso cadastrado para este vestibular.</td></tr>';
    } else {
      cursos.forEach(c => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.curso_id}</td>
          <td>${c.curso}</td>
          <td>${c.sigla_inst || ''}</td>
          <td>${c.periodo || ''}</td>
        `;
        tr.style.cursor = 'pointer';

        // ao clicar no curso, joga o código na linha focada
        tr.onclick = () => {
          if (!linhaFocadaId) return;
          const inputCod = document.querySelector(
            'input[data-codcurso-id="' + linhaFocadaId + '"]'
          );
          if (inputCod) {
            inputCod.value = c.curso_id;
            inputCod.focus();
          }
        };

        tbody.appendChild(tr);
      });
    }

    painel.style.display = 'block';
  } catch (e) {
    console.error('erro ao carregar cursos do vestibular:', e);
    tbody.innerHTML = '<tr><td colspan="4">Erro ao carregar cursos.</td></tr>';
    painel.style.display = 'block';
    M.toast({ html:'Erro ao carregar cursos do vestibular.', classes:'red darken-2' });
  }
}

/* ==================== Lista de aprovações_unidade ==================== */

async function carregarAprovacoesUnidade(){
  const anoInput   = document.getElementById('filtroAno');
  const statusSel  = document.getElementById('filtroStatus');
  const undInput   = document.getElementById('filtroUnidade');
  const tbody      = document.getElementById('tbody-aprov');
  const msg        = document.getElementById('infoResumo');

  const ano        = parseInt(anoInput.value || '2025', 10);
  const status     = statusSel.value || 'P';
  const codunidade = undInput.value ? parseInt(undInput.value, 10) : 0;

  tbody.innerHTML = '';
  msg.textContent = 'Carregando...';

  const params = new URLSearchParams({
    ano: String(ano),
    status: status,
  });
  if (codunidade > 0) {
    params.append('codunidade', String(codunidade));
  }

  try {
    const res  = await fetch(API + 'aprovacoes_unidade_admin_list.php?' + params.toString(), {
      credentials: 'include'
    });
    const data = await res.json();

    if (!data.ok) {
      msg.textContent = data.error || 'Erro ao carregar aprovações.';
      return;
    }

    const rows = data.rows || [];
    msg.textContent = rows.length
      ? `${rows.length} aprovações encontradas.`
      : 'Nenhuma aprovação encontrada para os filtros selecionados.';

    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.setAttribute('data-id', r.id);

      const unidade     = `${r.codunidade} — ${r.unidade ?? ''}`;
      const aluno       = r.aluno ?? '';
      const serie       = r.serie ?? '';
      const cursoTxt    = r.curso_txt ?? '';
      const instTxt     = r.instituicao_txt ?? '';
      const cls         = r.cls ?? '';
      const lista       = r.lista ?? '';
      const statusRow   = r.status ?? '';
      const dataReg     = r.dt_registro ?? '';
      const vestUnd     = r.vest_und ?? '';
      const codcursoUnd = r.codcurso_und ?? '';

      tr.innerHTML = `
        <td>${unidade}</td>
        <td>${aluno}</td>
        <td>${serie}</td>

        <td>
          <input type="number" 
                 class="input-vest" 
                 data-vest-id="${r.id}" 
                 value="${vestUnd}" 
                 style="max-width:80px;">
        </td>

        <td>
          <input type="number" 
                 class="input-codcurso" 
                 data-codcurso-id="${r.id}" 
                 value="${codcursoUnd}" 
                 style="max-width:80px;">
        </td>

        <td class="col-curso-txt">${cursoTxt}</td>
        <td class="col-inst-txt">${instTxt}</td>
        <td>${cls}</td>
        <td>
          <button class="btn-small blue" onclick="importarAprovacao(${r.id})">
            Importar
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    // listeners para saber qual linha está focada e carregar cursos do VEST
    document.querySelectorAll('.input-vest').forEach(inp => {
      inp.addEventListener('focus', () => {
        linhaFocadaId = inp.dataset.vestId;
      });
      inp.addEventListener('change', () => {
        const vest = inp.value.trim();
        if (vest) {
          mostrarCursosVest(vest);
        }
      });
    });

    document.querySelectorAll('.input-codcurso').forEach(inp => {
      inp.addEventListener('focus', () => {
        linhaFocadaId = inp.dataset.codcursoId;
      });
    });

  } catch (e) {
    console.error('Erro ao carregar aprovações_unidade:', e);
    msg.textContent = 'Erro de conexão ao carregar aprovações.';
  }
}

/* ==================== Importar uma aprovação ==================== */

async function importarAprovacao(id) {
  const vestInput  = document.querySelector(`input[data-vest-id="${id}"]`);
  const cursoInput = document.querySelector(`input[data-codcurso-id="${id}"]`);

  if (!vestInput || !cursoInput) return;

  const vest     = vestInput.value.trim();
  const codcurso = cursoInput.value.trim();

  if (!vest || !codcurso) {
    M.toast({
      html: 'Informe o VEST e o código do curso antes de importar.',
      classes: 'red darken-2'
    });
    return;
  }

  // valida VEST + curso usando vestibular_cursos_list.php
  let cursoVest = null;
  try {
    const cursos = await getCursosVest(vest);
    cursoVest = cursos.find(c => String(c.curso_id) === codcurso);
  } catch (e) {
    console.error('erro ao validar VEST/curso:', e);
    M.toast({
      html: 'Erro ao validar VEST + código do curso.',
      classes: 'red darken-2'
    });
    return;
  }

  if (!cursoVest) {
    M.toast({
      html: 'Combinação VEST + código de curso não encontrada neste vestibular.',
      classes: 'red darken-2'
    });
    return;
  }

  // se passou na validação, chama o PHP de importação
  try {
    const res = await fetch(API + 'aprovacoes_unidade_import.php', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, vest, codcurso })
    });

    const data = await res.json();

    if (!data.ok) {
      let msg = data.error || 'Erro ao importar aprovação.';

      if (data.error === 'curso_nao_encontrado') {
        msg = 'Combinação VEST + código de curso não encontrada no cadastro de cursos do vestibular.';
      } else if (data.error === 'duplicidade_aprovacao') {
        msg = 'Já existe uma aprovação oficial para este aluno com esse curso/lista.';
      } else if (data.error === 'ja_importado') {
        msg = 'Esta aprovação já foi importada anteriormente.';
      }

      M.toast({ html: msg, classes: 'red darken-2' });
      return;
    }

    // Atualiza a linha na tabela com curso/instituição oficiais e status verde
    const linha   = document.querySelector(`tr[data-id="${id}"]`);
    if (linha) {
      const tdCurso  = linha.querySelector('.col-curso-txt');
      const tdInst   = linha.querySelector('.col-inst-txt');
      const tdStatus = linha.querySelector('.col-status');

      if (tdCurso)  tdCurso.textContent  = data.curso || tdCurso.textContent;
      if (tdInst)   tdInst.textContent   = data.instituicao || tdInst.textContent;
      if (tdStatus) tdStatus.innerHTML   = renderStatusChip('A');
    }

    M.toast({
      html: 'Aprovação importada para o cadastro oficial.',
      classes: 'green darken-2'
    });

  } catch (e) {
    console.error('erro importar aprovacao:', e);
    M.toast({
      html: 'Erro de conexão ao importar aprovação.',
      classes: 'red darken-2'
    });
  }
}

/* ==================== Init ==================== */

document.addEventListener('DOMContentLoaded', () => {
  const selects = document.querySelectorAll('select');
  M.FormSelect.init(selects);

  const anoSpan  = document.getElementById('anoSpan');
  const anoInput = document.getElementById('filtroAno');
  anoSpan.textContent = anoInput.value;

  anoInput.addEventListener('change', () => {
    anoSpan.textContent = anoInput.value;
  });

  carregarAprovacoesUnidade();
});
</script>


</body>
</html>
