<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Aprove • Aprovações das Unidades</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root{
      --primary:#0b3b78;
      --bg:#f7f8fb;
      --line:#e5e7eb;
    }
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
    }
    header.topbar{
      position:fixed;
      top:0; left:0; right:0;
      height:64px;
      background:var(--primary);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 24px;
      box-shadow:0 2px 8px rgba(15,23,42,.35);
      z-index:10;
    }
    header.topbar h5{
      margin:0;
      font-size:18px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:10px;
    }
    main{
      max-width:1180px;
      margin:88px auto 40px;
      padding:0 16px;
    }
    .page-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:8px;
    }
    .page-title h4{
      margin:0;
      font-size:24px;
      font-weight:700;
      color:#111827;
    }
    .subtitle{
      margin:0 0 16px;
      color:#6b7280;
      font-size:14px;
    }
    .pill-year{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#e0edff;
      color:#1d4ed8;
      font-size:13px;
      font-weight:500;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
      margin-bottom:12px;
    }
    .filters-row .input-field{
      margin-top:0;
    }
    .msg{
      font-size:13px;
      color:#6b7280;
      margin-top:4px;
    }
    table.striped > tbody > tr:nth-child(odd){
      background:#f9fafb;
    }
    table th{
      font-size:12px;
      color:#6b7280;
      white-space:nowrap;
    }
    table td{
      font-size:13px;
      padding:6px 10px;
      border-bottom:1px solid #eef2f7;
    }
    .chip-status{
      border-radius:999px;
      padding:2px 10px;
      font-size:11px;
      font-weight:500;
      display:inline-block;
    }
    .st-pendente{
      background:#fef3c7;
      color:#92400e;
    }
    .st-conferido{
      background:#dcfce7;
      color:#166534;
    }
    .st-recusado{
      background:#fee2e2;
      color:#991b1b;
    }
    @media (max-width:768px){
      .page-title{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>

<header class="topbar">
  <h5>
    <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px">
    Aprove — Aprovações enviadas pelas unidades
  </h5>
  <button class="btn-flat waves-effect white-text" onclick="logout()">Sair</button>
</header>

<main>
  <div class="page-title">
    <div>
      <h4>Aprovações das unidades</h4>
      <p class="subtitle">
        Visualize as aprovações cadastradas pelas unidades na tabela de estágio
        (<code>aprovacoes_unidade</code>).
      </p>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;">
      <span class="pill-year">
        Cadastro <span id="anoSpan">2025</span>
      </span>
    </div>
  </div>

  <div class="card">
    <div class="card-content">
      <div class="filters-row">
        <div class="input-field">
          <input id="filtroAno" type="number" value="2025" min="2000" max="2100">
          <label class="active" for="filtroAno">Cadastro</label>
        </div>

        <div class="input-field">
          <select id="filtroStatus">
            <option value="P" selected>Pendentes</option>
            <option value="A">Conferidas</option>
            <option value="R">Recusadas</option>
            <option value="ALL">Todas</option>
          </select>
          <label>Status</label>
        </div>

        <div class="input-field">
          <input id="filtroUnidade" type="number" min="0">
          <label for="filtroUnidade">Código da unidade (opcional)</label>
        </div>

        <button class="btn waves-effect blue darken-2" onclick="carregarAprovacoesUnidade()">
          Atualizar
        </button>
      </div>

      <div id="infoResumo" class="msg">Carregando...</div>

      <div class="responsive-table" style="margin-top:8px;">
        <table class="striped highlight">
          <thead>
            <tr>
              <th>Unidade</th>
              <th>Aluno</th>
              <th>Série</th>
              <th>VEST</th>
              <th>Cód. curso</th>
              <th>Curso (texto)</th>
              <th>Instituição (texto)</th>
              <th>Cls</th>
              <th>Lista</th>
              <th>Status</th>
              <th>Data/hora</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="tbody-aprov"></tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<script>
const API       = 'https://apisec.secauxiliar.com.br/aprove/';
const LOGIN_URL = '/aprovados/index.html';

function logout(){
  fetch(API + 'auth_logout.php', { credentials:'include' })
    .finally(() => location.replace(LOGIN_URL));
}

// badge de status (usa col-status-badge para depois o importarAprovacao atualizar)
function renderStatusChip(st){
  if (!st) return '';
  let caption = '';
  let colorClass = '';

  switch (st) {
    case 'P':
      caption    = 'Pendente';
      colorClass = 'amber darken-2';
      break;
    case 'A':
      caption    = 'Conferido';
      colorClass = 'green';
      break;
    case 'R':
      caption    = 'Recusado';
      colorClass = 'red';
      break;
    default:
      caption    = st;
      colorClass = 'grey';
  }

  return `<span class="new badge ${colorClass} col-status-badge" data-badge-caption="${caption}"></span>`;
}

function formatarData(dt){
  if (!dt) return '';
  return dt.replace('T', ' ');
}

async function carregarAprovacoesUnidade(){
  const anoInput   = document.getElementById('filtroAno');
  const statusSel  = document.getElementById('filtroStatus');
  const undInput   = document.getElementById('filtroUnidade');
  const tbody      = document.getElementById('tbody-aprov');
  const msg        = document.getElementById('infoResumo');

  const ano        = parseInt(anoInput.value || '2025', 10);
  const status     = statusSel.value || 'P';
  const codunidade = undInput.value ? parseInt(undInput.value, 10) : 0;

  tbody.innerHTML = '';
  msg.textContent = 'Carregando...';

  const params = new URLSearchParams({
    ano: String(ano),
    status: status,
  });
  if (codunidade > 0) {
    params.append('codunidade', String(codunidade));
  }

  try {
    const res  = await fetch(API + 'aprovacoes_unidade_admin_list.php?' + params.toString(), {
      credentials: 'include'
    });
    const data = await res.json();

    if (!data.ok) {
      msg.textContent = data.error || 'Erro ao carregar aprovações.';
      return;
    }

    const rows = data.rows || [];
    msg.textContent = rows.length
      ? `${rows.length} aprovações encontradas.`
      : 'Nenhuma aprovação encontrada para os filtros selecionados.';

    if (!rows.length){
      tbody.innerHTML = '';
      return;
    }

    tbody.innerHTML = rows.map(r => {
      const unidade = `${r.codunidade} — ${r.unidade ?? ''}`;
      const aluno   = r.aluno ?? '';
      const serie   = r.serie ?? '';
      const cls     = r.cls ?? '';
      const lista   = r.lista ?? '';
      const status  = r.status ?? '';
      const dataReg = r.dt_registro ?? '';
      const vest    = r.vest_und ?? '';
      const codcur  = r.codcurso_und ?? '';
      const curso   = r.curso_txt ?? '';
      const inst    = r.instituicao_txt ?? '';

      return `
        <tr data-id="${r.id}">
          <td>${unidade}</td>
          <td>${aluno}</td>
          <td>${serie}</td>

          <td>
            <input type="number"
                   class="browser-default campo-vest"
                   data-vest-id="${r.id}"
                   value="${vest}"
                   style="width:80px;">
          </td>

          <td>
            <input type="text"
                   class="browser-default campo-codcurso"
                   data-codcurso-id="${r.id}"
                   value="${codcur}"
                   style="width:90px;">
          </td>

          <td class="col-curso-txt">${curso}</td>
          <td class="col-inst-txt">${inst}</td>

          <td>${cls}</td>
          <td>${lista}</td>

          <td class="col-status">
            ${renderStatusChip(status)}
          </td>

          <td>${formatarData(dataReg)}</td>

          <td>
            <button type="button"
                    class="btn-small blue darken-2"
                    onclick="importarAprovacao(${r.id})">
              Importar
            </button>
          </td>
        </tr>
      `;
    }).join('');

  } catch (e) {
    console.error('Erro ao carregar aprovações_unidade:', e);
    msg.textContent = 'Erro de conexão ao carregar aprovações.';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const selects = document.querySelectorAll('select');
  M.FormSelect.init(selects);

  const anoSpan  = document.getElementById('anoSpan');
  const anoInput = document.getElementById('filtroAno');
  anoSpan.textContent = anoInput.value;

  anoInput.addEventListener('change', () => {
    anoSpan.textContent = anoInput.value;
  });

  carregarAprovacoesUnidade();
});

async function importarAprovacao(id) {
  const vestInput  = document.querySelector(`input[data-vest-id="${id}"]`);
  const cursoInput = document.querySelector(`input[data-codcurso-id="${id}"]`);

  if (!vestInput || !cursoInput) return;

  const vest     = vestInput.value.trim();
  const codcurso = cursoInput.value.trim();

  if (!vest || !codcurso) {
    M.toast({
      html: 'Informe o VEST e o código do curso antes de importar.',
      classes: 'red darken-2'
    });
    return;
  }

  try {
    const res = await fetch(API + 'aprovacoes_unidade_import.php', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, vest, codcurso })
    });

    const data = await res.json();

    if (!data.ok) {
      let msg = data.error || 'Erro ao importar aprovação.';

      if (data.error === 'curso_nao_encontrado') {
        msg = 'Combinação VEST + código de curso não encontrada no cadastro de cursos do vestibular.';
      } else if (data.error === 'duplicidade_aprovacao') {
        msg = 'Já existe uma aprovação oficial para este aluno com esse curso/lista.';
      } else if (data.error === 'ja_importado') {
        msg = 'Esta aprovação já foi importada anteriormente.';
      }

      M.toast({ html: msg, classes: 'red darken-2' });
      return;
    }

    const linha = document.querySelector(`tr[data-id="${id}"]`);
    if (linha) {
      const tdCurso  = linha.querySelector('.col-curso-txt');
      const tdInst   = linha.querySelector('.col-inst-txt');
      const tdStatus = linha.querySelector('.col-status');

      if (tdCurso)  tdCurso.textContent = data.curso || '';
      if (tdInst)   tdInst.textContent  = data.instituicao || '';
      if (tdStatus) tdStatus.innerHTML  =
        '<span class="new badge green col-status-badge" data-badge-caption="Conferido"></span>';
    }

    M.toast({
      html: 'Aprovação importada para o cadastro oficial.',
      classes: 'green darken-2'
    });

  } catch (e) {
    console.error('erro importar aprovacao:', e);
    M.toast({
      html: 'Erro de conexão ao importar aprovação.',
      classes: 'red darken-2'
    });
  }
}
</script>



</body>
</html>
