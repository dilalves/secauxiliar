<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Importar Aprovações • Aprove — Conferência de Aprovados</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root {
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3;
      --ink:#0f172a; --muted:#6b7280;
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w:260px; --topbar-h:64px;
    }

    html, body {height:100%; margin:0; font-family:'Roboto', sans-serif; background:var(--bg);}
    body {color:var(--ink);}
    .app {display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}

    header.topbar {
      position:fixed; top:0; left:0; right:0; height:var(--topbar-h); z-index:20;
      background:var(--primary); color:#fff; display:flex; align-items:center;
      padding:0 24px; box-shadow:0 2px 10px rgba(16,24,40,.12);
    }

    aside {
      background:#fff; border-right:1px solid var(--line);
      position:sticky; top:var(--topbar-h);
      height:calc(100vh - var(--topbar-h)); overflow:auto; z-index:6;
      padding-bottom:20px;
    }

    .menu {list-style:none; margin:0; padding:0 0 12px;}
    .menu a {display:block; padding:10px 22px; color:#111827; text-decoration:none; font-size:15px; transition:0.25s;}
    .menu a:hover {background:#f4f6fb; color:var(--primary);}
    .menu .active > a {background:#eef3ff; font-weight:600; color:var(--primary);}
    .menu-group {margin-bottom:12px;}
    .group-title {
      font-weight:700; color:#0b3b78; text-transform:uppercase;
      font-size:13px; letter-spacing:0.5px;
      padding:10px 20px 6px; border-top:1px solid #eef2f8;
    }

    main {display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page {padding:24px;}
    footer {text-align:center; font-size:13px; color:var(--muted); padding:16px 0 10px;}
    #unitLabel {font-size:14px; font-weight:500; color:#fff; opacity:0.9;}

    .card-import {
      padding:24px;
      border-radius:12px;
      box-shadow:0 10px 25px rgba(15,23,42,0.08);
    }

    .file-row {
      display:flex;
      align-items:center;
      gap:16px;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .file-name {
      flex:1;
      min-width:220px;
      padding:10px 12px;
      border-radius:6px;
      border:1px dashed #d1d5db;
      background:#f9fafb;
      font-size:14px;
      color:#4b5563;
    }

    .status-box {
      margin-top:18px;
      padding:12px 14px;
      border-radius:8px;
      background:#f9fafb;
      border:1px solid #e5e7eb;
      font-size:14px;
      color:#374151;
      min-height:42px;
      white-space:pre-line;
    }

    @media (max-width:992px){
      .app{grid-template-columns:1fr;}
      aside{display:none;}
    }
  </style>
</head>
<body>
<div class="app">
  <!-- ===== SIDEBAR ===== -->
  <aside>
    <div class="center" style="padding:18px 0 8px;">
      <span class="title" style="font-weight:700; color:#0b3b78">Aprove</span>
    </div>

    <ul class="menu">
      <li><a href="/aprove/painel.html">Início</a></li>

      <li class="menu-group">
        <div class="group-title">Atualizações</div>
        <ul>
          <li><a href="/aprove/aprovacoes.html">Aprovações</a></li>
          <li><a href="/aprove/alunos.html">Alunos</a></li>
          <li><a href="/aprove/instituicoes.html">Instituições</a></li>
          <li><a href="/aprove/cursos.html">Cursos</a></li>
          <li><a href="/aprove/unidades.html">Unidades</a></li>
          <li><a href="/aprove/autorizacoes.html">Autorização de Imagem</a></li>
          <li><a href="/aprove/vestibulares.html">Listas de Aprovados</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Ferramentas</div>
        <ul>
          <li><a href="/aprove/conferir_listas.html">Conferir Listas</a></li>
          <li class="active"><a href="/aprove/importar_aprovacoes.html">Importar Aprovações</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Relatórios</div>
        <ul>
          <li><a href="/aprove/convocados2fase.html">Convocados 2ª Fase</a></li>
          <li><a href="/aprove/aprovados_rel.html">Aprovados</a></li>
          <li><a href="/aprove/porcentagem_lista.html">Porcentagem Lista</a></li>
          <li><a href="/aprove/totais_curso.html">Totais por Curso</a></li>
          <li><a href="/aprove/totais_instituicao.html">Totais por Instituição</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- ===== MAIN ===== -->
  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px; width:auto;">
          <h5 style="margin:0; font-weight:600;">
            Aprove — Conferência de Aprovados — <span id="unitLabel">—</span>
          </h5>
        </div>
        <div style="display:flex; align-items:center;">
          <a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">Sair</a>
        </div>
      </div>
    </header>

    <section class="page">
      <h4 style="color:#0b3b78; font-weight:600;">Envio de arquivo de aprovações</h4>
      <p class="grey-text text-darken-1">
        Envie o arquivo <b>CSV</b> gerado pelo programa de conferência de listas.
        <b>Importante:</b> somente serão importadas combinações de vestibular/curso que existirem
        na tabela <code>vestibular_cursos</code>, e registros já existentes em <code>aprovacoes</code>
        serão ignorados.
      </p>

      <div class="card card-import z-depth-0">
        <!-- Seleção de arquivo -->
        <div class="file-row">
          <input type="file" id="arquivo" accept=".csv,text/csv" style="display:none;">
          <button class="btn blue darken-2" type="button" onclick="document.getElementById('arquivo').click();">
            Selecionar arquivo CSV
          </button>
          <div class="file-name" id="arquivoNome">Escolha o arquivo CSV de resultado</div>
        </div>

        <!-- Listagem (ano) -->
        <div class="input-field" style="max-width:200px;">
          <input id="listagem" type="text" value="2026" disabled>
          <label class="active" for="listagem">Listagem (ano)</label>
        </div>

        <!-- Botão importar -->
        <div style="margin-top:18px;">
          <button class="btn blue darken-2" type="button" onclick="importarAprovacoes()">
            Importar aprovações
          </button>
        </div>

        <!-- Status -->
        <div class="status-box" id="statusBox">
          Sessão pronta. Selecione o arquivo CSV e clique em "Importar aprovações".
        </div>

        <!-- Erros de vestibular/curso -->
        <div class="status-box" id="errosVestCursos" style="display:none; margin-top:10px;">
          <!-- preenchido via JS -->
        </div>
      </div>
    </section>

    <footer>Desenvolvido por 3A Sistemas — Adilson Alves © 2025</footer>
  </main>
</div>

<script>
  const API       = 'https://apisec.secauxiliar.com.br/aprove/';
  const LOGIN_URL = '/aprove/index.html';

  function setStatus(msg) {
    document.getElementById('statusBox').textContent = msg;
  }

  async function logout(){
    try { await fetch(API + 'auth_login_out.php', { credentials:'include' }); }
    catch(_) {}
    location.replace(LOGIN_URL);
  }

  async function carregarUsuario() {
    try {
      const res  = await fetch(API + 'auth_me.php', { credentials:'include' });
      if (res.status === 401) {
        M.toast({ html:'Sessão expirada. Faça login novamente.' });
        setStatus('Sessão expirada. Faça login novamente.');
        setTimeout(()=> location.href = LOGIN_URL, 1500);
        return;
      }
      const data = await res.json();
      if (data.ok && data.user) {
        const nome  = data.user.nome  ?? 'Usuário';
        const login = data.user.login ?? '';
        document.getElementById('unitLabel').textContent = `${login} — ${nome}`;
      } else {
        setStatus('Sessão expirada. Faça login novamente.');
        setTimeout(()=> location.href = LOGIN_URL, 1500);
      }
    } catch (e) {
      setStatus('Erro de conexão com o servidor de autenticação.');
    }
  }

  // atualização do nome do arquivo
  document.addEventListener('DOMContentLoaded', () => {
    const inp = document.getElementById('arquivo');
    const lbl = document.getElementById('arquivoNome');
    inp.addEventListener('change', () => {
      if (inp.files && inp.files.length) {
        lbl.textContent = inp.files[0].name;
      } else {
        lbl.textContent = 'Escolha o arquivo CSV de resultado';
      }
    });
  });

  async function importarAprovacoes(){
    const fileInput = document.getElementById('arquivo');
    const listagem = document.getElementById('listagem').value.trim() || '2026';
    const errosDiv = document.getElementById('errosVestCursos');

    errosDiv.style.display = 'none';
    errosDiv.textContent = '';

    if (!fileInput.files || !fileInput.files.length) {
      M.toast({ html:'Selecione o arquivo CSV de resultado primeiro.' });
      return;
    }

    const fd = new FormData();
    fd.append('file', fileInput.files[0]);
    fd.append('listagem', listagem);

    setStatus('Enviando arquivo para o servidor...');

    try {
      const resp = await fetch(API + 'import_aprovacoes.php', {
        method: 'POST',
        body: fd,
        credentials: 'include'
      });

      if (resp.status === 401) {
        M.toast({ html:'Sessão expirada. Faça login novamente.' });
        setStatus('Sessão expirada. Faça login novamente.');
        setTimeout(()=> location.href = LOGIN_URL, 1500);
        return;
      }

      const data = await resp.json().catch(()=> ({}));

      if (data.ok) {
        const total   = data.linhas_total   ?? 0;
        const validas = data.linhas_validas ?? 0;
        const imp     = data.importados     ?? 0;
        const dup     = data.duplicados     ?? 0;
        const ano     = data.listagem       ?? listagem;
        const erros   = data.erros_vest_curso || [];

        let msg =
          `Importação concluída.\n` +
          `Linhas no arquivo: ${total} | Linhas válidas: ${validas} | ` +
          `Registros importados: ${imp} | Já existentes (ignorados): ${dup} | ` +
          `Listagem: ${ano}.`;

        if (erros.length > 0) {
          msg += `\n\nForam encontradas ${erros.length} combinações de vestibular/curso ` +
                 `inexistentes em VESTIBULAR_CURSOS. Veja abaixo para corrigir o CSV e importar novamente.`;
        }

        setStatus(msg);
        M.toast({ html:'Importação concluída.' });

        // Monta lista de erros de vest/codcurso, se houver
        if (erros.length > 0) {
          let html = '<strong>Códigos de vestibular/curso inválidos:</strong><br><ul style="margin-top:6px;">';
          erros.forEach(item => {
            html += `<li>Vestibular (CODLISTA): <b>${item.vest}</b> &nbsp;•&nbsp; ` +
                    `Curso (CODCURSO): <b>${item.codcurso}</b> &nbsp;—&nbsp; ` +
                    `Ocorrências no CSV: <b>${item.ocorrencias}</b></li>`;
          });
          html += '</ul>';

          errosDiv.innerHTML = html;
          errosDiv.style.display = 'block';
        }

      } else {
        const msg = data.error || 'Erro ao processar o arquivo no servidor.';
        setStatus(msg);
        M.toast({ html: msg });
      }

    } catch (e) {
      console.error(e);
      setStatus('Falha na comunicação com o servidor.');
      M.toast({ html:'Falha na comunicação com o servidor.' });
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    M.AutoInit();
    carregarUsuario();
  });
</script>
</body>
</html>
