<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico"/>
  <title>Autorização de Imagem • Aprove — Conferência de Aprovados</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3;
      --ink:#0f172a; --muted:#6b7280;
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w:260px; --topbar-h:64px;
    }
    html, body {height:100%; margin:0; font-family:'Roboto', sans-serif; background:var(--bg);}
    body {color:var(--ink);}
    .app {display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}
    header.topbar {
      position:fixed; top:0; left:0; right:0; height:var(--topbar-h); z-index:20;
      background:var(--primary); color:#fff; display:flex; align-items:center;
      padding:0 24px; box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    aside {
      background:#fff; border-right:1px solid var(--line);
      position:sticky; top:var(--topbar-h);
      height:calc(100vh - var(--topbar-h)); overflow:auto; z-index:6;
      padding-bottom:20px;
    }
    .menu {list-style:none; margin:0; padding:0 0 12px;}
    .menu a {display:block; padding:10px 22px; color:#111827; text-decoration:none; font-size:15px; transition:0.25s;}
    .menu a:hover {background:#f4f6fb; color:var(--primary);}
    .menu .active > a {background:#eef3ff; font-weight:600; color:var(--primary);}
    .menu-group {margin-bottom:12px;}
    .group-title {
      font-weight:700; color:#0b3b78; text-transform:uppercase;
      font-size:13px; letter-spacing:0.5px;
      padding:10px 20px 6px; border-top:1px solid #eef2f8;
    }
    main {display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page {padding:24px;}
    footer {text-align:center; font-size:13px; color:var(--muted); padding:16px 0 10px;}

    /* card */
    .card { border-radius:14px; }
    .section-title { font-weight:600; color:#0b3b78; margin-bottom:8px; }

    /* dropzone */
    #dropzone{
      border:2px dashed #cbd5e1; border-radius:12px; padding:28px;
      text-align:center; background:#fff; cursor:pointer;
    }
    #dropzone.dragover{ background:#eef6ff; border-color:#60a5fa; }
    .progress{ height:8px; border-radius:999px; }
    .cpf-badge { font-family: monospace; margin-left:10px; }
    @media (max-width:992px){.app{grid-template-columns:1fr;} aside{display:none;}}
  </style>
</head>

<body>
<div class="app">
  <!-- ===== SIDEBAR ===== -->
  <aside>
    <div class="center" style="padding:18px 0 8px;">
      <span class="title" style="font-weight:700; color:#0b3b78">Aprove</span>
    </div>

    <ul class="menu">
      <li><a href="/aprove/painel.html">Início</a></li>

      <li class="menu-group">
        <div class="group-title">Atualizações</div>
        <ul>
          <li><a href="/aprove/aprovacoes.html">Aprovações</a></li>
          <li><a href="/aprove/alunos.html">Alunos</a></li>
          <li><a href="/aprove/instituicoes.html">Instituições</a></li>
          <li><a href="/aprove/cursos.html">Cursos</a></li>
          <li><a href="/aprove/unidades.html">Unidades</a></li>
          <li class="active"><a href="/aprove/autorizacoes.html">Autorização de Imagem</a></li>
          <li><a href="/aprove/vestibulares.html">Listas de Aprovados</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Ferramentas</div>
        <ul>
          <li><a href="/aprove/conferir_listas.html">Conferir Listas</a></li>
          <li><a href="/aprove/importar_aprovacoes.html">Importar Aprovações</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Relatórios</div>
        <ul>
          <li><a href="/aprove/convocados2fase.html">Convocados 2ª Fase</a></li>
          <li><a href="/aprove/aprovados_rel.html">Aprovados</a></li>
          <li><a href="/aprove/porcentagem_lista.html">Porcentagem Lista</a></li>
          <li><a href="/aprove/totais_curso.html">Totais por Curso</a></li>
          <li><a href="/aprove/totais_instituicao.html">Totais por Instituição</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- ===== MAIN ===== -->
  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px; width:auto;">
          <h5 style="margin:0; font-weight:600;">
            Aprove — Conferência de Aprovados — <span id="unitLabel">—</span>
          </h5>
        </div>
        <div><a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">Sair</a></div>
      </div>
    </header>

    <section class="page">
      <h4 class="section-title">Autorização de Imagem</h4>

      <!-- Card: Cadastro / criação da pasta -->
      <div class="card z-depth-0" style="padding:20px; margin-top:8px;">
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s12 m6">
            <input id="cpf" type="text" maxlength="14" placeholder="000.000.000-00">
            <label for="cpf">CPF do aluno</label>
            <span class="helper-text">Digite o CPF e clique <b>Salvar / Criar pasta</b>.</span>
          </div>

          <div class="col s12 m6" style="margin-top:18px">
            <div class="switch" style="margin-right:16px">
              <label>Foto<input id="flag_foto" type="checkbox"><span class="lever"></span></label>
            </div>
            <div class="switch" style="margin-right:16px">
              <label>Entrevista<input id="flag_entrevista" type="checkbox"><span class="lever"></span></label>
            </div>
            <div class="switch">
              <label>Publicidade<input id="flag_publicidade" type="checkbox"><span class="lever"></span></label>
            </div>
          </div>

          <div class="input-field col s12">
            <textarea id="observacao" class="materialize-textarea" data-length="3000"
              placeholder="Ex.: publicado no Instagram em 03/11; enviado para Lúcia; saiu no jornal X"></textarea>
            <label for="observacao">Observação</label>
          </div>

          <div class="col s12">
            <button id="btnSalvar" class="btn waves-effect waves-light">
              <i class="material-icons left">save</i>Salvar / Criar pasta
            </button>
            <span id="cpfInfo" class="new badge cpf-badge" data-badge-caption="" style="display:none"></span>
          </div>
        </div>
      </div>

      <!-- Card: Upload + lista -->
      <div class="card z-depth-0" id="cardUpload" style="padding:20px; display:none">
        <span class="section-title" style="display:block; margin-bottom:12px">Arquivos da Autorização</span>

        <div id="dropzone" class="z-depth-0">
          <i class="material-icons large">cloud_upload</i>
          <p>Arraste arquivos aqui ou clique para selecionar</p>
          <p class="grey-text">PDF, JPG, PNG, DOC, DOCX — máx. 20MB por arquivo</p>
          <input id="fileInput" type="file" multiple style="display:none">
        </div>

        <div id="progressWrap" class="section" style="display:none">
          <div class="progress"><div id="progressBar" class="determinate" style="width:0%"></div></div>
          <div id="progressText" class="grey-text"></div>
        </div>

        <ul id="fileList" class="collection" style="margin-top:12px"></ul>
      </div>
    </section>

    <footer>Desenvolvido por 3A Sistemas — Adilson Alves © 2025</footer>
  </main>
</div>

<script>
  // === API base
  const API = 'https://apisec.secauxiliar.com.br/aprove/';

  // === Helpers/UI
  const $ = s => document.querySelector(s);
  const toast = msg => M.toast({html: msg});
  const digits = v => (v||'').replace(/\D+/g,'');
  function maskCPF(v){
    v = digits(v).slice(0,11);
    return v.replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d)/, '$1.$2')
            .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  }
  function fmtBytes(x){ const u=['B','KB','MB','GB']; let i=0,n=+x; while(n>=1024&&i<u.length-1){n/=1024;i++;} return `${n.toFixed(n<10&&i?1:0)} ${u[i]}`; }
  function iconByMime(m){ if(!m) return 'insert_drive_file'; if(m.includes('pdf')) return 'picture_as_pdf'; if(m.includes('image/')) return 'image'; if(m.includes('word')) return 'description'; return 'insert_drive_file'; }

  // === Topbar
  async function carregarUsuario(){
    try{
      const r = await fetch(API+'auth_me.php', {credentials:'include'});
      const j = await r.json();
      if(j.ok && j.user){
        $('#unitLabel').textContent = `${j.user.login ?? ''} — ${j.user.nome ?? 'Usuário'}`;
      }
    }catch{ $('#unitLabel').textContent = '—'; }
  }
  async function logout(){
    try{ await fetch(API+'auth_login_out.php',{credentials:'include'}); }catch(_){}
    location.replace('/aprove/index.html');
  }

  // === Elementos
  const cpfInput = $('#cpf');
  const flag_foto = $('#flag_foto');
  const flag_entrevista = $('#flag_entrevista');
  const flag_publicidade = $('#flag_publicidade');
  const observacao = $('#observacao');
  const btnSalvar = $('#btnSalvar');
  const cardUpload = $('#cardUpload');
  const dropzone = $('#dropzone');
  const fileInput = $('#fileInput');
  const fileList = $('#fileList');
  const progressWrap = $('#progressWrap');
  const progressBar = $('#progressBar');
  const progressText = $('#progressText');
  const cpfInfo = $('#cpfInfo');

  // Máscara CPF
  cpfInput.addEventListener('input', () => { cpfInput.value = maskCPF(cpfInput.value); });

  // Salvar/CRiar pasta
  btnSalvar.addEventListener('click', async () => {
    const cpf = digits(cpfInput.value);
    if (cpf.length !== 11) return toast('CPF inválido.');

    const payload = {
      cpf_aluno: cpf,
      foto: +flag_foto.checked,
      entrevista: +flag_entrevista.checked,
      publicidade: +flag_publicidade.checked,
      observacao: (observacao.value||'').trim()
    };

    try{
      const r = await fetch(API+'api/autoriza/create.php', {
        method:'POST', credentials:'include',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'Falha ao salvar');

      toast('Autorização salva. Pasta pronta.');
      cardUpload.style.display = '';
      cpfInfo.style.display = '';
      cpfInfo.textContent = maskCPF(cpf);
      await loadFilesByCPF(cpf);
    }catch(e){ toast('Erro: '+e.message); }
  });

  // Dropzone
  dropzone.addEventListener('click', () => fileInput.click());
  ['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, e => { e.preventDefault(); dropzone.classList.remove('dragover'); }));
  dropzone.addEventListener('drop', e => { if(e.dataTransfer.files?.length) uploadFiles(e.dataTransfer.files); });
  fileInput.addEventListener('change', () => { if(fileInput.files?.length) uploadFiles(fileInput.files); });

  // Upload com progresso (via XHR)
  async function uploadFiles(files){
    const cpf = digits(cpfInput.value);
    if (cpf.length !== 11){ toast('CPF inválido.'); return; }

    const fd = new FormData();
    fd.append('cpf_aluno', cpf);
    Array.from(files).forEach(f => fd.append('f'+Math.random(), f));

    progressWrap.style.display = '';
    progressBar.style.width = '0%';
    progressText.textContent = 'Enviando...';

    try{
      await xhrUpload(API+'api/autoriza/upload.php', fd, (loaded,total)=>{
        const pct = total ? Math.round(loaded/total*100) : 0;
        progressBar.style.width = pct+'%';
        progressText.textContent = `Enviado ${fmtBytes(loaded)} de ${fmtBytes(total)} (${pct}%)`;
      });
      toast('Upload concluído.');
      await loadFilesByCPF(cpf);
    }catch(e){ toast('Erro no upload: '+e.message); }
    finally{ progressWrap.style.display = 'none'; fileInput.value=''; }
  }
  function xhrUpload(url, formData, onProgress){
    return new Promise((resolve, reject)=>{
      const xhr = new XMLHttpRequest();
      xhr.open('POST', url, true);
      xhr.withCredentials = true;
      xhr.upload.onprogress = e => { if(onProgress) onProgress(e.loaded, e.total); };
      xhr.onload = () => {
        try{ const j = JSON.parse(xhr.responseText||'{}'); j.ok ? resolve(j) : reject(new Error(j.error||'Falha no upload')); }
        catch(err){ reject(err); }
      };
      xhr.onerror = () => reject(new Error('Erro de rede'));
      xhr.send(formData);
    });
  }

  // Listagem
  async function loadFilesByCPF(cpf){
    try{
      const r = await fetch(API+`api/autoriza/list_files.php?cpf_aluno=${cpf}`, {credentials:'include'});
      const j = await r.json();
      if(!j.ok) throw new Error(j.error || 'Falha ao listar');

      // refletir flags/obs do servidor
      if (j.autorizacao){
        flag_foto.checked = !!Number(j.autorizacao.foto);
        flag_entrevista.checked = !!Number(j.autorizacao.entrevista);
        flag_publicidade.checked = !!Number(j.autorizacao.publicidade);
        if (!(observacao.value||'').trim()) observacao.value = j.autorizacao.observacao || '';
        M.textareaAutoResize(observacao);
      }

      renderFiles(j.files||[]);
      cardUpload.style.display = '';
    }catch(e){ toast('Erro ao listar: '+e.message); }
  }
  function renderFiles(files){
    fileList.innerHTML = '';
    if(!files.length){ fileList.innerHTML = '<li class="collection-item">Nenhum arquivo enviado ainda.</li>'; return; }
    files.forEach(f=>{
      const li = document.createElement('li');
      li.className = 'collection-item avatar';
      li.innerHTML = `
        <i class="material-icons circle">${iconByMime(f.mime_type)}</i>
        <span class="title" style="font-weight:600">${f.nome_original}</span>
        <p class="grey-text">${f.mime_type} • ${fmtBytes(f.tamanho_bytes)}<br>
          <small>Enviado em ${new Date(f.uploaded_at.replace(' ','T')).toLocaleString()}</small>
        </p>
        <span class="secondary-content">${(f.caminho_relativo||'').split('/').pop()}</span>
      `;
      fileList.appendChild(li);
    });
  }

  // Init
  document.addEventListener('DOMContentLoaded', ()=>{
    M.CharacterCounter.init(document.querySelectorAll('#observacao'));
    carregarUsuario();
  });
</script>
</body>
</html>
