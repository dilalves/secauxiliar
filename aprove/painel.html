<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Painel â€¢ Aprove â€” ConferÃªncia de Aprovados</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3; --ink:#0f172a; --muted:#6b7280; 
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w: 260px;
      --topbar-h: 64px;
    }

    html,body{height:100%}
    body{background:var(--bg); color:var(--ink)}

    .app{display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}

    header.topbar{
      position: fixed; top: 0; left: 0; right: 0; height: var(--topbar-h); z-index: 20;
      background: var(--primary); color:#fff; display:flex; align-items:center;
      padding: 0 24px; box-shadow:0 2px 10px rgba(16,24,40,.12);
    }

    aside{
      background:#fff; border-right:1px solid var(--line); 
      position: sticky; top: var(--topbar-h);
      height: calc(100vh - var(--topbar-h)); overflow:auto; z-index:6;
    }

    main{display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page{padding:24px}

    .card{border-radius:14px; box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .card-title{font-weight:600}
    .muted{color:var(--muted)}
    .menu{list-style:none; padding:0; margin:0}
    .menu a{display:block; padding:12px 16px; color:#111827}
    .menu a:hover{background:#f4f6fb}
    .menu .active>a{background:#eef3ff; font-weight:600}
    .menu .icon{font-size:20px; vertical-align:middle; margin-right:8px; color:#64748b}

    .value{font-size:22px; font-weight:700}
    .label{color:var(--muted); font-size:13px}
    @media (max-width: 992px){.app{grid-template-columns:1fr}}
  </style>
</head>

<body>
<div class="app">
  <!-- Sidebar -->
  <aside>
    <div class="center" style="padding:18px 0 8px">
      <span class="title" style="font-weight:700;color:#0b3b78">Aprove</span>
    </div>
    <ul class="menu">
      <li class="active"><a href="/aprove/painel.html"><span class="icon material-icons">dashboard</span>InÃ­cio</a></li>
      <li><a href="/aprove/aprovados.html"><span class="icon material-icons">school</span>Conferir Aprovados</a></li>
      <li><a href="/aprove/unidades.html"><span class="icon material-icons">domain</span>Unidades</a></li>
      <li><a href="/aprove/relatorios.html"><span class="icon material-icons">bar_chart</span>RelatÃ³rios</a></li>
    </ul>
  </aside>

  <!-- Main -->
  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px; width:auto;">
          <h5 style="margin:0; font-weight:600;">
            Aprove â€” ConferÃªncia de Aprovados â€” <span id="unitLabel">â€”</span>
          </h5>
        </div>
        <div style="display:flex; align-items:center;">
          <a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">
            <i class="material-icons left">exit_to_app</i>Sair
          </a>
        </div>
      </div>
    </header>

    <section class="page">
      <div class="row" style="margin-bottom:10px">
        <div class="col s12 m6 l3"><div class="card z-depth-0"><div class="card-content center">
          <div class="value" id="kpiTotal">â€”</div>
          <div class="label">Total de Aprovados</div>
        </div></div></div>

        <div class="col s12 m6 l3"><div class="card z-depth-0"><div class="card-content center">
          <div class="value" id="kpiNovos">â€”</div>
          <div class="label">Novos Cadastros</div>
        </div></div></div>

        <div class="col s12 m6 l3"><div class="card z-depth-0"><div class="card-content center">
          <div class="value" id="kpiConfirmados">â€”</div>
          <div class="label">Confirmados</div>
        </div></div></div>

        <div class="col s12 m6 l3"><div class="card z-depth-0"><div class="card-content center">
          <div class="value" id="kpiPendentes">â€”</div>
          <div class="label">Pendentes</div>
        </div></div></div>
      </div>

      <div class="row">
        <div class="col s12 m4">
          <div class="card hoverable center">
            <div class="card-content">
              <i class="material-icons">search</i>
              <div class="title" style="font-weight:700">Consultar Aprovados</div>
              <p class="grey-text">Ver lista de aprovados por unidade</p>
            </div>
            <div class="card-action">
              <a href="/aprove/aprovados.html" class="btn waves-effect waves-light blue darken-2">
                <i class="material-icons left">arrow_forward</i>Abrir
              </a>
            </div>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="card hoverable center">
            <div class="card-content">
              <i class="material-icons">domain</i>
              <div class="title" style="font-weight:700">Gerenciar Unidades</div>
              <p class="grey-text">Editar dados e resultados</p>
            </div>
            <div class="card-action">
              <a href="/aprove/unidades.html" class="btn-flat">Abrir</a>
            </div>
          </div>
        </div>

        <div class="col s12 m4">
          <div class="card hoverable center">
            <div class="card-content">
              <i class="material-icons">bar_chart</i>
              <div class="title" style="font-weight:700">RelatÃ³rios</div>
              <p class="grey-text">Visualizar estatÃ­sticas de aprovaÃ§Ãµes</p>
            </div>
            <div class="card-action">
              <a href="/aprove/relatorios.html" class="btn-flat">Abrir</a>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
const API = 'https://apisec.secauxiliar.com.br/aprove/';
const LOGIN_URL = '/aprove/index.html';

/* ===== RequisiÃ§Ã£o genÃ©rica (sempre envia cookie) ===== */
async function apiFetch(path, opts = {}) {
  const options = {
    method: opts.method || 'GET',
    headers: { 'Accept': 'application/json', ...(opts.headers || {}) },
    body: opts.body,
    credentials: 'include' // ðŸ”¥ envia o cookie da sessÃ£o
  };

  const res = await fetch(API + path, options).catch(() => null);
  if (!res) throw new Error('NETWORK_FAIL');
  if (res.status === 401 || res.status === 403) throw new Error('UNAUTHORIZED');
  if (!res.ok) throw new Error(`API_${res.status}`);
  return res.json();
}

/* ===== InicializaÃ§Ã£o do painel ===== */
document.addEventListener('DOMContentLoaded', initPainel);

async function initPainel(){
  try {
    const me = await apiFetch('auth_guard.php');
    if (!me.ok) throw new Error('UNAUTHORIZED');

    // Mostra "login - nome" no topo
    const user = me.user || {};
    const login = user.login || '';
    const nome  = user.nome  || '';
    document.getElementById('unitLabel').textContent =
      login && nome ? `${login} - ${nome}` : (login || nome || 'â€”');

    await carregarKPIs();
  } catch (err) {
    console.warn('SessÃ£o invÃ¡lida ou expirada', err);
    if (String(err.message).includes('UNAUTHORIZED')) {
      location.replace(LOGIN_URL);
    }
  }
}


/* ===== Carrega estatÃ­sticas bÃ¡sicas (exemplo) ===== */
async function carregarKPIs(){
  try {
    const r = await apiFetch('dashboard_stats.php', { method:'GET' });
    const d = r.data || {};
    const nf = new Intl.NumberFormat('pt-BR');
    document.getElementById('kpiTotal').textContent      = nf.format(d.total ?? 0);
    document.getElementById('kpiNovos').textContent      = nf.format(d.novos ?? 0);
    document.getElementById('kpiConfirmados').textContent= nf.format(d.confirmados ?? 0);
    document.getElementById('kpiPendentes').textContent  = nf.format(d.pendentes ?? 0);
  } catch(e) {
    console.error('Falha ao carregar KPIs', e);
  }
}

/* ===== Logout ===== */
async function logout(){
  try {
    await fetch(API + 'auth_login_out.php', { credentials:'include' });
  } catch(_) {}
  location.replace(LOGIN_URL);
}
</script>
</body>
</html>
