<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Invasores ENEM • Curso Objetivo</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top, #0b3b78 0%, #020617 45%, #000 100%);
      font-family: "Courier New", monospace;
      color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #wrapper {
      text-align: center;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 20px;
      letter-spacing: 3px;
      color: #facc15;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
    }
    h2 {
      margin: 0 0 12px;
      font-size: 12px;
      font-weight: normal;
      color: #cbd5f5;
    }
    canvas {
      border: 3px solid #facc15;
      image-rendering: pixelated;
      background: #000;
      display: block;
      margin: 0 auto 6px;
    }
    #controls {
      font-size: 11px;
      letter-spacing: 2px;
      color: #a5b4fc;
    }
  </style>
</head>
<body>
<div id="wrapper">
  <h1>INVASORES ENEM</h1>
  <h2>Aluno Objetivo vs. Chuva de Questões</h2>
  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <div id="controls">
    ← → MOVER&nbsp;&nbsp;|&nbsp;&nbsp;ESPAÇO: ATIRAR&nbsp;&nbsp;|&nbsp;&nbsp;ESPAÇO no GAME OVER: RECOMEÇAR
  </div>
</div>

<script>
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;

  const keys = {};
  document.addEventListener('keydown', (e) => {
    keys[e.code] = true;
    if (e.code === 'Space') e.preventDefault();
  });
  document.addEventListener('keyup', (e) => {
    keys[e.code] = false;
  });

  const W = canvas.width;
  const H = canvas.height;

  // JOGADOR (ALUNO OBJETIVO)
  const player = {
    x: W / 2 - 20,
    y: H - 70,
    w: 40,
    h: 20,
    speed: 5,
    cooldown: 0,
    lives: 3 // "simulados" de chance
  };

  // ALIENS (QUESTÕES)
  let aliens = [];
  let alienDx = 1.0;
  let alienSpeedBoost = 0;
  const alienConfig = {
    rows: 5,
    cols: 11,
    w: 36,
    h: 24,
    hSpacing: 15,
    vSpacing: 22,
    offsetX: 70,
    offsetY: 80
  };

  // BARREIRAS (SIMULADOS)
  let barriers = [];

  // TIROS
  let playerBullets = [];
  let alienBullets = [];

  // UFO TEMA DE REDAÇÃO (bônus)
  let temaUFO = null; // {x,y,w,h,dx,active}

  let score = 0;
  let highScore = Number(localStorage.getItem('enem_invaders_hs') || 0);
  let gameOver = false;
  let lastTime = 0;

  function initAliens() {
    aliens = [];
    let qNumber = 1;
    for (let row = 0; row < alienConfig.rows; row++) {
      for (let col = 0; col < alienConfig.cols; col++) {
        const x = alienConfig.offsetX + col * (alienConfig.w + alienConfig.hSpacing);
        const y = alienConfig.offsetY + row * (alienConfig.h + alienConfig.vSpacing);
        aliens.push({
          x,
          y,
          w: alienConfig.w,
          h: alienConfig.h,
          alive: true,
          row,
          col,
          q: qNumber  // número da questão
        });
        qNumber++;
      }
    }
    alienDx = 1.0 + alienSpeedBoost;
  }

  function initBarriers() {
    barriers = [];
    const barrierCount = 4;
    const barrierWidth = 80;
    const barrierHeight = 40;
    const gap = (W - barrierCount * barrierWidth) / (barrierCount + 1);
    const baseY = H - 170;

    for (let i = 0; i < barrierCount; i++) {
      const startX = gap + i * (barrierWidth + gap);
      const cols = 8;
      const rows = 4;
      const blockW = barrierWidth / cols;
      const blockH = barrierHeight / rows;
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          barriers.push({
            x: startX + c * blockW,
            y: baseY + r * blockH,
            w: blockW - 2,
            h: blockH - 2,
            hp: 3
          });
        }
      }
    }
  }

  function resetGame() {
    score = 0;
    player.lives = 3;
    player.x = W / 2 - player.w / 2;
    playerBullets = [];
    alienBullets = [];
    gameOver = false;
    alienSpeedBoost = 0;
    temaUFO = null;
    initAliens();
    initBarriers();
  }

  function shootPlayer() {
    if (player.cooldown <= 0) {
      playerBullets.push({
        x: player.x + player.w / 2 - 2,
        y: player.y,
        w: 4,
        h: 10,
        dy: -7
      });
      player.cooldown = 15;
    }
  }

  function shootAlien(alien) {
    alienBullets.push({
      x: alien.x + alien.w / 2 - 2,
      y: alien.y + alien.h,
      w: 4,
      h: 10,
      dy: 4
    });
  }

  function maybeSpawnTemaUFO() {
    if (temaUFO || Math.random() > 0.004) return;
    const dir = Math.random() < 0.5 ? 1 : -1;
    temaUFO = {
      w: 100,
      h: 26,
      y: 50,
      x: dir === 1 ? -110 : W + 10,
      dx: 2.2 * dir,
      active: true
    };
  }

  function rectsCollide(a, b) {
    return (
      a.x < b.x + b.w &&
      a.x + a.w > b.x &&
      a.y < b.y + b.h &&
      a.y + a.h > b.y
    );
  }

  function update(dt) {
    if (gameOver) {
      if (keys['Space']) {
        resetGame();
      }
      return;
    }

    // PLAYER
    if (keys['ArrowLeft']) {
      player.x -= player.speed;
    }
    if (keys['ArrowRight']) {
      player.x += player.speed;
    }
    if (player.x < 20) player.x = 20;
    if (player.x + player.w > W - 20) player.x = W - 20 - player.w;

    if (keys['Space']) {
      shootPlayer();
    }
    if (player.cooldown > 0) player.cooldown--;

    // TIROS
    playerBullets.forEach((b) => {
      b.y += b.dy;
    });
    playerBullets = playerBullets.filter((b) => b.y + b.h > 0);

    alienBullets.forEach((b) => {
      b.y += b.dy;
    });
    alienBullets = alienBullets.filter((b) => b.y < H + 20);

    // ALIENS MOVIMENTO
    let minX = Infinity;
    let maxX = -Infinity;
    let stepDown = false;

    aliens.forEach((a) => {
      if (!a.alive) return;
      a.x += alienDx * dt;
      if (a.x < minX) minX = a.x;
      if (a.x + a.w > maxX) maxX = a.x + a.w;
    });

    if (minX !== Infinity) {
      if (minX < 20 || maxX > W - 20) {
        stepDown = true;
      }
    }

    if (stepDown) {
      alienDx *= -1;
      aliens.forEach((a) => {
        if (!a.alive) return;
        a.y += 16;
        if (a.y + a.h >= player.y) {
          endGame("As questões chegaram até você!");
        }
      });
    }

    // ALIENS ATIRAM
    if (Math.random() < 0.02) {
      const cols = {};
      aliens.forEach((a) => {
        if (!a.alive) return;
        const col = a.col;
        if (!cols[col] || cols[col].y < a.y) cols[col] = a;
      });
      const colKeys = Object.keys(cols);
      if (colKeys.length > 0) {
        const randomCol = parseInt(colKeys[Math.floor(Math.random() * colKeys.length)], 10);
        shootAlien(cols[randomCol]);
      }
    }

    // TIRO PLAYER x ALIEN
    playerBullets.forEach((b) => {
      aliens.forEach((a) => {
        if (!a.alive) return;
        if (rectsCollide(b, a)) {
          a.alive = false;
          b.y = -100;
          score += 10;
          if (score > highScore) {
            highScore = score;
            localStorage.setItem('enem_invaders_hs', String(highScore));
          }
        }
      });
    });
    playerBullets = playerBullets.filter((b) => b.y > -50);

    // TIRO x BARREIRAS
    function hitBarriers(bullets) {
      bullets.forEach((b) => {
        for (let i = 0; i < barriers.length; i++) {
          const br = barriers[i];
          if (br.hp > 0 && rectsCollide(b, br)) {
            br.hp--;
            b.y = -9999;
            break;
          }
        }
      });
      return bullets.filter((b) => b.y > -5000);
    }

    playerBullets = hitBarriers(playerBullets);
    alienBullets = hitBarriers(alienBullets);

    // TIRO ALIEN x PLAYER
    alienBullets.forEach((b) => {
      if (rectsCollide(b, player)) {
        b.y = H + 100;
        player.lives--;
        if (player.lives <= 0) {
          endGame("Acabaram seus simulados!");
        } else {
          player.x = W / 2 - player.w / 2;
          playerBullets = [];
          alienBullets = [];
        }
      }
    });

    // LIMPA BARREIRAS MORTAS
    barriers = barriers.filter((br) => br.hp > 0);

    // CHECA FIM DA ONDA
    if (aliens.every((a) => !a.alive)) {
      alienSpeedBoost += 0.3;
      initAliens();
      initBarriers();
      score += 100;
      if (score > highScore) {
        highScore = score;
        localStorage.setItem('enem_invaders_hs', String(highScore));
      }
    }

    // UFO TEMA
    maybeSpawnTemaUFO();
    if (temaUFO && temaUFO.active) {
      temaUFO.x += temaUFO.dx;
      if (temaUFO.x < -150 || temaUFO.x > W + 150) {
        temaUFO = null;
      }
    }

    // TIRO PLAYER x UFO
    if (temaUFO && temaUFO.active) {
      playerBullets.forEach((b) => {
        if (rectsCollide(b, temaUFO)) {
          temaUFO.active = false;
          temaUFO = null;
          b.y = -999;
          score += 1000; // bônus tema de redação
          if (score > highScore) {
            highScore = score;
            localStorage.setItem('enem_invaders_hs', String(highScore));
          }
        }
      });
    }
  }

  function endGame(reason) {
    gameOver = true;
    if (score > highScore) {
      highScore = score;
      localStorage.setItem('enem_invaders_hs', String(highScore));
    }
    gameOverReason = reason;
  }

  let gameOverReason = "";

  function drawStarfield() {
    for (let i = 0; i < 80; i++) {
      const x = (i * 97) % W;
      const y = (i * 53) % H;
      ctx.fillStyle = i % 3 === 0 ? '#9ca3af' : '#4b5563';
      ctx.fillRect(x, y, 2, 2);
    }
  }

  function drawPlayer() {
    // "Aluno" em forma de nave
    ctx.fillStyle = '#38bdf8';
    ctx.fillRect(player.x, player.y + 6, player.w, player.h - 6);
    ctx.fillRect(player.x + player.w/2 - 5, player.y, 10, 8);
    ctx.fillRect(player.x + 4, player.y + player.h, 8, 6);
    ctx.fillRect(player.x + player.w - 12, player.y + player.h, 8, 6);

    // "O" no centro (Objetivo)
    ctx.strokeStyle = '#facc15';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(player.x + player.w/2, player.y + player.h/2, 6, 0, Math.PI*2);
    ctx.stroke();
  }

  function drawAliens() {
    aliens.forEach((a) => {
      if (!a.alive) return;
      const palette = ['#22c55e', '#a3e635', '#facc15', '#fb923c', '#f97316'];
      ctx.fillStyle = palette[a.row % palette.length];

      // corpo "cartão de questão"
      ctx.fillRect(a.x, a.y, a.w, a.h);
      ctx.fillStyle = '#111827';
      ctx.fillRect(a.x + 3, a.y + 3, a.w - 6, a.h - 6);

      // texto QXX
      const label = 'Q' + String(a.q).padStart(2, '0');
      ctx.fillStyle = '#facc15';
      ctx.font = '10px "Courier New"';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(label, a.x + a.w / 2, a.y + a.h / 2);
      ctx.textAlign = 'left';
    });
  }

  function drawBarriers() {
    // legenda "SIMULADOS" em cima das barreiras
    ctx.fillStyle = '#e5e7eb';
    ctx.font = '10px "Courier New"';
    ctx.textAlign = 'center';
    ctx.fillText('SIMULADOS PROTETORES', W / 2, H - 190);
    ctx.textAlign = 'left';

    barriers.forEach((br) => {
      if (br.hp <= 0) return;
      const colors = ['#4b5563', '#9ca3af', '#22c55e', '#bbf7d0'];
      ctx.fillStyle = colors[br.hp] || '#4b5563';
      ctx.fillRect(br.x, br.y, br.w, br.h);
    });
  }

  function drawBullets() {
    ctx.fillStyle = '#e5e7eb';
    playerBullets.forEach((b) => {
      ctx.fillRect(b.x, b.y, b.w, b.h);
    });

    ctx.fillStyle = '#ef4444';
    alienBullets.forEach((b) => {
      ctx.fillRect(b.x, b.y, b.w, b.h);
    });
  }

  function drawTemaUFO() {
    if (!temaUFO || !temaUFO.active) return;
    ctx.fillStyle = '#f97316';
    ctx.fillRect(temaUFO.x, temaUFO.y, temaUFO.w, temaUFO.h);

    ctx.fillStyle = '#111827';
    ctx.fillRect(temaUFO.x + 3, temaUFO.y + 3, temaUFO.w - 6, temaUFO.h - 6);

    ctx.fillStyle = '#facc15';
    ctx.font = '11px "Courier New"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('TEMA REDAÇÃO', temaUFO.x + temaUFO.w / 2, temaUFO.y + temaUFO.h / 2);
    ctx.textAlign = 'left';
  }

  function drawHUD() {
    ctx.fillStyle = '#020617';
    ctx.fillRect(0, 0, W, 40);

    ctx.fillStyle = '#facc15';
    ctx.font = '14px "Courier New"';
    ctx.textBaseline = 'top';

    const scoreText = 'PONTOS ' + score.toString().padStart(5, '0');
    const hiText = 'RECORDE ' + highScore.toString().padStart(5, '0');
    const livesText = 'SIMULADOS ' + player.lives;

    ctx.fillText(scoreText, 20, 12);
    ctx.fillText(hiText, W / 2 - ctx.measureText(hiText).width / 2, 12);
    ctx.fillText(livesText, W - ctx.measureText(livesText).width - 20, 12);

    ctx.fillRect(0, 40, W, 2);
  }

  function drawGameOver() {
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = '#f97316';
    ctx.font = '26px "Courier New"';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('FIM DE JOGO', W / 2, H / 2 - 50);

    ctx.fillStyle = '#facc15';
    ctx.font = '14px "Courier New"';
    ctx.fillText(gameOverReason || 'ENEM FOI INTENSO!', W / 2, H / 2 - 15);

    ctx.fillStyle = '#22c55e';
    ctx.fillText('PONTOS ' + score.toString().padStart(5, '0'), W / 2, H / 2 + 20);
    ctx.fillText('RECORDE ' + highScore.toString().padStart(5, '0'), W / 2, H / 2 + 45);

    ctx.fillStyle = '#e5e7eb';
    ctx.font = '11px "Courier New"';
    ctx.fillText('APERTE ESPAÇO PARA NOVA TENTATIVA', W / 2, H / 2 + 80);

    ctx.textAlign = 'left';
  }

  function loop(timestamp) {
    const dt = (timestamp - lastTime) / (1000 / 60) || 1;
    lastTime = timestamp;

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, W, H);
    drawStarfield();

    update(dt);
    drawAliens();
    drawBarriers();
    drawBullets();
    drawTemaUFO();
    drawPlayer();
    drawHUD();

    if (gameOver) {
      drawGameOver();
    }

    requestAnimationFrame(loop);
  }

  resetGame();
  requestAnimationFrame(loop);
</script>
</body>
</html>
