<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Aprovações • Aprove — Conferência de Aprovados</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root {
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3;
      --ink:#0f172a; --muted:#6b7280; 
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w:260px; --topbar-h:64px;
    }
    html, body {height:100%; margin:0; font-family:'Roboto', sans-serif; background:var(--bg);}
    body {color:var(--ink);}
    .app {display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}
    header.topbar {
      position:fixed; top:0; left:0; right:0; height:var(--topbar-h);
      background:var(--primary); color:#fff; display:flex; align-items:center;
      padding:0 24px; box-shadow:0 2px 10px rgba(16,24,40,.12);
      z-index:20;
    }
    aside {
      background:#fff; border-right:1px solid var(--line);
      position:sticky; top:var(--topbar-h);
      height:calc(100vh - var(--topbar-h)); overflow:auto; z-index:6;
    }
    .menu {list-style:none; margin:0; padding:0;}
    .menu a {display:block; padding:10px 22px; color:#111827; text-decoration:none; font-size:15px; transition:0.25s;}
    .menu a:hover {background:#f4f6fb; color:var(--primary);}
    .menu .active > a {background:#eef3ff; font-weight:600; color:var(--primary);}
    .group-title {
      font-weight:700; color:#0b3b78; text-transform:uppercase;
      font-size:13px; letter-spacing:0.5px;
      padding:10px 20px 6px; border-top:1px solid #eef2f8;
    }
    main {display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page {padding:24px;}
    footer {text-align:center; font-size:13px; color:#6b7280; padding:16px 0 10px;}
    #unitLabel {font-size:14px; font-weight:500; color:#fff; opacity:0.9;}
    table.striped th {background:#f2f5ff; color:#0b3b78; font-weight:600;}
    .helper {font-size:0.9rem;}
  </style>
</head>

<body>
  <div class="app">
  <!-- ===== SIDEBAR ===== -->
  <aside>
    <div class="center" style="padding:18px 0 8px;">
      <span class="title" style="font-weight:700; color:#0b3b78">Aprove</span>
    </div>

    <ul class="menu">
      <li><a href="/aprove/painel.html">Início</a></li>

      <li class="menu-group">
        <div class="group-title">Atualizações</div>
        <ul>
          <li class="active"><a href="/aprove/aprovacoes.html">Aprovações</a></li>
          <li><a href="/aprove/alunos.html">Alunos</a></li>
          <li><a href="/aprove/instituicoes.html">Instituições</a></li>
          <li><a href="/aprove/cursos.html">Cursos</a></li>
          <li><a href="/aprove/unidades.html">Unidades</a></li>
          <li><a href="/aprove/autorizacoes.html">Autorização de Imagem</a></li>
          <li><a href="/aprove/vestibulares.html">Listas de Aprovados</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Ferramentas</div>
        <ul>
          <li><a href="/aprove/conferir_listas.html">Conferir Listas</a></li>
          <li><a href="/aprove/importar_aprovacoes.html">Importar Aprovações</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Relatórios</div>
        <ul>
          <li><a href="/aprove/aprovados_rel.html">Aprovados</a></li>
          <li><a href="/aprove/totais_curso.html">Totais por Curso</a></li>
          <li><a href="/aprove/totais_instituicao.html">Totais por Instituição</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- ===== MAIN ===== -->
  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px; width:auto;">
          <h5 style="margin:0; font-weight:600;">Aprove — Conferência de Aprovados — <span id="unitLabel">—</span></h5>
        </div>
        <a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">Sair</a>
      </div>
    </header>

    <section class="page">
      <h4 style="color:#0b3b78; font-weight:600;">
        Cadastro de Aprovações — <span class="grey-text text-darken-1">Listagem 2026</span>
      </h4>
      <p class="grey-text text-darken-1">Informe os códigos e cadastre aprovações diretamente no sistema.</p>

      <div class="card z-depth-0" style="padding:20px; margin-top:20px;">
        <form id="form-aprovacao">
          <div class="row">
            <div class="input-field col s3">
              <input id="codaluno" name="codaluno" type="number" required>
              <label for="codaluno">Código do Aluno</label>
              <span id="nomeAluno" class="helper grey-text text-darken-1"></span>
            </div>
            <div class="input-field col s2">
              <input id="vest" name="vest" type="number" required>
              <label for="vest">Código do Vestibular</label>
              <span id="nomeVest" class="helper grey-text text-darken-1"></span>
            </div>
            <div class="input-field col s2">
              <input id="codcurso" name="codcurso" type="text" maxlength="10" required>
              <label for="codcurso">Código do Curso</label>
              <span id="nomeCurso" class="helper"></span>
            </div>
            <div class="input-field col s1">
              <input id="chamada" name="chamada" type="number" value="1" required>
              <label for="chamada">Chamada</label>
            </div>
            <div class="input-field col s1">
              <input id="colocacao" name="colocacao" type="number">
              <label for="colocacao">Colocação</label>
            </div>
          </div>
          <div class="row center-align">
            <!-- Botão agora identificado e desabilitado por padrão -->
            <button id="btnSalvar" type="submit" class="btn waves-effect waves-light blue darken-2" disabled>
              Salvar Aprovação
            </button>
          </div>
        </form>
        <div id="mensagem" class="center-align" style="margin-top:20px; font-weight:500;"></div>
      </div>

      <h5 class="section-title" style="color:#0b3b78; font-weight:600;">Minhas Aprovações</h5>
      <table class="striped highlight responsive-table" id="tabela-aprovacoes">
        <thead>
          <tr>
            <th>Aluno</th>
            <th>Série</th>
            <th>Unidade</th>
            <th>Curso</th>
            <th>Instituição</th>
            <th>Chamada</th>
            <th>Classificação</th>
            <th>Data</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p id="msg-lista" class="center grey-text">Nenhuma aprovação cadastrada ainda.</p>
    </section>

    <footer>Desenvolvido por 3A Sistemas — Adilson Alves © 2025</footer>
  </main>

  <!-- MODAL DE EDIÇÃO -->
  <div id="modal-editar" class="modal">
    <div class="modal-content">
      <h5 style="color:#0b3b78; font-weight:600;">Editar Aprovação</h5>
      <div id="edit-info" style="margin-bottom:20px; line-height:1.5;">
        <p><b>ID:</b> <span id="edit-id-label"></span></p>
        <p><b>Aluno:</b> <span id="edit-nomeAluno"></span></p>
        <p><b>Cód. Vestibular:</b> <span id="edit-vest"></span></p>
        <p><b>Chamada:</b> <span id="edit-chamada"></span></p>
      </div>

      <form id="form-editar">
        <input type="hidden" id="edit-id">
        <div class="input-field">
          <input id="edit-codcurso" type="text" required>
          <label for="edit-codcurso">Código do Curso</label>
          <span id="edit-nomeCurso" class="helper"></span>
        </div>
        <div class="input-field">
          <input id="edit-colocacao" type="number">
          <label for="edit-colocacao">Colocação</label>
        </div>
        <div class="right-align" style="margin-top:20px;">
          <a href="#!" class="btn red lighten-1" onclick="excluirAprovacao()">
            <i class="material-icons left">delete</i>Excluir
          </a>
          <button type="submit" class="btn blue darken-2">
            <i class="material-icons left">save</i>Salvar
          </button>
        </div>
      </form>
    </div>
  </div>

</div>

<script>
const API = 'https://apisec.secauxiliar.com.br/aprove/';
const LOGIN_URL = '/aprove/index.html';
let usuarioAtual = '';
let cursoValido = false; // controla a habilitação
const $ = sel => document.querySelector(sel);

async function logout(){
  try { await fetch(API + 'auth_login_out.php', { credentials:'include' }); }
  catch(_) {}
  location.replace(LOGIN_URL);
}

async function carregarUsuario(){
  try {
    const res = await fetch(API + 'auth_me.php', { credentials:'include' });
    const data = await res.json();
    if (data.ok && data.user){
      usuarioAtual = data.user.login;
      $('#unitLabel').textContent = `${usuarioAtual} — ${data.user.nome}`;
      carregarAprovacoes();
    }
  } catch(e){
    $('#unitLabel').textContent = '— Erro de conexão';
  }
}

/* ===== Helpers de habilitação ===== */
function enableSalvar(){
  const alunoOk = $('#codaluno').value.trim() !== '';
  const vestOk  = $('#vest').value.trim()     !== '';
  const cursoOk = $('#codcurso').value.trim() !== '' && cursoValido === true;
  $('#btnSalvar').disabled = !(alunoOk && vestOk && cursoOk);
}

/* Valida curso no vestibular (atualiza helper e cursoValido) */
async function validarCurso(vest, codcurso, helperEl){
  cursoValido = false;
  helperEl.textContent = '';
  helperEl.classList.remove('green-text','red-text','text-darken-1');

  if(!vest || !codcurso){
    enableSalvar();
    return;
  }
  try{
    const r = await fetch(`${API}buscar_curso.php?vest=${encodeURIComponent(vest)}&codcurso=${encodeURIComponent(codcurso)}`, {credentials:'include'});
    const j = await r.json();
    if(j && j.ok){
      helperEl.textContent = `${j.curso} (${j.instituicao})`;
      helperEl.classList.add('green-text','text-darken-1');
      cursoValido = true;
    }else{
      helperEl.textContent = 'Curso não encontrado neste vestibular';
      helperEl.classList.add('red-text','text-darken-1');
      cursoValido = false;
    }
  }catch(e){
    helperEl.textContent = 'Erro ao verificar curso';
    helperEl.classList.add('red-text','text-darken-1');
    cursoValido = false;
  }finally{
    enableSalvar();
  }
}

/* === BUSCAS AUTOMÁTICAS === */
$('#codaluno').addEventListener('input', async e=>{
  const val = e.target.value.trim();
  if(!val){ $('#nomeAluno').textContent=''; enableSalvar(); return; }
  const res = await fetch(`${API}buscar_aluno.php?id=${val}`, {credentials:'include'});
  const data = await res.json();
  $('#nomeAluno').textContent = data.ok ? data.nome : 'Aluno não encontrado';
  enableSalvar();
});

$('#vest').addEventListener('input', async e=>{
  const val = e.target.value.trim();
  if(!val){
    $('#nomeVest').textContent='';
    // mudando o vestibular, revalide o curso
    validarCurso('', $('#codcurso').value.trim(), $('#nomeCurso'));
    return;
  }
  const res = await fetch(`${API}buscar_vestibular.php?id=${val}`, {credentials:'include'});
  const data = await res.json();
  $('#nomeVest').textContent = data.ok
    ? `${data.instituicao} — ${data.semestre}º semestre / ${data.listagem}`
    : 'Vestibular não encontrado';

  // sempre revalida o curso quando muda o vest
  await validarCurso(val, $('#codcurso').value.trim(), $('#nomeCurso'));
});

$('#codcurso').addEventListener('input', async e=>{
  await validarCurso($('#vest').value.trim(), e.target.value.trim(), $('#nomeCurso'));
});

/* === ENVIO DO FORM === */
document.getElementById('form-aprovacao').addEventListener('submit', async e=>{
  e.preventDefault();

  // segurança extra
  if(!cursoValido){
    M.toast({html:'Informe um curso válido para este vestibular.', classes:'red'});
    enableSalvar();
    return;
  }

  const formData = Object.fromEntries(new FormData(e.target).entries());
  formData.listagem = 2026;

  const res = await fetch(API + 'aprovacoes_insert.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify(formData)
  });

  const data = await res.json();
    const msg = document.getElementById('mensagem');
    if (msg) { msg.textContent = ''; } // some a mensagem fixa

    if (data.ok){
    M.toast({ html: 'Aprovação registrada com sucesso!' });
    resetFormUI();               // << limpa tudo, inclusive nomes
    carregarAprovacoes();
    return;
    } else {
    M.toast({ html: data.msg || 'Falha ao salvar.', classes: 'red' });
    }

});

/* === LISTAGEM === */
async function carregarAprovacoes(){
  const tbody = document.querySelector('#tabela-aprovacoes tbody');
  tbody.innerHTML = '';
  $('#msg-lista').textContent = 'Carregando...';
  try {
    const res = await fetch(API + 'aprovacoes_list.php?user=' + encodeURIComponent(usuarioAtual), {credentials:'include'});
    const data = await res.json();
    if(data.ok && data.rows.length){
      $('#msg-lista').textContent = '';
      data.rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.nome_aluno}</td>
          <td>${r.serie || '-'}</td>
          <td>${r.unidade || '-'}</td>
          <td>${r.curso}</td>
          <td>${r.instituicao}</td>
          <td>${r.chamada}</td>
          <td>${r.colocacao || '-'}</td>
          <td>${r.created_at}</td>
          <td>
            <a href="#modal-editar" class="btn-small blue lighten-1 modal-trigger" 
              onclick="abrirEdicao(${r.id}, ${r.vest}, '${r.codcurso}', '${(r.colocacao||'')}', ${r.chamada}, '${r.nome_aluno.replace(/'/g, "\\'")}')">
              <i class='material-icons'>edit</i>
            </a>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } else {
      $('#msg-lista').textContent = 'Nenhuma aprovação cadastrada.';
    }
  } catch(e){
    $('#msg-lista').textContent = 'Erro ao carregar aprovações.';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  carregarUsuario();
  M.Modal.init(document.querySelectorAll('.modal'));

    ['codaluno','vest','codcurso','chamada','colocacao'].forEach(id=>{
    const el = document.getElementById(id);
    if (!el) return;
    el.addEventListener('input', ()=>{
        const msg = document.getElementById('mensagem');
        if (msg) msg.textContent = '';
    });
    });

});

/* ===== Modal de edição ===== */
function abrirEdicao(id, vest, codcurso, colocacao, chamada, nomeAluno){
  $('#edit-id').value = id;
  $('#edit-id-label').textContent = id;
  $('#edit-codcurso').value = codcurso || '';
  $('#edit-nomeCurso').textContent = '';
  $('#edit-colocacao').value = colocacao || '';
  $('#edit-vest').textContent = vest || '-';
  $('#edit-chamada').textContent = chamada || '-';
  $('#edit-nomeAluno').textContent = nomeAluno || 'Aluno não identificado';
  M.updateTextFields();
}

// valida curso no modal (somente helper visual)
$('#edit-codcurso').addEventListener('change', async e=>{
  const codcurso = e.target.value.trim();
  const vest = $('#edit-vest').textContent.trim();
  const helper = $('#edit-nomeCurso');

  if(!codcurso || !vest){
    helper.textContent = 'Informe o código do curso e o vestibular.';
    helper.classList.add('red-text');
    return;
  }

  try{
    const res = await fetch(`${API}buscar_curso.php?vest=${vest}&codcurso=${codcurso}`, {credentials:'include'});
    const data = await res.json();
    helper.classList.remove('green-text','red-text');
    if(data.ok){
      helper.textContent = `${data.curso} (${data.instituicao})`;
      helper.classList.add('green-text');
    } else {
      helper.textContent = 'Curso não encontrado neste vestibular.';
      helper.classList.add('red-text');
    }
  }catch(err){
    helper.textContent = 'Erro ao verificar curso.';
    helper.classList.add('red-text');
  }
});

// Salvar alterações do modal
document.getElementById('form-editar').addEventListener('submit', async e=>{
  e.preventDefault();
  const dados = {
    id: $('#edit-id').value,
    codcurso: $('#edit-codcurso').value.trim(),
    colocacao: $('#edit-colocacao').value.trim()
  };

  const res = await fetch(API + 'aprovacoes_update.php', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'include',
    body:JSON.stringify(dados)
  });
  const data = await res.json();
  M.toast({html:data.msg, classes:data.ok?'green':'red'});
  if(data.ok){
    const modal = M.Modal.getInstance(document.getElementById('modal-editar'));
    modal.close();
    carregarAprovacoes();
  }
});

// Excluir
async function excluirAprovacao(){
  const id = $('#edit-id').value;
  if(!confirm('Deseja realmente excluir esta aprovação?')) return;
  const res = await fetch(API + 'aprovacoes_delete.php?id=' + id, {credentials:'include'});
  const data = await res.json();
  M.toast({html:data.msg, classes:data.ok?'green':'red'});
  if(data.ok){
    const modal = M.Modal.getInstance(document.getElementById('modal-editar'));
    modal.close();
    carregarAprovacoes();
  }
}

function resetFormUI(){
  const f = document.getElementById('form-aprovacao');
  if (!f) return;

  // limpa campos
  f.reset();

  // limpa helpers e mensagem
  ['nomeAluno','nomeVest','nomeCurso','mensagem'].forEach(id=>{
    const el = document.getElementById(id);
    if (el){
      el.textContent = '';
      el.style.color = ''; // remove verde/vermelho
    }
  });

  // remove classes de validação dos inputs
  ['codaluno','vest','codcurso','chamada','colocacao'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.classList.remove('valid','invalid');
  });

  // desabilita o botão até nova validação
  const btn = document.querySelector('#form-aprovacao button[type="submit"]');
  if (btn) btn.disabled = true;

  M.updateTextFields();
}


</script>
</body>
</html>
