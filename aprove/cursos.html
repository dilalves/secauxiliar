<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cursos • Aprove</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root{
      --primary:#0b3b78;
      --bg:#f3f4f6;
      --card:#ffffff;
      --line:#e5e7eb;
      --ink:#0f172a;
      --muted:#6b7280;
      --radius:14px;
    }
    body{ background:var(--bg); color:var(--ink); }
    .topbar{ background:var(--primary); padding:14px 18px; color:#fff; display:flex; align-items:center; justify-content:space-between; }
    .topbar .brand{ font-weight:700; letter-spacing:.2px; }
    .layout{ display:grid; grid-template-columns: 240px 1fr; min-height:calc(100vh - 52px); }
    aside{ background:#fff; border-right:1px solid var(--line); padding:12px 10px; }
    main{ padding:24px; }
    .cardx{ background:var(--card); border-radius:var(--radius); border:1px solid var(--line); box-shadow:0 6px 18px rgba(15,23,42,.06); }
    .cardx .hd{ padding:18px 18px 0; }
    .cardx .bd{ padding:18px; }
    h4{ margin:0 0 6px 0; font-weight:800; color:var(--primary); }
    .sub{ color:var(--muted); margin:0 0 18px 0; }

    table.striped>tbody>tr:nth-child(odd){ background:#fafafa; }
    table thead th{ color:var(--primary); font-weight:800; }
    .btn-primary{ background:var(--primary) !important; }
    .btn-green{ background:#2e7d32 !important; }
    .btn-blue{ background:#1976d2 !important; }

    /* Modal */
    .modal { border-radius:16px; max-height:86%; }
    .modal .modal-content { padding:22px 22px 10px; }
    .modal .modal-footer { padding:10px 18px 18px; }
    .modal h5{ margin:0 0 10px 0; font-weight:900; color:var(--primary); }

    /* Inputs no modo tabela */
    .tform input[type="text"]{
      margin:0; height:2.4rem;
    }
    .tform td{ padding:10px 10px; vertical-align:middle; }
    .tform .mini{ width:90px; }
    .tform .status-cell{ width:90px; text-align:center; color:var(--muted); }
    .tform .actions-cell{ width:120px; text-align:center; }
    .manual-wrap{ display:flex; gap:10px; align-items:center; }
    .manual-wrap label{ margin:0; }
    .manual-wrap span{ font-size:13px; color:var(--muted); }

    /* Materialize select dentro da tabela */
    .tform .select-wrapper{ margin:0; }
    .tform .select-wrapper input.select-dropdown{ margin:0; height:2.4rem; line-height:2.4rem; }

    /* Sidebar simples (placeholder) */
    .navitem{ display:block; padding:10px 12px; border-radius:10px; color:#111827; }
    .navitem:hover{ background:#f1f5f9; }
    .navitem.active{ background:#eaf2ff; color:#0b3b78; font-weight:800; }

    @media (max-width: 992px){
      .layout{ grid-template-columns: 1fr; }
      aside{ display:none; }
      main{ padding:14px; }
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">Aprove — Conferência de Aprovados</div>
    <a href="sair.php" class="btn btn-small red lighten-1">Sair</a>
  </div>

  <div class="layout">
    <aside>
      <a class="navitem" href="index.html">Início</a>
      <div style="height:10px"></div>
      <div style="padding:8px 12px; color:var(--muted); font-weight:800; font-size:12px;">ATUALIZAÇÕES</div>
      <a class="navitem" href="aprovacoes.html">Aprovações</a>
      <a class="navitem" href="alunos.html">Alunos</a>
      <a class="navitem" href="instituicoes.html">Instituições</a>
      <a class="navitem active" href="cursos.html">Cursos</a>
      <a class="navitem" href="unidades.html">Unidades</a>
      <a class="navitem" href="autorizacao_imagem.html">Autorização de Imagem</a>
      <a class="navitem" href="listas.html">Listas de Aprovados</a>

      <div style="height:14px"></div>
      <div style="padding:8px 12px; color:var(--muted); font-weight:800; font-size:12px;">FERRAMENTAS</div>
      <a class="navitem" href="conferir.html">Conferir Listas</a>
      <a class="navitem" href="importar.html">Importar Aprovações</a>

      <div style="height:14px"></div>
      <div style="padding:8px 12px; color:var(--muted); font-weight:800; font-size:12px;">RELATÓRIOS</div>
      <a class="navitem" href="rel_convocados.html">Convocados 2ª Fase</a>
      <a class="navitem" href="rel_aprovados.html">Aprovados</a>
      <a class="navitem" href="rel_percent.html">Porcentagem Lista</a>
      <a class="navitem" href="rel_totais_curso.html">Totais por Curso</a>
      <a class="navitem" href="rel_totais_instituicao.html">Totais por Instituição</a>
    </aside>

    <main>
      <div class="cardx">
        <div class="hd">
          <h4>Cadastro de Cursos</h4>
          <p class="sub">Pesquise cursos ou visualize todos.</p>
        </div>

        <div class="bd">
          <div class="row" style="margin-bottom:8px;">
            <div class="input-field col s12 m8 l9" style="margin:0;">
              <i class="material-icons prefix">search</i>
              <input id="q" type="text" placeholder="Buscar por nome ou código..." />
            </div>

            <div class="col s12 m4 l3 right-align" style="margin-top:6px;">
              <a class="btn btn-blue" id="btn-buscar"><i class="material-icons left">search</i>Buscar</a>
              <a class="btn btn-green" id="btn-novo-curso"><i class="material-icons left">add</i>Novo Curso</a>
            </div>
          </div>

          <div style="border-top:1px solid var(--line); margin:12px 0 0;"></div>

          <div style="overflow:auto;">
            <table class="striped highlight" id="tbl">
              <thead>
                <tr>
                  <th style="width:110px;">Código</th>
                  <th style="width:240px;">Curso</th>
                  <th>Extenso</th>
                  <th style="width:220px;">Grupo</th>
                  <th style="width:110px;">Exclusivo</th>
                  <th style="width:140px;">Ações</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <!-- preenchido via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- MODAL NOVO -->
      <div id="modal-novo" class="modal">
        <div class="modal-content">
          <h5>Novo Curso</h5>

          <div style="overflow:auto;">
            <table class="tform" id="tabela-novo">
              <thead>
                <tr>
                  <th style="width:170px;">Código</th>
                  <th style="width:220px;">Curso</th>
                  <th>Nome Extenso</th>
                  <th style="width:220px;">Grupo</th>
                  <th style="width:110px; text-align:center;">Exclusivo</th>
                  <th class="actions-cell">Ações</th>
                  <th class="status-cell">Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- linhas dinâmicas -->
              </tbody>
            </table>
          </div>

          <div class="right-align" style="margin-top:10px;">
            <a class="btn btn-small btn-green" id="btn-nova-linha"><i class="material-icons left">add</i>Nova linha</a>
          </div>
        </div>

        <div class="modal-footer">
          <a href="#!" class="modal-close btn-flat">Fechar</a>
        </div>
      </div>

      <!-- MODAL EDITAR (placeholder, se você já tiver o seu, pode manter) -->
      <div id="modal-editar" class="modal">
        <div class="modal-content">
          <h5>Editar Curso</h5>
          <p style="color:var(--muted); margin-top:0;">
            (Se você já tem seu modal de edição, pode colar aqui e manter suas funções.)
          </p>
        </div>
        <div class="modal-footer">
          <a href="#!" class="modal-close btn-flat">Fechar</a>
        </div>
      </div>

    </main>
  </div>

<script>
/** ========= CONFIG =========
 * Ajuste a base dos seus endpoints PHP:
 * - Se seus PHPs estão na mesma pasta: './api/'
 * - Se estão em '/aprove/api/': '/aprove/api/'
 */
const API = './api/'; // <<< AJUSTE AQUI SE PRECISAR

let novoSeq = 0;
let gruposCache = [];
let gruposOptionsHtml = '';

/** ========= INIT ========= */
document.addEventListener('DOMContentLoaded', () => {
  M.Modal.init(document.querySelectorAll('.modal'), { dismissible:true });

  const btnNovo = document.getElementById('btn-novo-curso');
  if (btnNovo) btnNovo.addEventListener('click', (e) => { e.preventDefault(); abrirNovo(); });

  const btnNovaLinha = document.getElementById('btn-nova-linha');
  if (btnNovaLinha) btnNovaLinha.addEventListener('click', async (e) => { e.preventDefault(); await addLinhaNovo(); });

  const btnBuscar = document.getElementById('btn-buscar');
  if (btnBuscar) btnBuscar.addEventListener('click', (e) => { e.preventDefault(); carregarLista(); });

  const q = document.getElementById('q');
  if (q) q.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); carregarLista(); }
  });

  carregarLista();
});

/** ========= HELPERS ========= */
function escapeHtml(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

async function fetchJson(url, opts = {}){
  const res = await fetch(url, { credentials:'include', ...opts });
  const txt = await res.text();
  try { return JSON.parse(txt); }
  catch { return { ok:false, error:'Resposta inválida do servidor.', raw:txt }; }
}

/** ========= LISTA =========
 * Ajuste aqui para o seu endpoint real de listagem.
 * Se você já tem um, troque somente a URL e o formato do retorno.
 */
async function carregarLista(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = `<tr><td colspan="6" style="color:#6b7280;padding:16px;">Carregando...</td></tr>`;

  const termo = (document.getElementById('q').value || '').trim();

  // >>> Troque para seu endpoint de listagem real:
  // Ex.: const data = await fetchJson(API+'cursos_list.php?q='+encodeURIComponent(termo));
  // Aqui deixei um stub amigável:
  const data = await fetchJson(API+'cursos_list.php?q='+encodeURIComponent(termo));

  if(!data.ok){
    tbody.innerHTML = `<tr><td colspan="6" style="color:#b91c1c;padding:16px;">${escapeHtml(data.error || 'Falha ao carregar')}</td></tr>`;
    return;
  }

  const rows = data.rows || [];
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" style="color:#6b7280;padding:16px;">Nenhum registro.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => `
    <tr>
      <td>${escapeHtml(r.ID)}</td>
      <td>${escapeHtml(r.CURSO)}</td>
      <td>${escapeHtml(r.EXTENSO)}</td>
      <td>${escapeHtml(r.GRUPO)}</td>
      <td>${(String(r.EXCLUSIVO) === '1' || r.EXCLUSIVO === true) ? 'Sim' : 'Não'}</td>
      <td>
        <a class="btn btn-small btn-blue" onclick="abrirEditar('${escapeHtml(r.ID)}')">Editar</a>
      </td>
    </tr>
  `).join('');
}

/** ========= MODAL NOVO ========= */
async function abrirNovo(){
  const elModal = document.getElementById('modal-novo');
  if(!elModal){ M.toast({html:'Modal #modal-novo não encontrado.'}); return; }

  let modal = M.Modal.getInstance(elModal);
  if(!modal) modal = M.Modal.init(elModal, {dismissible:true});

  document.querySelector('#tabela-novo tbody').innerHTML = '';
  novoSeq = 0;

  await carregarGrupos();
  await addLinhaNovo();

  modal.open();
}

async function carregarGrupos(){
  const data = await fetchJson(API+'cursos_grupos_list.php');
  gruposCache = (data.ok && data.rows) ? data.rows.map(x => x.GRUPO) : [];
  gruposOptionsHtml = gruposCache
    .map(g => `<option value="${escapeHtml(g)}">${escapeHtml(g)}</option>`)
    .join('');
}

function toggleIdManual(idx){
  const chk = document.getElementById(`novo-id-manual-${idx}`);
  const idEl = document.getElementById(`novo-id-${idx}`);
  if(!chk || !idEl) return;

  idEl.readOnly = !chk.checked;
  idEl.disabled = false;

  if(!chk.checked) idEl.value = '';
  if(chk.checked) idEl.focus();
}

async function addLinhaNovo(){
  const tbody = document.querySelector('#tabela-novo tbody');
  const idx = ++novoSeq;

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <div class="manual-wrap">
        <input id="novo-id-${idx}" class="mini" type="text" readonly placeholder="auto">
        <label>
          <input type="checkbox" id="novo-id-manual-${idx}" onchange="toggleIdManual(${idx})">
          <span>Manual</span>
        </label>
      </div>
    </td>

    <td><input id="novo-curso-${idx}" type="text" placeholder="Ex: Quím."></td>

    <td><input id="novo-extenso-${idx}" type="text" placeholder="Ex: Química Industrial"></td>

    <td>
      <select id="novo-grupo-${idx}">
        <option value="">—</option>
        ${gruposOptionsHtml}
      </select>
    </td>

    <td style="text-align:center;">
      <label>
        <input type="checkbox" id="novo-exclusivo-${idx}">
        <span></span>
      </label>
    </td>

    <td class="actions-cell">
      <a class="btn btn-small btn-blue" onclick="salvarNovo(${idx})">Salvar</a>
    </td>

    <td id="status-${idx}" class="status-cell">—</td>
  `;

  tbody.appendChild(tr);

  // Init select (Materialize)
  const sel = tr.querySelector('select');
  if(sel) M.FormSelect.init(sel);

  tr.querySelector(`#novo-curso-${idx}`).focus();
}

/** ========= SALVAR NOVO =========
 * Envia ID apenas se "Manual" estiver marcado.
 * Se não, o backend gera (2412+) pela seq.
 */
async function salvarNovo(idx){
  const curso   = document.getElementById(`novo-curso-${idx}`).value.trim();
  const extenso = document.getElementById(`novo-extenso-${idx}`).value.trim();

  const grupoEl = document.getElementById(`novo-grupo-${idx}`);
  const grupo   = (grupoEl ? (grupoEl.value || '') : '').trim();

  const exclusivo = document.getElementById(`novo-exclusivo-${idx}`).checked ? 1 : 0;

  const status = document.getElementById(`status-${idx}`);

  const idEl = document.getElementById(`novo-id-${idx}`);
  const chkManual = document.getElementById(`novo-id-manual-${idx}`);
  const idManual = (chkManual && chkManual.checked) ? (idEl?.value || '').trim() : '';

  if(!curso){
    M.toast({html:'Preencha o campo Curso.'});
    return;
  }

  if(chkManual && chkManual.checked){
    if(!idManual){
      M.toast({html:'Informe o Código (manual).'});
      return;
    }
    if(!/^\d+$/.test(idManual)){
      M.toast({html:'Código manual inválido (apenas números).'});
      return;
    }
  }

  status.textContent = 'Salvando...';

  const fd = new FormData();
  if(chkManual && chkManual.checked) fd.append('ID', idManual); // ativa modo manual no PHP
  fd.append('CURSO', curso);
  fd.append('EXTENSO', extenso);
  fd.append('GRUPO', grupo);
  fd.append('EXCLUSIVO', exclusivo);

  const data = await fetchJson(API+'cursos_insert.php', { method:'POST', body:fd });

  if(data.ok){
    // mostra o ID retornado
    if(idEl && data.id) idEl.value = data.id;

    status.innerHTML = '<span style="color:green;font-weight:800;">OK</span>';

    // desabilita campos
    [`novo-id-${idx}`, `novo-id-manual-${idx}`, `novo-curso-${idx}`, `novo-extenso-${idx}`, `novo-grupo-${idx}`, `novo-exclusivo-${idx}`]
      .forEach(id => {
        const el = document.getElementById(id);
        if(el) el.disabled = true;
      });

    // re-init select para refletir disabled bonitinho
    if (grupoEl && grupoEl.tagName === 'SELECT') {
      const inst = M.FormSelect.getInstance(grupoEl);
      if (inst) inst.destroy();
      M.FormSelect.init(grupoEl);
    }

    // cria próxima linha
    await addLinhaNovo();

    // atualiza lista principal (opcional)
    // carregarLista();
  } else {
    const msg = data.error ? String(data.error) : 'Erro';
    status.innerHTML = `<span style="color:#b91c1c;font-weight:800;">${escapeHtml(msg)}</span>`;
  }
}

/** ========= EDITAR (placeholder) ========= */
function abrirEditar(id){
  const el = document.getElementById('modal-editar');
  let modal = M.Modal.getInstance(el);
  if(!modal) modal = M.Modal.init(el, {dismissible:true});
  modal.open();
}
</script>
</body>
</html>
