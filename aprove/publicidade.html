<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Autorizações • Publicidade • Aprove</title>

  <!-- Materialize -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <style>
    :root {
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3;
      --ink:#0f172a; --muted:#6b7280;
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w:260px; --topbar-h:64px;
    }
    html, body {height:100%; margin:0; font-family:'Roboto', sans-serif; background:var(--bg);}
    body {color:var(--ink);}
    .app {display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}
    header.topbar{
      position:fixed; top:0; left:0; right:0; height:var(--topbar-h);
      background:var(--primary); color:#fff; display:flex; align-items:center;
      padding:0 24px; box-shadow:0 2px 10px rgba(16,24,40,.12);
      z-index:20;
    }
    aside{
      background:#fff; border-right:1px solid var(--line);
      position:sticky; top:var(--topbar-h);
      height:calc(100vh - var(--topbar-h)); overflow:auto; z-index:6;
    }
    .menu {list-style:none; margin:0; padding:0;}
    .menu a {display:block; padding:10px 22px; color:#111827; text-decoration:none; font-size:15px; transition:0.25s;}
    .menu a:hover {background:#f4f6fb; color:var(--primary);}
    .menu .active > a {background:#eef3ff; font-weight:600; color:var(--primary);}
    .menu-group ul{ margin:0; padding:0; }
    .group-title{
      font-weight:700; color:#0b3b78; text-transform:uppercase;
      font-size:13px; letter-spacing:0.5px;
      padding:10px 20px 6px; border-top:1px solid #eef2f8;
    }
    main {display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page {padding:24px;}
    footer {text-align:center; font-size:13px; color:#6b7280; padding:16px 0 10px;}
    #unitLabel {font-size:14px; font-weight:500; color:#fff; opacity:0.9;}
    table.striped th {background:#f2f5ff; color:#0b3b78; font-weight:600;}
    .helper {font-size:0.9rem;}
    .badge-soft{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px;
      background:#eef3ff; color:#0b3b78; font-weight:600; font-size:12px;
    }
    .toolbar{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      margin:12px 0 14px;
    }
    .toolbar .input-field{ margin:0; }
    .right-tools{ margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    @media (max-width:992px){
      .app{grid-template-columns:1fr;}
      aside{display:none;}
      .right-tools{ margin-left:0; width:100%; justify-content:flex-start; }
    }
  </style>
</head>

<body>
<div class="app">
  <!-- ===== SIDEBAR ===== -->
  <aside>
    <div class="center" style="padding:18px 0 8px;">
      <span class="title" style="font-weight:700; color:#0b3b78">Aprove</span>
    </div>

    <ul class="menu">
      <li><a href="/aprove/painel.html">Início</a></li>

      <li class="menu-group">
        <div class="group-title">Atualizações</div>
        <ul>
          <li><a href="/aprove/aprovacoes.html">Aprovações</a></li>
          <li><a href="/aprove/alunos.html">Alunos</a></li>
          <li><a href="/aprove/instituicoes.html">Instituições</a></li>
          <li><a href="/aprove/cursos.html">Cursos</a></li>
          <li><a href="/aprove/unidades.html">Unidades</a></li>
          <li><a href="/aprove/autorizacoes.html">Autorização de Imagem</a></li>
          <li><a href="/aprove/vestibulares.html">Listas de Aprovados</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Ferramentas</div>
        <ul>
          <li><a href="/aprove/conferir_listas.html">Conferir Listas</a></li>
          <li><a href="/aprove/importar_aprovacoes.html">Importar Aprovações</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Relatórios</div>
        <ul>
          <li><a href="/aprove/convocacoes_geral.html">Convocados 2ª Fase</a></li>
          <li><a href="/aprove/aprovacoes_geral.html">Aprovados</a></li>
          <li><a href="/aprove/porcentagem_lista.html">Porcentagem Lista</a></li>
          <li><a href="/aprove/totais_curso.html">Totais por Curso</a></li>
          <li><a href="/aprove/totais_instituicao.html">Totais por Instituição</a></li>
          <!-- NOVO RELATÓRIO -->
          <li class="active"><a href="/aprove/autorizacoes_publicidade.html">Autorizações • Publicidade</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- ===== MAIN ===== -->
  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px; width:auto;">
          <h5 style="margin:0; font-weight:600;">
            Aprove — Conferência de Aprovados — <span id="unitLabel">—</span>
          </h5>
        </div>
        <a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">Sair</a>
      </div>
    </header>

    <section class="page">
      <h4 style="color:#0b3b78; font-weight:600;">
        Relatório — Autorizações com <b>Publicidade</b>
      </h4>
      <p class="grey-text text-darken-1" style="margin-top:4px;">
        Lista de autorizações marcadas com <b>publicidade=1</b> (CPF, nome, série, unidade e data de atualização).
      </p>

      <div class="card z-depth-0" style="padding:18px 20px; margin-top:16px;">
        <div class="toolbar">
          <span class="badge-soft">
            <span>Total:</span> <span id="kpiTotal">—</span>
          </span>

          <div class="input-field" style="flex:1; min-width:260px; max-width:520px;">
            <input id="q" type="text" placeholder="Filtrar por CPF, nome, série ou unidade">
          </div>

          <div class="right-tools">
            <button id="btnAtualizar" class="btn blue darken-2 waves-effect waves-light">
              Atualizar
            </button>
            <button id="btnCsv" class="btn-flat waves-effect">
              Exportar CSV
            </button>
          </div>
        </div>

        <table class="striped highlight responsive-table" id="tabela-publicidade">
          <thead>
            <tr>
              <th>CPF</th>
              <th>Nome</th>
              <th>Série</th>
              <th>Unidade</th>
              <th>Atualizado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <p id="msg-lista" class="center grey-text" style="margin:14px 0 4px;">
          Carregando...
        </p>
      </div>
    </section>

    <footer>Desenvolvido por 3A Sistemas — Adilson Alves © 2025</footer>
  </main>
</div>

<script>
const API = 'https://apisec.secauxiliar.com.br/aprove/';
const LOGIN_URL = '/aprove/index.html';
const ENDPOINT_REL = API + 'publicidade_list.php'; // <<< ajuste se o nome do PHP for outro

let usuarioAtual = '';
let ROWS_ALL = [];

const $ = sel => document.querySelector(sel);

async function logout(){
  try { await fetch(API + 'auth_login_out.php', { credentials:'include' }); }
  catch(_) {}
  location.replace(LOGIN_URL);
}

async function carregarUsuario(){
  try {
    const res = await fetch(API + 'auth_me.php', { credentials:'include' });
    const data = await res.json();
    if (data.ok && data.user){
      usuarioAtual = data.user.login;
      $('#unitLabel').textContent = `${usuarioAtual} — ${data.user.nome}`;
      await carregarRelatorio();
      return;
    }
    // se não logou, joga pro login
    location.replace(LOGIN_URL);
  } catch(e){
    $('#unitLabel').textContent = '— Erro de conexão';
  }
}

/* ===== Helpers ===== */
const digits = v => (v||'').toString().replace(/\D+/g,'');

function maskCPF(v){
  v = digits(v).slice(0,11);
  if (v.length !== 11) return v;
  return v.replace(/(\d{3})(\d)/, '$1.$2')
          .replace(/(\d{3})(\d)/, '$1.$2')
          .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
}

function toISOish(d){
  // aceita "YYYY-mm-dd HH:ii:ss" ou ISO
  const s = (d||'').toString().trim();
  if (!s) return '';
  return s.includes('T') ? s : s.replace(' ', 'T');
}

function fmtDataHora(d){
  const s = toISOish(d);
  if (!s) return '-';
  const dt = new Date(s);
  if (isNaN(dt.getTime())) return (d||'').toString();
  return dt.toLocaleString();
}

function normalizeStr(s){
  return (s||'').toString().toLowerCase();
}

function escapeCsv(v){
  const s = (v??'').toString();
  if (/[",\n;]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}

/* ===== Carrega dados ===== */
async function carregarRelatorio(){
  const tbody = document.querySelector('#tabela-publicidade tbody');
  tbody.innerHTML = '';
  $('#msg-lista').textContent = 'Carregando...';
  $('#kpiTotal').textContent = '—';

  try{
    const res = await fetch(ENDPOINT_REL, { credentials:'include' });
    const data = await res.json();

    if (!data.ok) throw new Error(data.error || 'Falha ao carregar');

    ROWS_ALL = Array.isArray(data.rows) ? data.rows : [];
    $('#kpiTotal').textContent = ROWS_ALL.length.toString();

    renderTabela(filtrarLocal($('#q').value));
  }catch(e){
    ROWS_ALL = [];
    $('#kpiTotal').textContent = '0';
    $('#msg-lista').textContent = 'Erro ao carregar relatório.';
    M.toast({ html: 'Erro: ' + e.message, classes:'red' });
  }
}

/* ===== Filtro local ===== */
function filtrarLocal(q){
  q = normalizeStr(q).trim();
  if (!q) return ROWS_ALL;

  return ROWS_ALL.filter(r=>{
    const cpf = normalizeStr(maskCPF(r.CPF || r.cpf || r.cpf_aluno || ''));
    const nome = normalizeStr(r.NOME || r.nome || '');
    const serie = normalizeStr(r.SERIE || r.serie || '');
    const und = normalizeStr(r.UNIDADE || r.unidade || '');
    return (cpf.includes(q) || nome.includes(q) || serie.includes(q) || und.includes(q));
  });
}

/* ===== Render ===== */
function renderTabela(rows){
  const tbody = document.querySelector('#tabela-publicidade tbody');
  tbody.innerHTML = '';

  if (!rows || !rows.length){
    $('#msg-lista').textContent = 'Nenhuma autorização com publicidade=1.';
    return;
  }

  $('#msg-lista').textContent = '';

  rows.forEach(r=>{
    const cpf = maskCPF(r.CPF || r.cpf || r.cpf_aluno || '');
    const nome = (r.NOME || r.nome || '-');
    const serie = (r.SERIE || r.serie || '-');
    const unidade = (r.UNIDADE || r.unidade || '-');
    const updated = fmtDataHora(r.updated_at || r.UPDATED_AT || r.atualizado || '');

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${cpf || '-'}</td>
      <td>${nome}</td>
      <td>${serie}</td>
      <td>${unidade}</td>
      <td>${updated}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== CSV ===== */
function exportarCSV(rows){
  const header = ['CPF','NOME','SERIE','UNIDADE','UPDATED_AT'];
  const lines = [header.join(';')];

  rows.forEach(r=>{
    const cpf = maskCPF(r.CPF || r.cpf || r.cpf_aluno || '');
    const nome = (r.NOME || r.nome || '');
    const serie = (r.SERIE || r.serie || '');
    const unidade = (r.UNIDADE || r.unidade || '');
    const updated = (r.updated_at || r.UPDATED_AT || '');

    lines.push([
      escapeCsv(cpf),
      escapeCsv(nome),
      escapeCsv(serie),
      escapeCsv(unidade),
      escapeCsv(updated)
    ].join(';'));
  });

  const csv = '\uFEFF' + lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'autorizacoes_publicidade.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===== Eventos ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  carregarUsuario();

  $('#btnAtualizar').addEventListener('click', carregarRelatorio);

  $('#q').addEventListener('input', ()=>{
    const rows = filtrarLocal($('#q').value);
    renderTabela(rows);
    $('#kpiTotal').textContent = rows.length.toString();
  });

  $('#q').addEventListener('keydown', (e)=>{
    if (e.key === 'Enter') e.preventDefault();
  });

  $('#btnCsv').addEventListener('click', ()=>{
    const rows = filtrarLocal($('#q').value);
    exportarCSV(rows);
  });
});
</script>
</body>
</html>
