<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Autorizações • Publicidade • Aprove</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb; --card:#ffffff; --line:#e9edf3;
      --ink:#0f172a; --muted:#6b7280;
      --primary:#0b3b78; --accent:#2563eb;
      --aside-w:260px; --topbar-h:64px;
    }
    html, body {height:100%; margin:0; font-family:'Roboto', sans-serif; background:var(--bg);}
    body{color:var(--ink);}
    .app{display:grid; grid-template-columns: var(--aside-w) 1fr; min-height:100vh;}
    header.topbar{
      position:fixed; top:0; left:0; right:0; height:var(--topbar-h); z-index:20;
      background:var(--primary); color:#fff; display:flex; align-items:center;
      padding:0 24px; box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    aside{
      background:#fff; border-right:1px solid var(--line);
      position:sticky; top:var(--topbar-h);
      height:calc(100vh - var(--topbar-h)); overflow:auto; z-index:6;
      padding-bottom:20px;
    }
    .menu{list-style:none; margin:0; padding:0 0 12px;}
    .menu a{display:block; padding:10px 22px; color:#111827; text-decoration:none; font-size:15px; transition:.25s;}
    .menu a:hover{background:#f4f6fb; color:var(--primary);}
    .menu .active > a{background:#eef3ff; font-weight:600; color:var(--primary);}
    .menu-group{margin-bottom:12px;}
    .group-title{
      font-weight:700; color:#0b3b78; text-transform:uppercase;
      font-size:13px; letter-spacing:.5px;
      padding:10px 20px 6px; border-top:1px solid #eef2f8;
    }
    main{display:flex; flex-direction:column; padding-top:calc(var(--topbar-h) + 8px);}
    .page{padding:24px;}
    footer{text-align:center; font-size:13px; color:var(--muted); padding:16px 0 10px;}
    .card{border-radius:14px;}
    table.striped th{background:#f2f5ff; color:#0b3b78; font-weight:600;}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      background:#eef3ff; color:#0b3b78; border-radius:999px;
      padding:5px 10px; font-weight:600; font-size:12px;
    }
    .actions{display:flex; gap:6px; flex-wrap:wrap;}
    @media (max-width:992px){.app{grid-template-columns:1fr;} aside{display:none;}}
  </style>
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside>
    <div class="center" style="padding:18px 0 8px;">
      <span class="title" style="font-weight:700; color:#0b3b78">Aprove</span>
    </div>

    <ul class="menu">
      <li><a href="/aprove/painel.html">Início</a></li>

      <li class="menu-group">
        <div class="group-title">Atualizações</div>
        <ul>
          <li><a href="/aprove/aprovacoes.html">Aprovações</a></li>
          <li><a href="/aprove/alunos.html">Alunos</a></li>
          <li><a href="/aprove/instituicoes.html">Instituições</a></li>
          <li><a href="/aprove/cursos.html">Cursos</a></li>
          <li><a href="/aprove/unidades.html">Unidades</a></li>
          <li><a href="/aprove/autorizacoes.html">Autorização de Imagem</a></li>
          <li><a href="/aprove/vestibulares.html">Listas de Aprovados</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Ferramentas</div>
        <ul>
          <li><a href="/aprove/conferir_listas.html">Conferir Listas</a></li>
          <li><a href="/aprove/importar_aprovacoes.html">Importar Aprovações</a></li>
        </ul>
      </li>

      <li class="menu-group">
        <div class="group-title">Relatórios</div>
        <ul>
          <li><a href="/aprove/convocacoes_geral.html">Convocados 2ª Fase</a></li>
          <li><a href="/aprove/aprovacoes_geral.html">Aprovados</a></li>
          <li><a href="/aprove/porcentagem_lista.html">Porcentagem Lista</a></li>
          <li><a href="/aprove/totais_curso.html">Totais por Curso</a></li>
          <li><a href="/aprove/totais_instituicao.html">Totais por Instituição</a></li>
          <li class="active"><a href="/aprove/publicidade.html">Autorizações • Publicidade</a></li>
        </ul>
      </li>
    </ul>
  </aside>

  <!-- MAIN -->
  <main>
    <header class="topbar">
      <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
        <div style="display:flex; align-items:center; gap:12px;">
          <img src="/aprove/logo-mini.png" alt="Logo" style="height:28px; width:auto;">
          <h5 style="margin:0; font-weight:600;">
            Aprove — Conferência de Aprovados — <span id="unitLabel">—</span>
          </h5>
        </div>
        <div><a class="btn-flat waves-effect white-text" href="#!" onclick="logout()">Sair</a></div>
      </div>
    </header>

    <section class="page">
      <h4 style="color:#0b3b78; font-weight:600; margin-bottom:6px;">
        Relatório — Autorizações com Publicidade
      </h4>
      <p class="grey-text text-darken-1" style="margin-top:0">
        Lista de autorizações marcadas com <b>publicidade=1</b> (CPF, nome, série, unidade e data de atualização).
      </p>

      <div class="card z-depth-0" style="padding:18px; margin-top:16px;">
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <span class="pill">Total: <span id="totalCount">—</span></span>

          <div class="input-field" style="margin:0; flex:1; min-width:260px;">
            <input id="q" type="text" placeholder="Buscar por CPF, nome ou unidade">
          </div>

          <button class="btn blue darken-2" id="btnReload">
            <i class="material-icons left">refresh</i>Atualizar
          </button>

          <button class="btn-flat" id="btnCsv">
            Exportar CSV
          </button>
        </div>

        <div style="margin-top:14px;">
          <table class="striped highlight responsive-table">
            <thead>
              <tr>
                <th>CPF</th>
                <th>Nome</th>
                <th>Série</th>
                <th>Unidade</th>
                <th>Atualizado</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="6" class="center grey-text">Carregando...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer>Desenvolvido por 3A Sistemas — Adilson Alves © 2025</footer>
  </main>
</div>

<!-- MODAL: aprovações do aluno -->
<div id="modal-aprov" class="modal">
  <div class="modal-content">
    <h5 style="color:#0b3b78; font-weight:600; margin-top:0;">Aprovações do Aluno</h5>
    <div class="grey-text" id="aprovSub" style="margin-bottom:10px;"></div>

    <table class="striped highlight responsive-table">
      <thead>
        <tr>
          <th>Curso</th>
          <th>Instituição</th>
          <th>Listagem</th>
          <th>Chamada</th>
          <th>Classificação</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="tbodyAprov"></tbody>
    </table>

    <div id="aprovMsg" class="center grey-text" style="margin-top:10px;"></div>
  </div>
  <div class="modal-footer">
    <a href="#!" class="modal-close btn-flat">Fechar</a>
  </div>
</div>

<script>
const API = 'https://apisec.secauxiliar.com.br/aprove/';
const LOGIN_URL = '/aprove/index.html';

// >>> AJUSTE AQUI: nome real do seu PHP (publicidade=1)
const ENDPOINT_LISTA = API + 'publicidade_list.php'; // <-- troque se preciso
const ENDPOINT_APROVACOES = API + 'aprovacoes_by_aluno.php';

const $ = s => document.querySelector(s);
const digits = v => (v||'').replace(/\D+/g,'');

function maskCPF(v){
  v = digits(v).slice(0,11);
  return v.replace(/(\d{3})(\d)/,'$1.$2')
          .replace(/(\d{3})(\d)/,'$1.$2')
          .replace(/(\d{3})(\d{1,2})$/,'$1-$2');
}
function toast(msg, cls=''){
  M.toast({html: msg, classes: cls});
}

let allRows = [];

async function logout(){
  try { await fetch(API + 'auth_login_out.php', {credentials:'include'}); } catch(_){}
  location.replace(LOGIN_URL);
}

async function carregarUsuario(){
  try{
    const r = await fetch(API+'auth_me.php', {credentials:'include'});
    const j = await r.json();
    if(j.ok && j.user){
      $('#unitLabel').textContent = `${j.user.login ?? ''} — ${j.user.nome ?? 'Usuário'}`;
      return;
    }
  }catch(_){}
  $('#unitLabel').textContent = '—';
}

async function carregar(){
  $('#tbody').innerHTML = '<tr><td colspan="6" class="center grey-text">Carregando...</td></tr>';
  $('#totalCount').textContent = '—';

  try{
    const r = await fetch(ENDPOINT_LISTA, {credentials:'include'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Falha ao carregar');

    allRows = (j.rows || []).map(x => ({
      cpf: digits(x.CPF || ''),
      // >>> se o PHP devolver CODALUNO, habilita "Ver aprovações"
      codaluno: x.CODALUNO ? String(x.CODALUNO) : '',
      nome: x.NOME || '',
      serie: (x.SERIE ?? '').toString(),
      unidade: x.UNIDADE || '',
      updated_at: x.updated_at || ''
    }));

    $('#totalCount').textContent = String(allRows.length);
    aplicarFiltro();

  }catch(e){
    $('#tbody').innerHTML = `<tr><td colspan="6" class="center red-text">Erro: ${e.message}</td></tr>`;
    $('#totalCount').textContent = '0';
  }
}

function aplicarFiltro(){
  const q = ($('#q').value || '').trim().toLowerCase();

  const rows = !q ? allRows : allRows.filter(r => {
    const hay = `${r.cpf} ${maskCPF(r.cpf)} ${r.nome} ${r.unidade}`.toLowerCase();
    return hay.includes(q);
  });

  renderTabela(rows);
}

function renderTabela(rows){
  const tb = $('#tbody');
  tb.innerHTML = '';

  if(!rows.length){
    tb.innerHTML = '<tr><td colspan="6" class="center">Nenhum registro.</td></tr>';
    return;
  }

  for(const r of rows){
    const tr = document.createElement('tr');
    const dt = r.updated_at ? String(r.updated_at).replace('T',' ').slice(0,19) : '';

    // >>> do jeito que você pediu: Aut. Imagem chama abrirAutorizacao(cpf)

    const btnAut = `
      <button class="btn-small green darken-2"
              type="button"
              data-autcpf="${r.cpf}">
        Aut. Imagem
      </button>`;

    const btnAprov = r.codaluno
      ? `<button class="btn-small green darken-2"
                 type="button"
                 data-open-aprov="${r.codaluno}"
                 data-nome="${(r.nome||'').replace(/"/g,'&quot;')}"
                 data-cpf="${r.cpf}">
           Ver aprovações
         </button>`
      : `<button class="btn-small green darken-2" type="button" disabled title="Aluno sem ID no CADALUNO">
           Ver aprovações
         </button>`;

    tr.innerHTML = `
      <td>${maskCPF(r.cpf)}</td>
      <td>${r.nome || '—'}</td>
      <td>${r.serie || '—'}</td>
      <td>${r.unidade || '—'}</td>
      <td>${dt || '—'}</td>
      <td class="actions">${btnAut}${btnAprov}</td>
    `;
    tb.appendChild(tr);
  }

  // ===== ações =====
  tb.querySelectorAll('[data-autcpf]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const cpf = b.getAttribute('data-autcpf') || '';
      abrirAutorizacao(cpf);
    });
  });

  tb.querySelectorAll('[data-open-aprov]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      const codaluno = b.getAttribute('data-open-aprov');
      const nome = b.getAttribute('data-nome') || '';
      const cpf = b.getAttribute('data-cpf') || '';
      await abrirModalAprovacoes(codaluno, nome, cpf);
    });
  });
}

async function abrirModalAprovacoes(codaluno, nome, cpf){
  const modalEl = document.getElementById('modal-aprov');
  const modal = M.Modal.getInstance(modalEl) || M.Modal.init(modalEl);

  $('#aprovSub').textContent = `CPF: ${maskCPF(cpf)} • Aluno: ${nome || '—'} • ID: ${codaluno}`;
  $('#tbodyAprov').innerHTML = '';
  $('#aprovMsg').textContent = 'Carregando...';
  modal.open();

  try{
    // seu PHP aceita id (do jeito que você mandou)
    const r = await fetch(`${ENDPOINT_APROVACOES}?id=${encodeURIComponent(codaluno)}`, {credentials:'include'});
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Falha ao listar aprovações');

    const rows = j.rows || [];
    if(!rows.length){
      $('#aprovMsg').textContent = 'Nenhuma aprovação encontrada.';
      return;
    }

    $('#aprovMsg').textContent = '';
    const tb = $('#tbodyAprov');

    rows.forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.curso || '-'}</td>
        <td>${a.instituicao || '-'}</td>
        <td>${a.listagem || '-'}</td>
        <td>${a.chamada ?? '-'}</td>
        <td>${a.colocacao ?? '-'}</td>
        <td>${a.data || '-'}</td>
      `;
      tb.appendChild(tr);
    });

  }catch(e){
    $('#aprovMsg').textContent = '';
    $('#tbodyAprov').innerHTML = `<tr><td colspan="6" class="red-text center">Erro: ${e.message}</td></tr>`;
  }
}

function exportCsv(){
  const q = ($('#q').value || '').trim().toLowerCase();
  const rows = !q ? allRows : allRows.filter(r => {
    const hay = `${r.cpf} ${maskCPF(r.cpf)} ${r.nome} ${r.unidade}`.toLowerCase();
    return hay.includes(q);
  });

  const head = ['CPF','NOME','SERIE','UNIDADE','ATUALIZADO','CODALUNO'];
  const lines = [head.join(';')];

  rows.forEach(r=>{
    const dt = r.updated_at ? String(r.updated_at).replace('T',' ').slice(0,19) : '';
    lines.push([
      maskCPF(r.cpf),
      (r.nome||'').replace(/;/g,','),
      (r.serie||'').replace(/;/g,','),
      (r.unidade||'').replace(/;/g,','),
      dt,
      r.codaluno || ''
    ].join(';'));
  });

  const blob = new Blob(["\ufeff"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'autorizacoes_publicidade.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.addEventListener('DOMContentLoaded', async ()=>{
  await carregarUsuario();
  M.Modal.init(document.querySelectorAll('.modal'));

  $('#btnReload').addEventListener('click', carregar);
  $('#btnCsv').addEventListener('click', exportCsv);

  $('#q').addEventListener('input', aplicarFiltro);
  $('#q').addEventListener('keydown', e=>{
    if(e.key === 'Enter'){ e.preventDefault(); aplicarFiltro(); }
  });

  carregar();
});

/* ======== ABRIR AUTORIZAÇÃO ========
   Abre /aprove/autorizacoes.html e injeta o CPF lá dentro,
   tentando chamar loadFilesByCPF (como você já tinha).
   Também deixa fallback via querystring (?cpf=...) se você quiser usar depois.
*/
function abrirAutorizacao(cpf){
  cpf = String(cpf || '').replace(/\D/g,'');
  if (!cpf) {
    toast('CPF do aluno não informado.', 'red');
    return;
  }

  // (fallback) se você no futuro tratar ?cpf= no autorizacoes.html
  const url = `/aprove/autorizacoes.html?cpf=${encodeURIComponent(cpf)}`;
  const w = window.open(url, '_blank');

  const timer = setInterval(() => {
    try {
      if (!w || w.closed) { clearInterval(timer); return; }
      if (!w.document || w.document.readyState !== 'complete') return;

      const cpfInput = w.document.getElementById('cpf');

      // tenta usar a função que já existe lá
      if (cpfInput && typeof w.loadFilesByCPF === 'function') {

        cpfInput.value = cpf.replace(/(\d{3})(\d)/,'$1.$2')
                            .replace(/(\d{3})(\d)/,'$1.$2')
                            .replace(/(\d{3})(\d{1,2})$/,'$1-$2');

        if (w.M && w.M.updateTextFields) w.M.updateTextFields();

        w.loadFilesByCPF(cpf);
        clearInterval(timer);
      }
    } catch (e) {
      // cross-origin / bloqueio do browser: para de tentar
      clearInterval(timer);
    }
  }, 200);
}
</script>
</body>
</html>
