<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Controle de Sala • Selecionar Sala</title>

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <!-- Ícones -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --line:#e9edf3;
      --ink:#0f172a;
      --muted:#6b7280;
      --primary:#0b3b78;
      --accent:#2563eb;
      --radius:14px;
    }

    body{
      background:var(--bg);
      font-family:system-ui, Arial;
      padding:24px;
    }

    /* ===== Topbar igual painel/login ===== */
    header.topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:var(--primary); color:#fff;
      display:flex; align-items:center; z-index:10;
      padding:0 24px;
      box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    header.topbar .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    header.topbar h5{
      margin:0; font-weight:600;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:1.1rem;
    }
    header.topbar .right-actions{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
    }
    .btn-logout{
      border-radius:999px;
      background: rgba(255,255,255,.15);
      box-shadow:none;
    }
    .btn-logout:hover{ background: rgba(255,255,255,.22); }

    /* ===== Layout ===== */
    .wrap{
      max-width:720px;
      margin:96px auto 0;
    }

    .panel-card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }

    .card-head{
      padding:18px 18px 0;
    }
    .card-head .title{
      margin:0;
      font-weight:800;
      color:#111827;
      font-size:1.25rem;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .card-head .subtitle{
      margin:6px 0 0;
      color:var(--muted);
      font-size:.95rem;
    }

    .card-body{ padding:16px 18px 18px; }

    /* Mensagem */
    #msg{ margin-top:12px; }

    /* ===== Grid de salas (quadrinhos) ===== */
    .salas-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }

    .sala-card{
      border:1px solid var(--line);
      border-radius:12px;
      background:#fff;
      padding:12px;
      cursor:pointer;
      user-select:none;
      box-shadow:0 6px 16px rgba(0,0,0,.05);
      transition: transform .08s ease, box-shadow .08s ease, border-color .08s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:64px;
    }

    .sala-card:hover{
      transform: translateY(-1px);
      border-color:#cfe0ff;
      box-shadow:0 10px 22px rgba(0,0,0,.07);
    }

    .sala-left{
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .sala-tag{
      font-size:12px;
      letter-spacing:.08em;
      font-weight:800;
      color:var(--muted);
      text-transform:uppercase;
      line-height:1.1;
    }

    .sala-nome{
      font-size:22px;
      font-weight:900;
      color:#0f172a;
      line-height:1.1;
    }

    .sala-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 260px;
    }

    .sala-right{
      flex:0 0 auto;
      width:34px;
      height:34px;
      border-radius:10px;
      background:#eaf1ff;
      color:#0b3b78;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }

    .sala-card.disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    /* mobile */
    @media (max-width: 600px){
      body{ padding:16px; }
      header.topbar{ padding:0 14px; }
      .wrap{ margin-top:86px; }
      .salas-grid{ grid-template-columns: 1fr; } /* no celular fica 1 por linha */
      .sala-sub{ max-width: 100%; }
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="brand">
      <img src="/optativos/logo-mini.png" alt="Logo" style="height:28px;">
      <h5>Curso Optativo - Controle de Salas</h5>
    </div>

    <div class="right-actions">
      <a id="logoutLink" class="btn btn-small btn-logout white-text" href="#">
        <i class="material-icons left">logout</i>Sair
      </a>
    </div>
  </header>

  <div class="wrap">

    <div class="panel-card">
      <div class="card-head">
        <div class="title">
          <i class="material-icons" style="color:var(--primary);">meeting_room</i>
          Selecionar sala
        </div>
        <p class="subtitle">Toque em uma sala para começar.</p>
      </div>

      <div class="card-body">
        <div id="salasGrid" class="salas-grid">
          <!-- cards entram aqui -->
        </div>

        <div id="msg" class="red-text"></div>
      </div>
    </div>

    <div style="text-align:center; color:var(--muted); font-size:.9rem; padding:10px 0 2px;">
      Controle de Sala • 3A Sistemas
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    const API = (location.hostname === 'apisec.secauxiliar.com.br')
      ? (location.origin + '/optativo/')
      : 'https://apisec.secauxiliar.com.br/optativo/';

    const $msg = document.getElementById('msg');
    const $grid = document.getElementById('salasGrid');
    const $logout = document.getElementById('logoutLink');

    const msg = (t='') => $msg.textContent = t;

    function goLogin(){
      const next = encodeURIComponent(location.pathname + location.search);
      location.href = `./login.html?next=${next}`;
    }

    $logout.href = API + 'logout.php';

    function setLoading(){
      $grid.innerHTML = `
        <div class="sala-card disabled">
          <div class="sala-left">
            <div class="sala-tag">Carregando</div>
            <div class="sala-nome">...</div>
            <div class="sala-sub">Aguarde</div>
          </div>
          <div class="sala-right"><i class="material-icons">hourglass_empty</i></div>
        </div>
        <div class="sala-card disabled">
          <div class="sala-left">
            <div class="sala-tag">Carregando</div>
            <div class="sala-nome">...</div>
            <div class="sala-sub">Aguarde</div>
          </div>
          <div class="sala-right"><i class="material-icons">hourglass_empty</i></div>
        </div>
      `;
    }

    function extractShortName(full){
      // tenta pegar "P1" / "P2" do nome
      // exemplos: "P1 (#1)" / "P2 MED" / "Sala P1"
      const m = String(full || '').toUpperCase().match(/\bP\d+\b/);
      return m ? m[0] : (full || 'Sala');
    }

    async function selecionarSala(sala_id){
      msg('');
      try{
        const fd = new FormData();
        fd.append('sala_id', sala_id);

        const r = await fetch(API + 'fiscal_set_sala.php', {
          method: 'POST',
          body: fd,
          credentials: 'include',
          cache: 'no-store'
        });

        if (r.status === 401) {
          msg('Sessão expirada. Faça login novamente.');
          return goLogin();
        }

        let j = null;
        try { j = await r.json(); } catch(e){}

        if (r.status === 409 && j && j.code === 'SALA_OCUPADA') {
          M.toast({html: j.msg || 'Sala ocupada por outro fiscal.'});
          msg(j.msg || 'Sala ocupada por outro fiscal.');
          return;
        }

        if (!r.ok || !j || !j.ok) {
          const detalhe = (j && (j.msg || j.error)) ? (j.msg || j.error) : '';
          msg(detalhe || `Não foi possível selecionar a sala (HTTP ${r.status})`);
          return;
        }

        location.href = './presenca.html';
      }catch(e){
        console.error(e);
        msg('Erro de rede ao selecionar a sala.');
      }
    }

    async function carregarSalas(){
      msg('');
      setLoading();

      try{
        const r = await fetch(API + 'fiscal_salas_list.php', {
          method: 'GET',
          credentials: 'include',
          cache: 'no-store'
        });

        if (r.status === 401) {
          msg('Sessão expirada. Faça login novamente.');
          return goLogin();
        }

        let j = null;
        try { j = await r.json(); } catch(e){}

        if(!r.ok){
          const detalhe = (j && (j.msg || j.error)) ? ` — ${j.msg || j.error}` : '';
          msg(`Falha ao carregar salas (HTTP ${r.status})${detalhe}`);
          $grid.innerHTML = '';
          return;
        }

        if(!j || !j.ok){
          const detalhe = j && (j.msg || j.error) ? (j.msg || j.error) : 'Resposta inválida';
          msg(`Falha ao carregar salas: ${detalhe}`);
          $grid.innerHTML = '';
          return;
        }

        const rows = Array.isArray(j.rows) ? j.rows : [];
        if(rows.length === 0){
          msg('Nenhuma sala disponível para seleção.');
          $grid.innerHTML = '';
          return;
        }

        $grid.innerHTML = rows.map(x => {
          const shortName = extractShortName(x.nome);
          const fullName = String(x.nome || '');
          return `
            <div class="sala-card" data-id="${x.id}">
              <div class="sala-left">
                <div class="sala-tag">SALA</div>
                <div class="sala-nome">${shortName}</div>
                <div class="sala-sub">${fullName}</div>
              </div>
              <div class="sala-right"><i class="material-icons">chevron_right</i></div>
            </div>
          `;
        }).join('');

        // clique nos cards
        $grid.querySelectorAll('.sala-card[data-id]').forEach(el => {
          el.addEventListener('click', () => {
            const id = el.getAttribute('data-id');
            if(!id) return;
            selecionarSala(id);
          });
        });

      }catch(e){
        console.error(e);
        msg('Erro de rede ao carregar salas.');
        $grid.innerHTML = '';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      M.AutoInit();
      carregarSalas();
    });
  </script>
</body>
</html>
