<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <title>Controle de Sala • Ensalamento</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f8fb;
      --primary:#0b3b78;
    }

    body { background:var(--bg); }

    /* ===== Topbar padrão painel ===== */
    header.topbar{
      position:fixed; top:0; left:0; right:0; height:64px;
      background:var(--primary); color:#fff;
      display:flex; align-items:center; z-index:10;
      padding:0 24px;
      box-shadow:0 2px 10px rgba(16,24,40,.12);
    }
    header.topbar .brand{
      display:flex; align-items:center; gap:12px;
      min-width:0;
    }
    header.topbar h5{
      margin:0; font-weight:600;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      font-size:1.1rem;
    }
    header.topbar .right-actions{
      margin-left:auto;
      display:flex; align-items:center; gap:10px;
    }
    .btn-logout{
      border-radius:999px;
      background: rgba(255,255,255,.15);
      box-shadow:none;
    }
    .btn-logout:hover{ background: rgba(255,255,255,.22); }

    /* ===== Layout ===== */
    .wrap { max-width: 980px; margin: 96px auto 24px; padding: 0 12px; }
    .card { border-radius: 14px; }
    .badge-soft { padding: 6px 10px; border-radius: 999px; font-weight: 600; display:inline-block; }
    .ok { background: #e8f5e9; color:#1b5e20; }
    .warn { background: #fff8e1; color:#8d6e63; }
    .bad { background: #ffebee; color:#b71c1c; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small { font-size: 0.92rem; color:#616161; }
    .muted { color:#757575; }
    .row-tight { margin-bottom: 0; }

    @media (max-width: 600px){
      header.topbar{ padding:0 14px; }
      .wrap{ margin-top: 86px; }
    }
  </style>
</head>

<body>

  <!-- ✅ Topo padrão painel -->
  <header class="topbar">
    <div class="brand">
      <img src="/optativos/logo-mini.png" alt="Logo" style="height:28px;">
      <h5>Curso Optativo - Controle de Salas</h5>
    </div>

    <div class="right-actions">
      <a class="btn btn-small btn-logout white-text" href="https://apisec.secauxiliar.com.br/optativo/logout.php">
        <i class="material-icons left">logout</i>Sair
      </a>
    </div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Ensalamento • Cadastro de Alunos na Sala</span>
        <p class="small">Selecione <b>Curso</b> e <b>Sala</b>. Depois digite a <b>matrícula</b> para validar e ensalar.</p>

        <!-- Seletores -->
        <div class="row row-tight" style="margin-top:16px;">
          <div class="input-field col s12 m6">
            <select id="curso_id"></select>
            <label>Curso</label>
          </div>

          <div class="input-field col s12 m6">
            <select id="sala_id"></select>
            <label>Sala</label>

            <!-- ✅ Resumo de lotação das salas (P1: 134/140 • P2: 128/140) -->
            <div id="salas_resumo" class="small muted" style="margin-top:6px; line-height:1.3;"></div>
          </div>
        </div>

        <div class="row row-tight">
          <div class="col s12">
            <a class="btn blue" id="btn_travar">
              Travar seleção (começar a inserir)
            </a>
            <a class="btn grey lighten-1 black-text" id="btn_destravar" style="display:none;">
              Destravar
            </a>
          </div>
        </div>

        <div class="divider" style="margin:18px 0;"></div>

        <!-- Matrícula -->
        <div id="area_matricula" style="display:none;">
          <div class="row row-tight">
            <div class="input-field col s12 m6">
              <input id="matricula" type="text" inputmode="numeric" class="mono" autocomplete="off">
              <label for="matricula">Matrícula</label>
            </div>

            <div class="col s12 m6" style="margin-top:18px;">
              <a class="btn green" id="btn_buscar">Buscar</a>
              <!-- Materialize usa a classe "disabled" para bloquear <a class="btn"> -->
              <a class="btn teal disabled" id="btn_ensalar">Ensalar</a>
            </div>
          </div>

          <!-- Resultado -->
          <div class="card" style="background:#fff; margin-top:10px;">
            <div class="card-content">
              <div class="row row-tight">
                <div class="col s12">
                  <span id="status_badge" class="badge-soft warn">Aguardando busca…</span>
                </div>
              </div>

              <div class="row row-tight" style="margin-top:12px;">
                <div class="col s12 m8">
                  <div><b>Aluno:</b> <span id="aluno_nome" class="muted">—</span></div>
                  <div><b>E-mail:</b> <span id="aluno_email" class="muted">—</span></div>
                  <div><b>CPF:</b> <span id="aluno_cpf" class="muted">—</span></div>
                </div>
                <div class="col s12 m4">
                  <div><b>Turma especial:</b> <span id="aluno_turma_esp" class="muted">—</span></div>
                  <div><b>Disciplina:</b> <span id="aluno_disc" class="muted">—</span></div>
                  <div><b>Situação:</b> <span id="aluno_sit" class="muted">—</span></div>
                </div>
              </div>

              <div class="row row-tight" style="margin-top:10px;">
                <div class="col s12">
                  <div class="small"><b>Motivo:</b> <span id="motivo" class="muted">—</span></div>
                </div>
              </div>

              <div class="row row-tight" style="margin-top:12px;">
                <div class="col s12">
                  <div class="small">
                    <b>Curso:</b> <span id="curso_nome" class="muted">—</span>
                    &nbsp;•&nbsp;
                    <b>Regra:</b> <span id="curso_regra" class="muted">—</span>
                    &nbsp;•&nbsp;
                    <b>Sala:</b> <span id="sala_nome" class="muted">—</span>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <!-- Log -->
          <div class="card" style="margin-top:12px;">
            <div class="card-content">
              <span class="card-title" style="font-size:1.1rem;">Últimos ensalados</span>
              <table class="striped responsive-table">
                <thead>
                  <tr>
                    <th>Matrícula</th>
                    <th>Nome</th>
                    <th>Status</th>
                    <th>Calendário</th>
                  </tr>
                </thead>
                <tbody id="log_body">
                  <tr><td colspan="4" class="muted">Ainda sem registros…</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
  // Ajuste o caminho base se seus PHP estiverem em outra pasta
  const API = 'https://apisec.secauxiliar.com.br/optativo/';

  const elCurso = document.getElementById('curso_id');
  const elSala  = document.getElementById('sala_id');

  const btnTravar = document.getElementById('btn_travar');
  const btnDestravar = document.getElementById('btn_destravar');
  const areaMatricula = document.getElementById('area_matricula');

  const inpMat = document.getElementById('matricula');
  const btnBuscar = document.getElementById('btn_buscar');
  const btnEnsal = document.getElementById('btn_ensalar');

  let cursoSel = null;
  let salaSel  = null;
  let lastLookup = null;

  // ✅ cache para mostrar resumo (P1: 134/140 • P2: 128/140)
  let salasCache = [];     // [{id,nome,capacidade}, ...]
  let totaisCache = {};    // { salaId: total }

  function setBadge(type, text){
    const b = document.getElementById('status_badge');
    b.className = 'badge-soft ' + (type || 'warn');
    b.textContent = text;
  }

  // ✅ Controle correto do botão <a class="btn"> no Materialize
  function setEnsalEnabled(on){
    if(on){
      btnEnsal.classList.remove('disabled');
      btnEnsal.removeAttribute('disabled');
    } else {
      btnEnsal.classList.add('disabled');
      btnEnsal.setAttribute('disabled','disabled');
    }
  }

  function fillAluno(d){
    const a = d.aluno || {};
    document.getElementById('aluno_nome').textContent = a.nome || '—';
    document.getElementById('aluno_email').textContent = a.email || '—';
    document.getElementById('aluno_cpf').textContent = a.cpf || '—';
    document.getElementById('aluno_turma_esp').textContent = a.turma_especial || '—';
    document.getElementById('aluno_disc').textContent = a.nome_disciplina || (a.cod_disciplina ? String(a.cod_disciplina) : '—');
    document.getElementById('aluno_sit').textContent = a.desc_situacao || '—';

    const c = d.curso || {};
    document.getElementById('curso_nome').textContent = c.nome || '—';
    document.getElementById('curso_regra').textContent = c.turma_especial_required ? ('Exige: ' + c.turma_especial_required) : 'Sem regra';
    document.getElementById('sala_nome').textContent = salaSel?.nome || '—';

    document.getElementById('motivo').textContent = d.motivo || '—';
  }

  function getSelectedOption(selectEl){
    const id = parseInt(selectEl.value || '0', 10);
    if(!id) return null;
    const text = selectEl.options[selectEl.selectedIndex]?.textContent || '';
    return { id, nome: text };
  }

  function resetAlunoUI(){
    lastLookup = null;
    setEnsalEnabled(false);
    setBadge('warn','Aguardando busca…');
    fillAluno({ aluno:{}, curso:{}, motivo:'—' });
  }

  function renderResumoSalas(){
    const el = document.getElementById('salas_resumo');
    if(!el) return;

    if(!salasCache.length){
      el.textContent = '';
      return;
    }

    const partes = salasCache.map(s => {
      const total = Number(totaisCache[String(s.id)] ?? totaisCache[s.id] ?? 0);
      const cap   = Number(s.capacidade ?? 0);

      return cap
        ? `<b>${s.nome}</b>: ${total}/${cap}`
        : `<b>${s.nome}</b>: ${total}`;
    });

    el.innerHTML = partes.join(' &nbsp;•&nbsp; ');
  }

  async function loadTotaisPorSala(cursoId){
    totaisCache = {};
    renderResumoSalas();

    if(!cursoId) return;

    try{
      const r = await fetch(API + 'salas_status.php?curso_id=' + encodeURIComponent(cursoId), { credentials:'include' });
      const j = await r.json();
      if(j && j.ok){
        totaisCache = j.totais || {};
      }
    }catch(e){
      console.error('Falha ao carregar salas_status', e);
    }
    renderResumoSalas();
  }

  async function loadCursos(){
    const r = await fetch(API + 'cursos_list.php', { credentials:'include' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.msg || 'Erro cursos_list');

    elCurso.innerHTML = '<option value="" disabled selected>Selecione</option>';
    j.rows.forEach(x=>{
      const op = document.createElement('option');
      op.value = x.id;
      op.textContent = x.nome;
      elCurso.appendChild(op);
    });
    M.FormSelect.init(elCurso);
  }

  // ✅ Carrega salas permitidas pelo curso (opt_curso_salas) + cache p/ resumo
  async function loadSalasDoCurso(cursoId){
    if(!cursoId){
      elSala.innerHTML = '<option value="" disabled selected>Selecione</option>';
      M.FormSelect.init(elSala);
      salasCache = [];
      totaisCache = {};
      renderResumoSalas();
      return { salas: [], auto: false };
    }

    const r = await fetch(API + 'salas_por_curso.php?curso_id=' + encodeURIComponent(cursoId), { credentials:'include' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.msg || 'Erro salas_por_curso');

    elSala.innerHTML = '<option value="" disabled selected>Selecione</option>';

    const salas = j.salas || [];
    salasCache = salas; // ✅ guarda para o resumo
    renderResumoSalas();

    salas.forEach(x=>{
      const op = document.createElement('option');
      op.value = x.id;

      // aqui mantém (cap X) no dropdown
      op.textContent = x.nome + (x.capacidade ? (' (cap ' + x.capacidade + ')') : '');
      elSala.appendChild(op);
    });

    let auto = false;
    if(salas.length === 1){
      elSala.value = String(salas[0].id);
      auto = true;
    }

    M.FormSelect.init(elSala);

    // ✅ atualiza os totais (resumo) para o curso
    await loadTotaisPorSala(cursoId);

    return { salas, auto };
  }

  // ✅ Carrega do BANCO e renderiza na tabela "Últimos ensalados"
  async function carregarUltimosEnsalados(){
    const cursoId = parseInt(elCurso.value || '0', 10) || 0;
    const salaId  = parseInt(elSala.value  || '0', 10) || 0;

    const tbody = document.getElementById('log_body');
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Carregando...</td></tr>`;

    const url = API + `opt_ensalados_list.php?curso_id=${cursoId}&sala_id=${salaId}&limit=20`;

    try{
      const r = await fetch(url, { credentials:'include' });
      const j = await r.json();

      if(!j.ok){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Erro ao carregar: ${j.msg || '---'}</td></tr>`;
        return;
      }

      if(!j.rows || j.rows.length === 0){
        tbody.innerHTML = `<tr><td colspan="4" class="muted">Ainda sem registros…</td></tr>`;
        return;
      }

      tbody.innerHTML = j.rows.map(x => {
        const statusTxt = x.email_sent ? 'Email OK' : 'Email pendente';
        const calLink = x.cal_url ? `<a href="${x.cal_url}" target="_blank">link</a>` : '—';
        return `
          <tr>
            <td class="mono">${x.matricula || '—'}</td>
            <td>${x.nome || '—'}</td>
            <td>${statusTxt}</td>
            <td>${calLink}</td>
          </tr>
        `;
      }).join('');

    } catch(e){
      console.error(e);
      tbody.innerHTML = `<tr><td colspan="4" class="muted">Falha ao carregar (console).</td></tr>`;
    }
  }

  btnTravar.addEventListener('click', async ()=>{
    const c = getSelectedOption(elCurso);
    const s = getSelectedOption(elSala);
    if(!c || !s){
      M.toast({html:'Selecione Curso e Sala antes de travar.'});
      return;
    }
    cursoSel = c;
    salaSel  = s;

    elCurso.disabled = true;
    elSala.disabled  = true;
    M.FormSelect.init(elCurso);
    M.FormSelect.init(elSala);

    btnTravar.style.display = 'none';
    btnDestravar.style.display = 'inline-block';
    areaMatricula.style.display = 'block';

    resetAlunoUI();
    inpMat.value = '';
    M.updateTextFields();
    inpMat.focus();

    await carregarUltimosEnsalados();
  });

  btnDestravar.addEventListener('click', async ()=>{
    cursoSel = null; salaSel = null;
    elCurso.disabled = false;
    elSala.disabled = false;
    M.FormSelect.init(elCurso);
    M.FormSelect.init(elSala);

    btnTravar.style.display = 'inline-block';
    btnDestravar.style.display = 'none';
    areaMatricula.style.display = 'none';
    resetAlunoUI();

    await carregarUltimosEnsalados();
  });

  async function lookup(){
    const mat = (inpMat.value || '').trim();
    if(!mat){
      M.toast({html:'Digite a matrícula.'});
      return;
    }
    if(!cursoSel){
      M.toast({html:'Trave Curso/Sala antes.'});
      return;
    }

    resetAlunoUI();
    setBadge('warn','Buscando aluno…');

    const url = API + 'aluno_lookup.php?matricula=' + encodeURIComponent(mat) + '&curso_id=' + encodeURIComponent(cursoSel.id);
    const r = await fetch(url, { credentials:'include' });
    const j = await r.json();

    if(!j.ok){
      setBadge('bad', j.msg || 'Não encontrado');
      document.getElementById('motivo').textContent = j.msg || '—';
      return;
    }

    lastLookup = j;
    fillAluno(j);

    if(j.direito_ok){
      setBadge('ok','Liberado');
      setEnsalEnabled(true);
    } else {
      setBadge('bad','Bloqueado • Sem direito');
      setEnsalEnabled(false);
    }
  }

  btnBuscar.addEventListener('click', lookup);
  inpMat.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      lookup();
    }
  });

  async function ensalar(){
    if(btnEnsal.classList.contains('disabled')) return;

    if(!cursoSel || !salaSel){
      M.toast({html:'Trave Curso/Sala antes.'});
      return;
    }
    const mat = (inpMat.value || '').trim();
    if(!mat){
      M.toast({html:'Digite a matrícula.'});
      return;
    }
    if(!lastLookup || !lastLookup.direito_ok){
      M.toast({html:'Busque e valide o aluno antes de ensalar.'});
      return;
    }

    setEnsalEnabled(false);
    setBadge('warn','Ensalando e gerando calendário…');

    const fd = new FormData();
    fd.append('curso_id', cursoSel.id);
    fd.append('sala_id', salaSel.id);
    fd.append('matricula', mat);

    const r = await fetch(API + 'ensalamento_add.php', {
      method: 'POST',
      body: fd,
      credentials: 'include'
    });

    const j = await r.json();

    if(!j.ok){
      setBadge('bad', j.msg || 'Erro ao ensalar');
      document.getElementById('motivo').textContent = (j.motivo || j.msg || '—');
      setEnsalEnabled(true);
      return;
    }

    setBadge('ok','Ensalado ✅');
    M.toast({html:'Ensalado com sucesso!'});

    await carregarUltimosEnsalados();

    // ✅ atualiza o resumo de lotação logo após ensalar
    await loadTotaisPorSala(cursoSel.id);

    inpMat.value = '';
    M.updateTextFields();
    setEnsalEnabled(false);
    lastLookup = null;
    inpMat.focus();
  }

  btnEnsal.addEventListener('click', ensalar);

  // ✅ AO SELECIONAR CURSO: carrega salas + resumo de lotação + log
  elCurso.addEventListener('change', async ()=>{
    M.FormSelect.init(elCurso);
    try{
      const cursoId = parseInt(elCurso.value || '0', 10) || 0;
      await loadSalasDoCurso(cursoId);      // popula select + cache
      await loadTotaisPorSala(cursoId);     // atualiza resumo
      await carregarUltimosEnsalados();
    }catch(e){
      console.error(e);
      M.toast({html:'Erro ao carregar salas do curso. Veja console.'});
    }
  });

  // recarrega lista ao selecionar sala
  elSala.addEventListener('change', ()=>{
    M.FormSelect.init(elSala);
    carregarUltimosEnsalados();
  });

  // boot
  (async ()=>{
    try{
      await loadCursos();
      await loadSalasDoCurso(0); // limpa salas até escolher curso
      M.FormSelect.init(document.querySelectorAll('select'));
      resetAlunoUI();
      await carregarUltimosEnsalados(); // carrega assim que entra na página
    } catch(e){
      console.error(e);
      M.toast({html:'Erro ao carregar listas (cursos/salas). Veja console.'});
    }
  })();
  </script>
</body>
</html>
