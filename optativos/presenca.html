<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PresenÃ§a â€¢ Fiscal</title>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
  <style>
    body { background:#f4f6fb; }
    .wrap { max-width: 980px; margin: 18px auto; padding: 0 12px; }
    .card { border-radius: 14px; }
    .top-info { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:600; }
    .pill-blue { background:#e3f2fd; color:#0d47a1; }
    .pill-gray { background:#eceff1; color:#263238; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .small { font-size:.92rem; color:#607d8b; }
    .row-tight { margin-bottom: 0; }
    .list-item { cursor:pointer; }
    .list-item:hover { background:#fafafa; }
    .muted { color:#78909c; }
    .stickybar {
      position: sticky; top: 0; z-index: 5;
      background: #f4f6fb; padding-top: 10px;
    }
    .searchbox { border-radius: 12px !important; background:#fff; }

    .badge-soft { padding: 4px 10px; border-radius: 999px; font-weight: 700; font-size:.85rem; display:inline-block; }
    .b-ok { background:#e8f5e9; color:#1b5e20; }
    .b-bloq { background:#fff3e0; color:#e65100; }
    .b-prev { background:#e3f2fd; color:#0d47a1; }

    html, body { overflow-x: hidden; }

    /* ===== mobile list ===== */
    .mobile-only { display:none; }
    .desktop-only { display:block; }

    @media (max-width: 600px){
      .desktop-only { display:none; }
      .mobile-only { display:block; }
    }

    .collection { border-radius: 14px; overflow:hidden; }
    .collection .collection-item { padding: 14px 14px; }

    .aluno-line {
      display:flex;
      align-items:center;
      gap:12px;
    }
    .aluno-mat {
      font-weight:800;
      font-variant-numeric: tabular-nums;
      flex:0 0 auto;
      min-width:92px;
    }
    .aluno-nome {
      flex:1 1 auto;
      min-width:0;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      line-height:1.2;
    }
    .aluno-sub {
      font-size: 12px;
      opacity: .75;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* indicador de presenÃ§a (mobile) */
    .pres-ind {
      margin-left: auto;
      flex: 0 0 auto;
      width: 24px;
      height: 24px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 12px;
      background: #e8f5e9;
      color: #1b5e20;
      border: 1px solid #c8e6c9;
    }

    .pres-row .aluno-mat,
    .pres-row .aluno-nome {
      color: #1b5e20;
    }

  </style>
</head>
<body>

  <nav class="blue darken-3">
    <div class="nav-wrapper" style="padding:0 14px;">
      <span class="brand-logo" style="font-size:1.1rem;">Controle de Sala â€¢ PresenÃ§a</span>
      <ul class="right">
        <li><a href="selecionar_sala.html">Trocar sala</a></li>
        <li><a href="logout.php">Sair</a></li>
      </ul>
    </div>
  </nav>

  <div class="wrap">

    <!-- CabeÃ§alho/Contexto -->
    <div class="card">
      <div class="card-content">
        <div class="top-info">
          <span class="pill pill-blue"><b>Data:</b> <span id="ctx_data">â€”</span></span>
          <span class="pill pill-gray"><b>Sala:</b> <span id="ctx_sala">â€”</span></span>
          <span class="pill pill-gray"><b>Fiscal:</b> <span id="ctx_fiscal">â€”</span></span>
        </div>

        <div class="row row-tight" style="margin-top:12px;">
          <div class="input-field col s12 m8">
            <select id="turmaSelect"></select>
            <label>Turma / Curso do dia</label>
          </div>

          <div class="col s12 m4" style="margin-top:18px;">
            <a class="btn blue darken-2" id="btnRecarregar" style="width:100%;">Recarregar lista</a>
          </div>
        </div>

        <div id="ctx_msg" class="small red-text" style="margin-top:8px;"></div>
      </div>
    </div>

    <!-- Lista -->
    <div class="stickybar">
      <div class="card" style="margin-top:12px;">
        <div class="card-content" style="padding-bottom:10px;">
          <div class="row row-tight" style="margin-bottom:6px;">
            <div class="col s12 m8">
              <input id="busca" class="searchbox" placeholder="Buscar por nome ou matrÃ­cula..." autocomplete="off">
            </div>
            <div class="col s12 m4 right-align" style="margin-top:8px;">
              <span class="small">Total: <b id="total">0</b></span>
            </div>
          </div>

          <!-- DESKTOP -->
          <div class="desktop-only">
            <table class="striped responsive-table">
              <thead>
                <tr>
                  <th style="width:110px;">MatrÃ­cula</th>
                  <th>Aluno</th>
                  <th style="width:160px;">SituaÃ§Ã£o</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="3" class="muted">Carregandoâ€¦</td></tr>
              </tbody>
            </table>
          </div>

          <!-- MOBILE: sÃ³ matrÃ­cula + nome (sem status) -->
          <div class="mobile-only">
            <ul id="listaMobile" class="collection">
              <li class="collection-item muted">Carregandoâ€¦</li>
            </ul>
          </div>

        </div>
      </div>
    </div>

  </div>

  <!-- Modal Confirma PresenÃ§a -->
  <div id="modalConfirm" class="modal">
    <div class="modal-content">
      <h5 style="margin-top:0;">Confirmar presenÃ§a</h5>
      <p class="small" style="margin-top:6px;">
        Aluno: <b id="m_nome">â€”</b><br>
        MatrÃ­cula: <span class="mono" id="m_mat">â€”</span><br>
        Status: <span id="m_status" class="badge-soft b-prev">Verificandoâ€¦</span>
      </p>

      <div id="m_motivo" class="small" style="margin-top:10px;"></div>
      <div id="m_msg" class="small red-text" style="margin-top:10px;"></div>
    </div>

    <div class="modal-footer">
      <a href="#!" class="modal-close btn-flat">Cancelar</a>
      <a href="#!" id="btnConfirmar" class="btn green">Confirmar</a>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const API = 'https://apisec.secauxiliar.com.br/optativo/';

    const $ctxData   = document.getElementById('ctx_data');
    const $ctxSala   = document.getElementById('ctx_sala');
    const $ctxFiscal = document.getElementById('ctx_fiscal');
    const $ctxMsg    = document.getElementById('ctx_msg');

    const $turmaSelect = document.getElementById('turmaSelect');
    const $tbody = document.getElementById('tbody');
    const $listaMobile = document.getElementById('listaMobile');
    const $total = document.getElementById('total');
    const $busca = document.getElementById('busca');

    const $mNome = document.getElementById('m_nome');
    const $mMat  = document.getElementById('m_mat');
    const $mStatus = document.getElementById('m_status');
    const $mMotivo = document.getElementById('m_motivo');
    const $mMsg = document.getElementById('m_msg');
    const $btnConfirmar = document.getElementById('btnConfirmar');

    let contexto = null;
    let alunos = [];
    let alunoSelecionado = null;

    function msgCtx(t=''){ $ctxMsg.textContent = t; }

    function reinitSelect(){
      const inst = M.FormSelect.getInstance($turmaSelect);
      if(inst) inst.destroy();
      M.FormSelect.init($turmaSelect);
    }

    function escapeHtml(s){
      return String(s ?? '').replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    // status sÃ³ no DESKTOP
    function badgeStatusDesktop(a){
      if(a.bloqueado) return `<span class="badge-soft b-bloq">BLOQUEADO</span>`;
      if(a.presenca_ok) return `<span class="badge-soft b-ok">PRESENTE</span>`;
      return `<span class="badge-soft b-prev">LIBERADO</span>`;
    }

    function filtrarRender(){
      const q = ($busca.value || '').trim().toLowerCase();

      const list = !q ? alunos : alunos.filter(a => {
        const m = (a.matricula || '').toLowerCase();
        const n = (a.nome || '').toLowerCase();
        return m.includes(q) || n.includes(q);
      });

      $total.textContent = String(list.length);

      // ===== DESKTOP =====
      if(list.length === 0){
        $tbody.innerHTML = `<tr><td colspan="3" class="muted">Nenhum aluno encontrado.</td></tr>`;
      } else {
        $tbody.innerHTML = list.map(a => {
          const statusHtml = badgeStatusDesktop(a);
          return `
            <tr class="list-item" data-mat="${escapeHtml(a.matricula)}">
              <td class="mono">${escapeHtml(a.matricula)}</td>
              <td>
                <b>${escapeHtml(a.nome || 'â€”')}</b>
                ${a.email ? `<div class="small muted">${escapeHtml(a.email)}</div>` : ``}
              </td>
              <td>
                ${statusHtml}
                ${a.bloqueado ? `<div class="small muted">Venc.: ${escapeHtml(a.vencido_desde || 'â€”')}</div>` : ``}
              </td>
            </tr>
          `;
        }).join('');
      }

      // ===== MOBILE (sÃ³ matrÃ­cula + nome; sem status) =====
      if(list.length === 0){
        $listaMobile.innerHTML = `<li class="collection-item muted">Nenhum aluno encontrado.</li>`;
      } else {
        $listaMobile.innerHTML = list.map(a => {
          const sub = a.email ? a.email : '';
          const pres = !!a.presenca_ok;

          return `
            <li class="collection-item list-item ${pres ? 'pres-row' : ''}" data-mat="${escapeHtml(a.matricula)}">
              <div class="aluno-line">
                <span class="aluno-mat mono">${escapeHtml(a.matricula)}</span>
                <span class="aluno-nome" title="${escapeHtml(a.nome || '')}">${escapeHtml(a.nome || 'â€”')}</span>
                ${pres ? `<span class="pres-ind" title="Presente">P</span>` : ``}
              </div>
              ${sub ? `<div class="aluno-sub muted">${escapeHtml(sub)}</div>` : ``}
            </li>
          `;
        }).join('');
      }
    }

    async function carregarContexto(){
      msgCtx('');
      const r = await fetch(API + 'presenca_contexto.php', { credentials:'include' });
      const j = await r.json();

      if(!r.ok || !j.ok){
        msgCtx(j.msg || 'Falha ao carregar contexto.');
        if(r.status === 409){
          setTimeout(()=> location.href='selecionar_sala.html', 600);
        }
        return null;
      }

      contexto = j;

      // âœ… data (aceita j.now.date OU j.data)
      const dataStr = (j.now && j.now.date) ? j.now.date : (j.data || 'â€”');
      $ctxData.textContent = dataStr;

      // âœ… sala
      $ctxSala.textContent = j.sala?.nome ? `${j.sala.nome} (#${j.sala.id})` : 'â€”';

      // âœ… fiscal/user
      const fiscalNome = (j.user && j.user.nome) ? j.user.nome : (j.fiscal?.nome || 'â€”');
      $ctxFiscal.textContent = fiscalNome;

      // âœ… turmas (aceita j.turmas_hoje OU j.turmas)
      const turmas = Array.isArray(j.turmas_hoje) ? j.turmas_hoje : (Array.isArray(j.turmas) ? j.turmas : []);
      if(turmas.length === 0){
        $turmaSelect.innerHTML = `<option value="" disabled selected>Nenhuma turma hoje</option>`;
        reinitSelect();
        msgCtx('Nenhuma turma encontrada para hoje nessa sala.');
        return j;
      }

      // âœ… turma default (aceita objeto OU nÃºmero)
      const defId =
        (j.turma_default && typeof j.turma_default === 'object' && j.turma_default.turma_id) ? j.turma_default.turma_id :
        (typeof j.turma_default === 'number' ? j.turma_default :
        (j.turma_default_id || turmas[0].turma_id));

      $turmaSelect.innerHTML =
        turmas.map(t => {
          const hi = String(t.hora_inicio || '').substr(0,5);
          const hf = String(t.hora_fim || '').substr(0,5);
          const label = `${t.curso_nome} â€¢ ${hi}â€“${hf} (turma ${t.turma_id})`;
          const sel = (Number(t.turma_id) === Number(defId)) ? 'selected' : '';
          return `<option value="${t.turma_id}" ${sel}>${escapeHtml(label)}</option>`;
        }).join('');

      reinitSelect();
      return j;
    }

    async function carregarAlunos(){
      msgCtx('');
      const turma_id = $turmaSelect.value;

      $tbody.innerHTML = `<tr><td colspan="3" class="muted">Carregandoâ€¦</td></tr>`;
      $listaMobile.innerHTML = `<li class="collection-item muted">Carregandoâ€¦</li>`;
      $total.textContent = '0';

      const url = API + 'presenca_alunos_list.php?turma_id=' + encodeURIComponent(turma_id || '');
      const r = await fetch(url, { credentials:'include' });
      const j = await r.json();

      if(!r.ok || !j.ok){
        msgCtx(j.msg || 'Falha ao carregar alunos');
        $tbody.innerHTML = `<tr><td colspan="3" class="muted">Erro ao carregar.</td></tr>`;
        $listaMobile.innerHTML = `<li class="collection-item muted">Erro ao carregar.</li>`;
        return;
      }

      alunos = (Array.isArray(j.rows) ? j.rows : []).map(x => {
        const st = String(x.status || '').toUpperCase();
        const presenca_ok = (st === 'PRESENTE' || st === 'OK');

        return {
          ...x,
          status: st,       // ðŸ‘ˆ recomendo
          presenca_ok
        };
      });


      filtrarRender();
    }

function abrirModalAluno(a){
  alunoSelecionado = a;
  $mMsg.textContent = '';
  $mNome.textContent = a.nome || 'â€”';
  $mMat.textContent = a.matricula || 'â€”';

  if (a.bloqueado) {
    $mStatus.className = 'badge-soft b-bloq';
    $mStatus.textContent = 'BLOQUEADO';
    $mMotivo.innerHTML =
      `<span class="red-text"><b>NÃ£o Ã© possÃ­vel registrar presenÃ§a.</b></span><br>` +
      `<span class="small">-> ${a.motivo_bloqueio || 'PendÃªncia financeira'}.</span>` +
      (a.vencido_desde ? `<div class="small muted">Venc.: ${a.vencido_desde}</div>` : '');
    $btnConfirmar.classList.add('disabled');
  } else {
    $mStatus.className = a.presenca_ok ? 'badge-soft b-ok' : 'badge-soft b-prev';
    $mStatus.textContent = a.presenca_ok ? 'PRESENTE' : 'LIBERADO';
    $mMotivo.innerHTML = `<span class="small muted">Confirme a presenÃ§a do aluno.</span>`;
    $btnConfirmar.classList.remove('disabled');
  }

  const modal = M.Modal.getInstance(document.getElementById('modalConfirm'));
  modal.open();
}


    // clique desktop
    $tbody.addEventListener('click', (e) => {
      const tr = e.target.closest('tr[data-mat]');
      if(!tr) return;

      const mat = tr.getAttribute('data-mat');
      const a = alunos.find(x => x.matricula === mat);
      if(!a) return;

      if (a.presenca_ok) {
        M.toast({ html: `âœ… PresenÃ§a jÃ¡ registrada (${a.matricula})` });
        return;
      }

      abrirModalAluno(a);
    });


    // clique mobile
    $listaMobile.addEventListener('click', (e) => {
      const li = e.target.closest('li[data-mat]');
      if(!li) return;

      const mat = li.getAttribute('data-mat');
      const a = alunos.find(x => x.matricula === mat);
      if(!a) return;

      if (a.presenca_ok) {
        M.toast({ html: `âœ… PresenÃ§a jÃ¡ registrada (${a.matricula})` });
        return;
      }

      abrirModalAluno(a);
    });


    // confirmar: aqui vocÃª liga no PHP e ele devolve OK ou motivo do bloqueio
    $btnConfirmar.addEventListener('click', async () => {
      if(!alunoSelecionado) return;
      if(alunoSelecionado.bloqueado) return;
      if($btnConfirmar.classList.contains('disabled')) return;

      $mMsg.textContent = '';
      $btnConfirmar.classList.add('disabled');

      try {
        const salaId = (contexto && contexto.sala && contexto.sala.id) ? Number(contexto.sala.id) : 0;
        const turmaId = Number($turmaSelect.value || 0);
        const mat = String(alunoSelecionado.matricula || '').trim();

        if(!salaId || !mat){
          $mStatus.className = 'badge-soft b-bloq';
          $mStatus.textContent = 'NEGADO';
          $mMsg.textContent = 'Contexto invÃ¡lido (sala_id/matrÃ­cula). Recarregue a pÃ¡gina.';
          return;
        }

        // envia como FormData (compatÃ­vel com seu PHP)
        const fd = new FormData();
        fd.append('sala_id', String(salaId));
        fd.append('turma_id', String(turmaId));
        fd.append('matricula', mat);
        
        // fd.append('data', (contexto?.now?.date || '')); // opcional
        fd.append('data', String(contexto?.data || ''));

        const r = await fetch(API + 'presenca_sala_confirmar.php', {
          method: 'POST',
          credentials: 'include',
          body: fd
        });

        const j = await r.json().catch(()=> ({}));

        if(!r.ok || !j.ok){
          // Se bloqueio financeiro (403), jÃ¡ mostra motivo.
          $mStatus.className = 'badge-soft b-bloq';
          $mStatus.textContent = 'NEGADO';
          $mMsg.textContent = j.msg || 'Falha ao registrar presenÃ§a.';
          return;
        }

        // âœ… sucesso
        alunoSelecionado.presenca_ok = true;

        $mStatus.className = 'badge-soft b-ok';
        $mStatus.textContent = 'OK';
        $mMsg.textContent = '';

        filtrarRender();
        M.toast({html: 'PresenÃ§a registrada âœ…'});

        const modal = M.Modal.getInstance(document.getElementById('modalConfirm'));
        modal.close();

      } catch (err) {
        $mStatus.className = 'badge-soft b-bloq';
        $mStatus.textContent = 'ERRO';
        $mMsg.textContent = 'Falha de rede ao registrar.';
      } finally {
        // reabilita (se ainda estiver aberto)
        $btnConfirmar.classList.remove('disabled');
      }
    });


    $turmaSelect.addEventListener('change', () => carregarAlunos());
    $busca.addEventListener('input', () => filtrarRender());
    document.getElementById('btnRecarregar').addEventListener('click', () => carregarAlunos());

    document.addEventListener('DOMContentLoaded', async () => {
      M.Modal.init(document.querySelectorAll('.modal'), { dismissible:true });
      await carregarContexto();
      await carregarAlunos();
    });
  </script>
</body>
</html>
