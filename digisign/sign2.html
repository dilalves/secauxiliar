<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Assinar documento • DigiSign</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #0b3b78;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f3f4f6 55%);
    }
    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.18);
      padding: 24px 24px 20px;
    }
    .top-logo {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .12em;
      text-transform: uppercase;
      text-align: center;
      margin-bottom: 10px;
    }
    .top-logo b {
      color: var(--primary);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
      text-align: center;
      color: var(--ink);
    }
    .sub {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 18px;
    }
    .section {
      border-top: 1px solid var(--line);
      padding-top: 14px;
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
    }
    .section h2 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--ink);
    }
    .fieldline {
      font-size: 13px;
      color: var(--muted);
      margin: 2px 0;
    }
    .fieldline span {
      color: var(--ink);
      font-weight: 500;
    }
    .docs-list {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      max-height: 180px;
      overflow: auto;
      background: #f9fafb;
      font-size: 13px;
      color: var(--ink);
    }
    .doc-item {
      padding: 4px 0;
      border-bottom: 1px dashed #e5e7eb;
    }
    .doc-item:last-child {
      border-bottom: none;
    }

    /* seção dos PDFs em tela cheia (dentro do card) */
    .pdf-section {
      margin-top: 18px;
      border-top: 1px solid var(--line);
      padding-top: 12px;
    }
    .pdf-section h2 {
      margin: 0 0 4px;
      font-size: 14px;
      color: var(--ink);
    }
    .pdf-section p {
      margin: 0 0 10px;
      font-size: 13px;
      color: var(--muted);
    }
    #pdfContainer {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .pdf-frame {
      width: 100%;
      border: 1px solid var(--line);
      border-radius: 10px;
      height: 900px; /* altura confortável para desktop */
      background: #000;
    }

    .actions {
      margin-top: 18px;
      border-top: 1px solid var(--line);
      padding-top: 14px;
    }
    .checkline {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .checkline input[type="checkbox"] {
      margin-top: 2px;
    }
    .btn-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 9px 22px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary[disabled] {
      opacity: .65;
      cursor: default;
    }
    .msg {
      font-size: 13px;
    }
    .msg.error { color: var(--danger); }
    .msg.sucesso { color: var(--success); }
    .footer {
      text-align: center;
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
    }

    /* assinatura */
    #signature-wrapper {
      margin: 10px 0 14px;
      padding: 10px 12px;
      border-radius: 10px;
      background:#f9fafb;
      border:1px solid var(--line);
    }
    #signature-wrapper p {
      margin:0 0 6px;
      font-size:12px;
      color:var(--muted);
    }
    #sigCanvas {
      width:100%;
      max-width:400px;
      height:160px;
      background:#fff;
      border:1px dashed #9ca3af;
      border-radius:6px;
      cursor:crosshair;
      display:block;
    }
    #btn-limpar-assinatura {
      margin-top:6px;
      background:none;
      border:none;
      padding:0;
      font-size:12px;
      color:#2563eb;
      cursor:pointer;
    }
    #sig-status {
      margin-left:8px;
      font-size:12px;
      color:var(--success);
      display:none;
    }

    @media (max-width: 640px) {
      .card { padding: 18px 16px 18px; }
      .section {
        grid-template-columns: 1fr;
      }
      .pdf-frame {
        height: 520px; /* menor altura no celular */
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top-logo">
      <b>DigiSign</b> • Curso Objetivo
    </div>
    <h1 id="titulo-principal">Carregando...</h1>
    <div class="sub" id="subtitulo">
      Aguarde, estamos buscando os dados do documento.
    </div>

    <div id="conteudo" style="display:none;">
      <div class="section">
        <div>
          <h2>Dados da assinatura</h2>
          <div class="fieldline">Destinatário: <span id="dest-nome">–</span></div>
          <div class="fieldline">E-mail: <span id="dest-email">–</span></div>
          <div class="fieldline">Título do documento: <span id="env-titulo">–</span></div>
          <div class="fieldline">Status atual: <span id="dest-status">–</span></div>
        </div>
        <div>
          <h2>Documento(s)</h2>
          <div class="docs-list" id="lista-docs">
            <!-- preenchido via JS -->
          </div>
        </div>
      </div>

      <!-- PDFs em tela (um embaixo do outro) -->
      <div class="pdf-section">
        <h2>Visualizar documento(s)</h2>
        <p>Os documentos anexados a este envelope são exibidos abaixo, na ordem enviada. Role a página até o final para ler tudo antes de assinar.</p>
        <div id="pdfContainer"></div>
      </div>

      <!-- área de assinatura -->
      <div class="actions" id="area-assinatura">
        <div class="checkline">
          <input type="checkbox" id="chk-concordo" />
          <label for="chk-concordo">
            Declaro que li o(s) documento(s) acima e concordo com os termos apresentados.
          </label>
        </div>

        <!-- quadro de assinatura: aparece só depois de marcar o checkbox -->
        <div id="signature-wrapper" style="display:none;">
          <p>Assine no quadro abaixo usando o mouse (computador) ou o dedo (celular).</p>
          <canvas id="sigCanvas" width="400" height="160"></canvas>
          <button type="button" id="btn-limpar-assinatura">Limpar assinatura</button>
          <span id="sig-status">Assinatura registrada ✔</span>
        </div>

        <div class="btn-row">
          <button class="btn-primary" id="btn-assinar" disabled>Assinar documento</button>
          <div class="msg" id="mensagem"></div>
        </div>
      </div>

      <div class="actions" id="area-ja-assinado" style="display:none;">
        <div class="msg sucesso">
          Este documento já foi assinado. Obrigado!
        </div>
      </div>
    </div>

    <div class="footer">
      Sistema de assinaturas DigiSign • 3A Sistemas
    </div>
  </div>
</div>

<script>
(function() {
  const token = new URLSearchParams(window.location.search).get('token');
  const tituloPrincipal = document.getElementById('titulo-principal');
  const subtitulo = document.getElementById('subtitulo');
  const conteudo = document.getElementById('conteudo');
  const listaDocs = document.getElementById('lista-docs');
  const pdfContainer = document.getElementById('pdfContainer');
  const destNome = document.getElementById('dest-nome');
  const destEmail = document.getElementById('dest-email');
  const envTitulo = document.getElementById('env-titulo');
  const destStatus = document.getElementById('dest-status');
  const chkConcordo = document.getElementById('chk-concordo');
  const btnAssinar = document.getElementById('btn-assinar');
  const msg = document.getElementById('mensagem');
  const areaAssinatura = document.getElementById('area-assinatura');
  const areaJaAssinado = document.getElementById('area-ja-assinado');
  const signatureWrapper = document.getElementById('signature-wrapper');
  const sigCanvas = document.getElementById('sigCanvas');
  const sigStatus = document.getElementById('sig-status');
  const btnLimparAss = document.getElementById('btn-limpar-assinatura');

  // ---- assinatura (canvas) ----
  let sigCtx = null;
  let desenhando = false;
  let assinaturaDataUrl = null;

  function setMensagem(texto, tipo) {
    msg.textContent = texto || '';
    msg.className = 'msg' + (tipo ? ' ' + tipo : '');
  }

  function statusLabel(code) {
    switch (code) {
      case 'pending': return 'Pendente';
      case 'sent':    return 'Enviado';
      case 'signed':  return 'Assinado';
      case 'canceled':return 'Cancelado';
      default:        return code || '—';
    }
  }

  // inicializa o canvas
  function initSignaturePad() {
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');
    sigCtx.strokeStyle = '#000';
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = 'round';
    sigCtx.lineJoin = 'round';

    const getPos = (e) => {
      const rect = sigCanvas.getBoundingClientRect();
      if (e.touches && e.touches.length) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      }
      return {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };
    };

    const startDraw = (e) => {
      e.preventDefault();
      desenhando = true;
      const p = getPos(e);
      sigCtx.beginPath();
      sigCtx.moveTo(p.x, p.y);
    };

    const moveDraw = (e) => {
      if (!desenhando) return;
      e.preventDefault();
      const p = getPos(e);
      sigCtx.lineTo(p.x, p.y);
      sigCtx.stroke();
    };

    const endDraw = (e) => {
      if (!desenhando) return;
      e.preventDefault();
      desenhando = false;
      assinaturaDataUrl = sigCanvas.toDataURL('image/png');
      sigStatus.style.display = 'inline';
      // só habilita o botão se o checkbox estiver marcado
      if (chkConcordo.checked) {
        btnAssinar.disabled = false;
      }
    };

    sigCanvas.addEventListener('mousedown', startDraw);
    sigCanvas.addEventListener('mousemove', moveDraw);
    sigCanvas.addEventListener('mouseup', endDraw);
    sigCanvas.addEventListener('mouseleave', endDraw);

    sigCanvas.addEventListener('touchstart', startDraw, { passive:false });
    sigCanvas.addEventListener('touchmove', moveDraw, { passive:false });
    sigCanvas.addEventListener('touchend', endDraw, { passive:false });

    btnLimparAss.addEventListener('click', () => {
      sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
      assinaturaDataUrl = null;
      sigStatus.style.display = 'none';
      btnAssinar.disabled = true;
    });
  }

  if (!token) {
    tituloPrincipal.textContent = 'Link inválido';
    subtitulo.textContent = 'O link de assinatura informado é inválido.';
    return;
  }

  // marcar checkbox: mostra/esconde quadro de assinatura
  chkConcordo.addEventListener('change', () => {
    if (chkConcordo.checked) {
      signatureWrapper.style.display = 'block';
      // só libera botão se já tiver rabisco
      btnAssinar.disabled = !assinaturaDataUrl;
    } else {
      signatureWrapper.style.display = 'none';
      btnAssinar.disabled = true;
      setMensagem('', '');
    }
  });

  // carregar info do token
  fetch('https://apisec.secauxiliar.com.br/digisign/sign_info.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) {
      tituloPrincipal.textContent = 'Não foi possível carregar o documento';
      subtitulo.textContent = data.error || 'Verifique com o remetente se o link ainda é válido.';
      return;
    }

    conteudo.style.display = 'block';
    tituloPrincipal.textContent = 'Assinatura de documento';
    subtitulo.textContent = 'Confira os dados abaixo antes de confirmar a assinatura.';

    const d = data.destinatario;
    const e = data.envelope;

    destNome.textContent = d.nome;
    destEmail.textContent = d.email;
    envTitulo.textContent = e.titulo;
    destStatus.textContent = statusLabel(d.status);

    const arquivos = data.arquivos || [];
    // Lista textual dos documentos
    if (arquivos.length) {
      listaDocs.innerHTML = '';
      arquivos.forEach((arq, idx) => {
        const div = document.createElement('div');
        div.className = 'doc-item';
        div.textContent = `${idx + 1}. ${arq.nome}`;
        listaDocs.appendChild(div);
      });

      // Renderiza todos os PDFs em sequência
      pdfContainer.innerHTML = '';
      arquivos.forEach((arq, idx) => {
        const frame = document.createElement('iframe');
        frame.className = 'pdf-frame';
        frame.src = arq.url + '#view=FitH';
        frame.title = 'Documento ' + (idx + 1);
        pdfContainer.appendChild(frame);
      });
    } else {
      listaDocs.innerHTML = '<div style="font-size:13px;color:#6b7280;">Nenhum arquivo encontrado.</div>';
    }

    // se já assinado, não mostra área de assinatura
    if (d.status === 'signed') {
      areaAssinatura.style.display = 'none';
      areaJaAssinado.style.display = 'block';
    } else {
      initSignaturePad();
    }
  })
  .catch(err => {
    console.error(err);
    tituloPrincipal.textContent = 'Erro ao carregar dados';
    subtitulo.textContent = 'Tente novamente em alguns instantes.';
  });

  // clicar em "Assinar documento"
  btnAssinar.addEventListener('click', () => {
    if (btnAssinar.disabled) return;

    if (!chkConcordo.checked) {
      setMensagem('Você precisa declarar que leu e concorda com o(s) documento(s).', 'error');
      return;
    }
    if (!assinaturaDataUrl) {
      setMensagem('Por favor, faça sua assinatura no quadro antes de confirmar.', 'error');
      return;
    }

    setMensagem('Registrando sua assinatura...', '');
    btnAssinar.disabled = true;

    fetch('https://apisec.secauxiliar.com.br/digisign/sign_confirm.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        token: token,
        assinatura: assinaturaDataUrl   // imagem da assinatura (PNG base64)
      })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        setMensagem(data.error || 'Não foi possível registrar a assinatura.', 'error');
        btnAssinar.disabled = false;
        return;
      }
      setMensagem('Documento assinado com sucesso. Obrigado!', 'sucesso');
      areaAssinatura.style.display = 'none';
      areaJaAssinado.style.display = 'block';
      destStatus.textContent = statusLabel('signed');
    })
    .catch(err => {
      console.error(err);
      setMensagem('Erro ao registrar assinatura. Tente novamente.', 'error');
      btnAssinar.disabled = false;
    });
  });
})();
</script>
</body>
</html>
