<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Assinar documento • DigiSign 3A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Materialize CSS -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />

  <style>
    body {
      background:#f5f5f5;
    }
    .page-wrap {
      max-width: 1024px;
      margin: 24px auto;
    }
    .pdf-frame {
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 100%;
      min-height: 600px;
      background: #fff;
    }
    #sigCanvas {
      background:#fff;
      border:1px dashed #999;
      cursor: crosshair;
      width:100%;
      max-width:400px;
      height:160px;
    }
    .rodape-sistema {
      font-size: 12px;
      color:#777;
      text-align:center;
      margin-top: 16px;
    }
  </style>
</head>
<body>

  <div class="page-wrap">
    <div class="card">
      <div class="card-content">
        <span class="card-title">Assinar documento</span>
        <p id="infoEnvelope" style="margin-bottom:12px; color:#555;">
          Carregando informações do documento...
        </p>

        <div class="row" style="margin-bottom:0;">
          <div class="col s12">
            <!-- Viewer do PDF -->
            <iframe id="pdfFrame" class="pdf-frame"
                    src=""
                    frameborder="0"></iframe>
          </div>
        </div>

        <!-- Mensagens de status -->
        <div id="mensagemStatus"
             style="margin-top:12px; font-size:0.95rem; color:#555;">
        </div>

        <!-- Quadro de assinatura + checkbox + botão -->
        <div id="areaAssinatura" style="margin-top:16px;">
          <div class="card z-depth-0">
            <div class="card-content">
              <span class="card-title" style="font-size: 1.1rem;">Assinatura</span>
              <p style="margin-bottom:8px;">
                Assine no quadro abaixo usando o mouse ou o dedo (no celular).
              </p>

              <div style="border:1px solid #ccc; border-radius:4px; padding:8px; background:#fafafa;">
                <canvas id="sigCanvas" width="400" height="160"></canvas>
              </div>

              <div style="margin-top:8px;">
                <button type="button" id="btnLimparAssinatura" class="btn-flat">
                  Limpar assinatura
                </button>
                <span id="sigStatus" style="margin-left:8px; color:#4caf50; display:none;">
                  Assinatura registrada ✔
                </span>
              </div>
            </div>
          </div>

          <p>
            <label>
              <input type="checkbox" id="chkAceito" />
              <span>Declaro que li o(s) documento(s) acima e concordo com os termos apresentados.</span>
            </label>
          </p>

          <div style="margin-top:8px;">
            <button id="btnAssinar" class="btn waves-effect waves-light" type="button">
              Assinar documento
            </button>
          </div>
        </div>

        <div class="rodape-sistema">
          Sistema de assinaturas DigiSign • 3A Sistemas
        </div>
      </div>
    </div>
  </div>

  <!-- Materialize JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <script>
    // ------------ VARIÁVEIS GLOBAIS ------------
    let assinaturaDataUrl = null;
    let sigCanvas, sigCtx;
    let desenhando = false;
    let destStatusNormalizado = null;
    let tokenGlobal = null;

    // ------------ FUNÇÕES AUXILIARES ------------

    function toast(msg) {
      if (window.M && M.toast) {
        M.toast({ html: msg });
      } else {
        alert(msg);
      }
    }

    function getTokenFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('token');
    }

    function normalizarStatus(s) {
      if (s === null || s === undefined) return 'pending';
      s = String(s).trim();
      if (s === '' || s === '0') return 'pending';
      return s;
    }

    // ------------ INICIALIZAR CANVAS ASSINATURA ------------

    function initSignaturePad() {
      sigCanvas = document.getElementById('sigCanvas');
      if (!sigCanvas) return;

      sigCtx = sigCanvas.getContext('2d');
      sigCtx.strokeStyle = '#000';
      sigCtx.lineWidth = 2;
      sigCtx.lineJoin = 'round';
      sigCtx.lineCap = 'round';

      const getPos = (e) => {
        const rect = sigCanvas.getBoundingClientRect();
        if (e.touches && e.touches.length > 0) {
          return {
            x: e.touches[0].clientX - rect.left,
            y: e.touches[0].clientY - rect.top
          };
        } else {
          return {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
          };
        }
      };

      const startDraw = (e) => {
        e.preventDefault();
        desenhando = true;
        const p = getPos(e);
        sigCtx.beginPath();
        sigCtx.moveTo(p.x, p.y);
      };

      const moveDraw = (e) => {
        if (!desenhando) return;
        e.preventDefault();
        const p = getPos(e);
        sigCtx.lineTo(p.x, p.y);
        sigCtx.stroke();
      };

      const endDraw = (e) => {
        if (!desenhando) return;
        e.preventDefault();
        desenhando = false;
        assinaturaDataUrl = sigCanvas.toDataURL('image/png');
        document.getElementById('sigStatus').style.display = 'inline';
      };

      // mouse
      sigCanvas.addEventListener('mousedown', startDraw);
      sigCanvas.addEventListener('mousemove', moveDraw);
      sigCanvas.addEventListener('mouseup', endDraw);
      sigCanvas.addEventListener('mouseleave', endDraw);

      // touch
      sigCanvas.addEventListener('touchstart', startDraw, { passive: false });
      sigCanvas.addEventListener('touchmove', moveDraw, { passive: false });
      sigCanvas.addEventListener('touchend', endDraw, { passive: false });

      // limpar
      document.getElementById('btnLimparAssinatura').addEventListener('click', () => {
        sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
        assinaturaDataUrl = null;
        document.getElementById('sigStatus').style.display = 'none';
      });
    }

    // ------------ CARREGAR INFO DO DOCUMENTO ------------

    async function carregarInfoDocumento(token) {
      const elMsg = document.getElementById('mensagemStatus');
      const elInfo = document.getElementById('infoEnvelope');
      const elAreaAss = document.getElementById('areaAssinatura');
      const elBtn = document.getElementById('btnAssinar');

      elMsg.style.color = '#555';
      elMsg.textContent = 'Carregando documento...';

      try {
        const resp = await fetch('https://apisec.secauxiliar.com.br/digisign/sign_info.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token })
        });

        const data = await resp.json();
        console.log('sign_info:', resp.status, data);

        if (!resp.ok || !data.ok) {
          throw new Error(data.error || 'Não foi possível carregar o documento.');
        }

        const dest = data.destinatario;
        const env  = data.envelope;
        const arquivos = data.arquivos || [];

        destStatusNormalizado = normalizarStatus(dest.status);

        // Info topo
        elInfo.textContent = `Envelope: ${env.titulo} • Destinatário: ${dest.nome} <${dest.email}>`;

        // Carregar PDF (usar o primeiro arquivo por enquanto)
        if (arquivos.length > 0) {
          const pdfUrl = arquivos[0].url;
          document.getElementById('pdfFrame').src = pdfUrl;
        } else {
          document.getElementById('pdfFrame').src = '';
          elMsg.textContent = 'Nenhum documento encontrado para este envelope.';
          elAreaAss.style.display = 'none';
          return;
        }

        // Lógica de status
        if (destStatusNormalizado === 'signed') {
          elMsg.style.color = '#2e7d32';
          elMsg.textContent = 'Este documento já foi assinado. Obrigado!';
          elAreaAss.style.display = 'none';
          return;
        }

        if (destStatusNormalizado === 'declined') {
          elMsg.style.color = '#c62828';
          elMsg.textContent = 'Este convite de assinatura foi recusado.';
          elAreaAss.style.display = 'none';
          return;
        }

        if (destStatusNormalizado !== 'pending' && destStatusNormalizado !== 'viewed') {
          elMsg.style.color = '#c62828';
          elMsg.textContent = 'Este convite de assinatura não está mais disponível.';
          elAreaAss.style.display = 'none';
          return;
        }

        // Se chegou aqui, pode assinar
        elMsg.style.color = '#555';
        elMsg.textContent = 'O documento selecionado será exibido acima. Role até o fim para ler tudo.';
        elAreaAss.style.display = 'block';
        elBtn.disabled = false;

      } catch (err) {
        console.error(err);
        elMsg.style.color = '#c62828';
        elMsg.textContent = err.message || 'Erro ao carregar o documento.';
        document.getElementById('areaAssinatura').style.display = 'none';
      }
    }

    // ------------ CONFIRMAR ASSINATURA ------------

    async function confirmarAssinatura(token) {
      const elMsg = document.getElementById('mensagemStatus');
      const elBtn = document.getElementById('btnAssinar');

      if (!document.getElementById('chkAceito').checked) {
        toast('Você deve marcar que leu e concorda com o(s) documento(s).');
        return;
      }

      if (!assinaturaDataUrl) {
        toast('Por favor, faça sua assinatura no quadro antes de confirmar.');
        return;
      }

      try {
        elBtn.disabled = true;
        elBtn.textContent = 'Registrando assinatura...';

        const resp = await fetch('https://apisec.secauxiliar.com.br/digisign/sign_confirm.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: token,
            assinatura: assinaturaDataUrl
          })
        });

        const data = await resp.json();
        console.log('sign_confirm:', resp.status, data);

        if (!resp.ok || !data.ok) {
          throw new Error(data.error || 'Falha ao registrar assinatura.');
        }

        elMsg.style.color = '#2e7d32';
        elMsg.textContent = 'Este documento já foi assinado. Obrigado!';
        toast('Documento assinado com sucesso!');

        // esconde área de assinatura
        document.getElementById('areaAssinatura').style.display = 'none';

      } catch (err) {
        console.error(err);
        toast(err.message || 'Erro ao registrar assinatura.');
        elMsg.style.color = '#c62828';
        elMsg.textContent = err.message || 'Erro ao registrar assinatura.';
        elBtn.disabled = false;
        elBtn.textContent = 'Assinar documento';
      }
    }

    // ------------ ON LOAD ------------

    document.addEventListener('DOMContentLoaded', () => {
      initSignaturePad();

      const token = getTokenFromUrl();
      tokenGlobal = token;

      if (!token) {
        document.getElementById('mensagemStatus').style.color = '#c62828';
        document.getElementById('mensagemStatus').textContent =
          'Token de assinatura não informado na URL.';
        document.getElementById('areaAssinatura').style.display = 'none';
        return;
      }

      carregarInfoDocumento(token);

      document.getElementById('btnAssinar').addEventListener('click', () => {
        confirmarAssinatura(tokenGlobal);
      });
    });
  </script>
</body>
</html>
