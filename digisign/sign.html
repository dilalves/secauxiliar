<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Assinar documento • DigiSign</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="https://www.curso-objetivo.br/assets/img/favicon.ico" />
  <style>
    :root {
      --bg: #f3f4f6;
      --card: #ffffff;
      --primary: #0b3b78;
      --ink: #111827;
      --muted: #6b7280;
      --line: #e5e7eb;
      --danger: #b91c1c;
      --success: #15803d;
    }
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background: radial-gradient(circle at top, #e0edff 0, #f3f4f6 55%);
    }
    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 12px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.18);
      padding: 24px 24px 20px;
    }
    .top-logo {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: .12em;
      text-transform: uppercase;
      text-align: center;
      margin-bottom: 10px;
    }
    .top-logo b {
      color: var(--primary);
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
      text-align: center;
      color: var(--ink);
    }
    .sub {
      text-align: center;
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 18px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 11px;
      font-weight: 500;
    }
    .section {
      border-top: 1px solid var(--line);
      padding-top: 14px;
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 18px;
    }
    .section h2 {
      margin: 0 0 6px;
      font-size: 14px;
      color: var(--ink);
    }
    .fieldline {
      font-size: 13px;
      color: var(--muted);
      margin: 2px 0;
    }
    .fieldline span {
      color: var(--ink);
      font-weight: 500;
    }
    .docs-list {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px 12px;
      max-height: 180px;
      overflow: auto;
      background: #f9fafb;
    }
    .doc-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px dashed #e5e7eb;
      font-size: 13px;
      color: var(--ink);
    }
    .doc-item:last-child {
      border-bottom: none;
    }
    .doc-link {
      font-size: 12px;
      color: #2563eb;
      text-decoration: none;
    }
    .doc-link:hover {
      text-decoration: underline;
    }
    .actions {
      margin-top: 18px;
      border-top: 1px solid var(--line);
      padding-top: 14px;
    }
    .checkline {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }
    .checkline input[type="checkbox"] {
      margin-top: 2px;
    }
    .btn-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 9px 22px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary[disabled] {
      opacity: .65;
      cursor: default;
    }
    .msg {
      font-size: 13px;
    }
    .msg.error { color: var(--danger); }
    .msg.sucesso { color: var(--success); }
    .footer {
      text-align: center;
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
    }
    @media (max-width: 640px) {
      .card { padding: 18px 16px 18px; }
      .section {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="top-logo">
      <b>DigiSign</b> • Curso Objetivo
    </div>
    <h1 id="titulo-principal">Carregando...</h1>
    <div class="sub" id="subtitulo">
      Aguarde, estamos buscando os dados do documento.
    </div>

    <div id="conteudo" style="display:none;">
      <div class="section">
        <div>
          <h2>Dados da assinatura</h2>
          <div class="fieldline">Destinatário: <span id="dest-nome">–</span></div>
          <div class="fieldline">E-mail: <span id="dest-email">–</span></div>
          <div class="fieldline">Título do documento: <span id="env-titulo">–</span></div>
          <div class="fieldline">Status atual: <span id="dest-status">–</span></div>
        </div>
        <div>
          <h2>Documento(s)</h2>
          <div class="docs-list" id="lista-docs">
            <!-- preenchido via JS -->
          </div>
        </div>
      </div>

      <div class="actions" id="area-assinatura">
        <div class="checkline">
          <input type="checkbox" id="chk-concordo" />
          <label for="chk-concordo">
            Declaro que li o(s) documento(s) acima e concordo com os termos apresentados.
          </label>
        </div>
        <div class="btn-row">
          <button class="btn-primary" id="btn-assinar" disabled>Assinar documento</button>
          <div class="msg" id="mensagem"></div>
        </div>
      </div>

      <div class="actions" id="area-ja-assinado" style="display:none;">
        <div class="msg sucesso">
          Este documento já foi assinado. Obrigado!
        </div>
      </div>
    </div>

    <div class="footer">
      Sistema de assinaturas DigiSign • 3A Sistemas
    </div>
  </div>
</div>

<script>
(function() {
  const token = new URLSearchParams(window.location.search).get('token');
  const tituloPrincipal = document.getElementById('titulo-principal');
  const subtitulo = document.getElementById('subtitulo');
  const conteudo = document.getElementById('conteudo');
  const listaDocs = document.getElementById('lista-docs');
  const destNome = document.getElementById('dest-nome');
  const destEmail = document.getElementById('dest-email');
  const envTitulo = document.getElementById('env-titulo');
  const destStatus = document.getElementById('dest-status');
  const chkConcordo = document.getElementById('chk-concordo');
  const btnAssinar = document.getElementById('btn-assinar');
  const msg = document.getElementById('mensagem');
  const areaAssinatura = document.getElementById('area-assinatura');
  const areaJaAssinado = document.getElementById('area-ja-assinado');

  if (!token) {
    tituloPrincipal.textContent = 'Link inválido';
    subtitulo.textContent = 'O link de assinatura informado é inválido.';
    return;
  }

  function setMensagem(texto, tipo) {
    msg.textContent = texto || '';
    msg.className = 'msg' + (tipo ? ' ' + tipo : '');
  }

  // Carrega informações do token
  fetch('https://apisec.secauxiliar.com.br/digisign/sign_info.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token })
  })
  .then(r => r.json())
  .then(data => {
    if (!data.ok) {
      tituloPrincipal.textContent = 'Não foi possível carregar o documento';
      subtitulo.textContent = data.error || 'Verifique com o remetente se o link ainda é válido.';
      return;
    }

    conteudo.style.display = 'block';
    tituloPrincipal.textContent = 'Assinatura de documento';
    subtitulo.textContent = 'Confira os dados abaixo antes de confirmar a assinatura.';

    const d = data.destinatario;
    const e = data.envelope;

    destNome.textContent = d.nome;
    destEmail.textContent = d.email;
    envTitulo.textContent = e.titulo;
    destStatus.textContent = statusLabel(d.status);

    // Documentos
    if (data.arquivos && data.arquivos.length) {
      listaDocs.innerHTML = '';
      data.arquivos.forEach((arq, idx) => {
        const div = document.createElement('div');
        div.className = 'doc-item';
        div.innerHTML = `
          <span>${idx + 1}. ${arq.nome}</span>
          <a href="${arq.url}" target="_blank" class="doc-link">Abrir PDF</a>
        `;
        listaDocs.appendChild(div);
      });
    } else {
      listaDocs.innerHTML = '<div style="font-size:13px;color:#6b7280;">Nenhum arquivo encontrado.</div>';
    }

    // Se já assinado, desabilita tudo
    if (d.status === 'signed') {
      areaAssinatura.style.display = 'none';
      areaJaAssinado.style.display = 'block';
    }
  })
  .catch(err => {
    console.error(err);
    tituloPrincipal.textContent = 'Erro ao carregar dados';
    subtitulo.textContent = 'Tente novamente em alguns instantes.';
  });

  chkConcordo.addEventListener('change', () => {
    btnAssinar.disabled = !chkConcordo.checked;
  });

  btnAssinar.addEventListener('click', () => {
    if (btnAssinar.disabled) return;
    setMensagem('Registrando sua assinatura...', '');
    btnAssinar.disabled = true;

    fetch('https://apisec.secauxiliar.com.br/digisign/sign_confirm.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token })
    })
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        setMensagem(data.error || 'Não foi possível registrar a assinatura.', 'error');
        btnAssinar.disabled = false;
        return;
      }
      setMensagem('Documento assinado com sucesso. Obrigado!', 'sucesso');
      areaAssinatura.style.display = 'none';
      areaJaAssinado.style.display = 'block';
      destStatus.textContent = statusLabel('signed');
    })
    .catch(err => {
      console.error(err);
      setMensagem('Erro ao registrar assinatura. Tente novamente.', 'error');
      btnAssinar.disabled = false;
    });
  });

  function statusLabel(code) {
    switch (code) {
      case 'pending': return 'Pendente';
      case 'sent':    return 'Enviado';
      case 'signed':  return 'Assinado';
      case 'canceled':return 'Cancelado';
      default:        return code || '—';
    }
  }
})();
</script>
</body>
</html>
